<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å²—ä½ç”»åƒ - BOSSæ‹›è˜åŠ©æ‰‹</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    
    
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <style>
        .tag-editor {
            position: relative;
        }
        .tag-input-container {
            position: relative;
        }
        .tag-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 2px;
        }
        .tag-suggestion {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #e5e7eb;
        }
        .tag-suggestion:hover {
            background-color: #f3f4f6;
        }
        .tag-suggestion:last-child {
            border-bottom: none;
        }
        .tag-item {
            display: inline-flex;
            align-items: center;
            background-color: #3b82f6;
            color: white;
            padding: 4px 8px;
            border-radius: 16px;
            font-size: 14px;
            margin: 2px;
        }
        .tag-item.negative {
            background-color: #ef4444;
        }
        .tag-remove {
            margin-left: 6px;
            cursor: pointer;
            font-weight: bold;
            opacity: 0.7;
        }
        .tag-remove:hover {
            opacity: 1;
        }
        .tag-list:empty::before {
            content: "æš‚æ— å…³é”®è¯";
            color: #9ca3af;
            font-style: italic;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col space-y-2"></div>
    
    <!-- Confirm Modal -->
    <div x-data="{ 
            get modal() { return Alpine.store('confirmModal'); }
         }" 
         x-show="modal.show"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
         style="display: none;"
         @keydown.escape.window="modal.cancel()">
        <div class="bg-white rounded-lg shadow-2xl max-w-md w-full mx-4"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform scale-95"
             x-transition:enter-end="opacity-100 transform scale-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 transform scale-100"
             x-transition:leave-end="opacity-0 transform scale-95"
             @click.away="modal.cancel()">
            <div class="p-6">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center mr-3">
                        <span class="text-2xl">âš ï¸</span>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800" x-text="modal.title"></h3>
                </div>
                <div class="mb-6">
                    <p class="text-gray-700 leading-relaxed whitespace-pre-line" x-text="modal.message"></p>
                </div>
                <div class="flex justify-end">
                    <button @click="modal.cancel()" 
                            class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-medium mr-3">
                        å–æ¶ˆ
                    </button>
                    <button @click="modal.confirm()" 
                            class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                        ç¡®å®š
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Delete Job Modal (for deleting last version) -->
    <div x-data="{ 
            get modal() { return Alpine.store('deleteJobModal'); }
         }" 
         x-show="modal.show"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
         style="display: none;"
         @keydown.escape.window="modal.cancel()">
        <div class="bg-white rounded-lg shadow-2xl max-w-md w-full mx-4"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform scale-95"
             x-transition:enter-end="opacity-100 transform scale-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 transform scale-100"
             x-transition:leave-end="opacity-0 transform scale-95"
             @click.away="modal.cancel()">
            <div class="p-6">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mr-3">
                        <span class="text-2xl">ğŸ—‘ï¸</span>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800" x-text="modal.title"></h3>
                </div>
                <div class="mb-6">
                    <p class="text-gray-700 leading-relaxed whitespace-pre-line" x-text="modal.message"></p>
                </div>
                <div class="flex justify-end">
                    <button @click="modal.cancel()" 
                            class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-medium mr-3">
                        å–æ¶ˆ
                    </button>
                    <button @click="modal.confirm()" 
                            class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-medium">
                        ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå²—ä½
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container mx-auto px-4 py-8">
        <div class="space-y-6">
            <!-- Page header -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">å²—ä½ç”»åƒ</h1>
                        <p class="text-gray-600 mt-2">ç®¡ç†æ‹›è˜å²—ä½çš„èƒŒæ™¯ã€èŒè´£ã€è¦æ±‚å’Œç†æƒ³äººé€‰ç”»åƒ</p>
                    </div>
                    <button onclick="createNewJob()"
                            class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                        â• åˆ›å»ºæ–°å²—ä½
                    </button>
                </div>
            </div>
            
            <!-- Jobs management -->
            <div class="bg-white rounded-lg shadow-lg">
                <div class="flex border-b border-gray-200">
                    <div id="job-tabs" class="flex">
                        <!-- Tabs will be generated by JavaScript -->
                    </div>
                </div>
                
                <!-- Job content -->
                <div id="job-content" class="p-6">
                    <div class="text-center text-gray-500 py-12">
                        <div>è¯·é€‰æ‹©å²—ä½...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // API Base URL - use Vercel API routes (same origin)
        const API_BASE = '/api';
        
        // Toast notification
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colors = {
                info: 'bg-blue-600',
                success: 'bg-green-600',
                error: 'bg-red-600',
                warning: 'bg-yellow-600'
            };
            toast.className = `${colors[type] || colors.info} text-white px-6 py-3 rounded-lg shadow-lg mb-2`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        window.showToast = showToast;
        
        // Confirm modal
        function showConfirm(message, title = 'ç¡®è®¤') {
            return new Promise((resolve) => {
                if (!window.Alpine) {
                    resolve(false);
                    return;
                }
                const store = Alpine.store('confirmModal');
                if (!store) {
                    Alpine.store('confirmModal', {
                        show: false,
                        message: '',
                        title: '',
                        resolve: null
                    });
                }
                const modalStore = Alpine.store('confirmModal');
                modalStore.message = message;
                modalStore.title = title;
                modalStore.resolve = resolve;
                modalStore.show = true;
            });
        }
        window.showConfirm = showConfirm;
        
        // Special confirm for deleting the last version (green cancel, red confirm)
        function showDeleteJobConfirm(message, title = 'åˆ é™¤å²—ä½') {
            return new Promise((resolve) => {
                if (!window.Alpine) {
                    resolve(false);
                    return;
                }
                const store = Alpine.store('deleteJobModal');
                if (!store) {
                    Alpine.store('deleteJobModal', {
                        show: false,
                        message: '',
                        title: '',
                        resolve: null
                    });
                }
                const modalStore = Alpine.store('deleteJobModal');
                modalStore.message = message;
                modalStore.title = title;
                modalStore.resolve = resolve;
                modalStore.show = true;
            });
        }
        window.showDeleteJobConfirm = showDeleteJobConfirm;
        
        // Initialize Alpine stores
        document.addEventListener('alpine:init', () => {
            Alpine.store('confirmModal', {
                show: false,
                message: '',
                title: 'ç¡®è®¤',
                resolve: null,
                confirm() {
                    if (this.resolve) {
                        this.resolve(true);
                        this.resolve = null;
                    }
                    this.show = false;
                },
                cancel() {
                    if (this.resolve) {
                        this.resolve(false);
                        this.resolve = null;
                    }
                    this.show = false;
                }
            });
            
            Alpine.store('deleteJobModal', {
                show: false,
                message: '',
                title: 'åˆ é™¤å²—ä½',
                resolve: null,
                confirm() {
                    if (this.resolve) {
                        this.resolve(true);
                        this.resolve = null;
                    }
                    this.show = false;
                },
                cancel() {
                    if (this.resolve) {
                        this.resolve(false);
                        this.resolve = null;
                    }
                    this.show = false;
                }
            });
        });
        
        // Job data
        let jobsData = [];
        let currentJobIndex = -1;
        
        // Load jobs data from API
        async function loadJobsData() {
            try {
                const result = await apiCall('/jobs/list');
                
                if (result.success) {
                    jobsData = result.data.sort((a, b) => {
                        const dateA = new Date(a.updated_at || a.created_at || 0);
                        const dateB = new Date(b.updated_at || b.created_at || 0);
                        return dateB - dateA;
                    });
                    renderJobTabs();
                    const urlParams = new URLSearchParams(window.location.search);
                    const tabParam = urlParams.get('tab');
                    if (tabParam) {
                        const jobIndex = jobsData.findIndex(job => {
                            const jobBaseId = job.base_job_id || getBaseJobId(job.job_id || '');
                            return jobBaseId === tabParam;
                        });
                        if (jobIndex !== -1) {
                            switchToJob(jobIndex);
                        } else {
                            switchToJob(0);
                        }
                    } else if (jobsData.length > 0) {
                        switchToJob(0);
                    } else {
                        loadNewJobForm();
                    }
                }
            } catch (error) {
                showToast('åŠ è½½å²—ä½åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadJobsData();
        });
        
        // Render job tabs
        function renderJobTabs() {
            const tabsContainer = document.getElementById('job-tabs');
            let tabsHtml = '';
            jobsData.forEach((job, index) => {
                const activeClass = index === currentJobIndex ? 'active bg-blue-50 border-blue-500 text-blue-700' : 'inactive bg-gray-50 border-gray-300 text-gray-700';
                const displayJobId = job.base_job_id || getBaseJobId(job.job_id || '');
                tabsHtml += `
                    <button class="job-tab px-4 py-2 border-b-2 ${activeClass} hover:bg-blue-50 transition-colors"
                            onclick="switchToJob(${index})">
                        ${job.position || displayJobId || 'Unknown'}
                    </button>
                `;
            });
            const newJobActiveClass = currentJobIndex === jobsData.length ? 'active bg-blue-50 border-blue-500 text-blue-700' : 'inactive bg-gray-50 border-gray-300 text-gray-700';
            tabsHtml += `
                <button class="job-tab px-4 py-2 border-b-2 ${newJobActiveClass} hover:bg-blue-50 transition-colors"
                        onclick="switchToJob(${jobsData.length})">
                    â• æ–°å¢å²—ä½
                </button>
            `;
            tabsContainer.innerHTML = tabsHtml;
        }
        
        // Switch to job
        function switchToJob(jobIndex) {
            currentJobIndex = jobIndex;
            renderJobTabs();
            const url = new URL(window.location);
            if (jobIndex < jobsData.length) {
                const job = jobsData[jobIndex];
                const baseJobId = job.base_job_id || getBaseJobId(job.job_id || '');
                url.searchParams.set('tab', baseJobId);
                loadJobForm(job);
            } else {
                url.searchParams.delete('tab');
                loadNewJobForm();
            }
            window.history.pushState({}, '', url);
        }
        
        // Helper functions
        function getBaseJobId(jobId) {
            return jobId.replace(/_v\d+$/, '');
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Extract form data to job object
        function extractJobDataFromForm() {
            const form = document.getElementById('job-form');
            if (!form) return null;
            const formData = new FormData(form);
            const jobData = Object.fromEntries(formData.entries());
            
            const ddqTextEl = document.getElementById('drill_down_questions_text');
            jobData.drill_down_questions = ddqTextEl ? ddqTextEl.value : '';
            
            const candidateFiltersEl = document.getElementById('candidate_filters_json');
            if (candidateFiltersEl && candidateFiltersEl.value.trim()) {
                if (!validateCandidateFilters()) {
                    showToast('å€™é€‰äººç­›é€‰æ¡ä»¶ JSON æ ¼å¼é”™è¯¯ï¼Œè¯·ä¿®æ­£åå†ä¿å­˜', 'error');
                    candidateFiltersEl.focus();
                    return null;
                }
                try {
                    jobData.candidate_filters = JSON.parse(candidateFiltersEl.value);
                } catch (e) {
                    showToast('å€™é€‰äººç­›é€‰æ¡ä»¶ JSON æ ¼å¼é”™è¯¯: ' + e.message, 'error');
                    candidateFiltersEl.focus();
                    return null;
                }
            } else {
                jobData.candidate_filters = null;
            }
            
            const positiveKeywords = window.tagEditors['positive_keywords'] ? Array.from(window.tagEditors['positive_keywords'].tags) : [];
            const negativeKeywords = window.tagEditors['negative_keywords'] ? Array.from(window.tagEditors['negative_keywords'].tags) : [];
            jobData.keywords = {
                positive: positiveKeywords,
                negative: negativeKeywords
            };
            
            // Get DingTalk notification config
            const dingtalkUrl = document.getElementById('dingtalk_url')?.value?.trim();
            const dingtalkSecret = document.getElementById('dingtalk_secret')?.value?.trim();
            if (dingtalkUrl && dingtalkSecret) {
                jobData.notification = {
                    url: dingtalkUrl,
                    secret: dingtalkSecret
                };
            }
            
            return jobData;
        }
        
        // API helper
        async function apiCall(endpoint, method = 'GET', body = null) {
            const options = {
                method,
                headers: { 'Content-Type': 'application/json' }
            };
            if (body) options.body = JSON.stringify(body);
            
            const response = await fetch(`${API_BASE}${endpoint}`, options);
            return await response.json();
        }
        
        // Helper function to generate job form HTML
        function generateJobFormHTML(options) {
            const {
                isNew = false,
                job = {},
                baseJobId = '',
                currentVersion = 1,
                versions = [],
                isCurrent = true,
                formAction = isNew ? 'createJob' : 'saveJob'
            } = options;
            
            const versionSelector = !isNew && versions.length > 1 ? `
                                        <select id="version-selector" onchange="switchVersion('${escapeHtml(baseJobId)}', this.value)" 
                                                class="px-3 py-1 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 bg-white">
                                            ${versions.map(v => `
                                                <option value="${v.version}" ${v.version === currentVersion ? 'selected' : ''}>
                                                    v${v.version} ${v.current ? '(å½“å‰)' : ''} - ${new Date(v.created_at).toLocaleDateString('zh-CN')}
                                                </option>
                                            `).join('')}
                                        </select>
            ` : '';
            
            const useVersionButton = !isNew && !isCurrent ? `
                                        <button type="button" onclick="useThisVersion('${escapeHtml(baseJobId)}', ${currentVersion})" 
                                                class="px-4 py-1 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-medium shadow-sm">
                                            åˆ‡æ¢è‡³è¯¥ç‰ˆæœ¬
                                        </button>
            ` : '';
            
            const versionTag = !isNew ? `
                <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded-md text-xs font-medium">
                    v${currentVersion}${isCurrent ? ' (å½“å‰ç‰ˆæœ¬)' : ' (å†å²ç‰ˆæœ¬)'}
                </span>
            ` : '';
            
            const jobIdField = isNew ? `
                <input type="text" id="job_id" name="job_id" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                       placeholder="ä¾‹å¦‚: python_developer">
            ` : `
                <input type="hidden" name="job_id" value="${escapeHtml(baseJobId)}">
                <input type="text" id="job_id" name="job_id" required readonly
                       value="${escapeHtml(baseJobId)}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-600 cursor-not-allowed">
            `;
            
            const formActions = isNew ? `
                <button type="submit" 
                        class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                    âœ¨ åˆ›å»º
                </button>
            ` : `
                <button type="submit" 
                        class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                    ğŸ’¾ ä¿å­˜
                </button>
                <button type="button" onclick="deleteJob('${escapeHtml(baseJobId)}', ${currentVersion}, ${versions.length})" 
                        class="px-6 py-3 rounded-lg font-medium bg-red-600 text-white hover:bg-red-700">
                    ğŸ—‘ï¸ åˆ é™¤å½“å‰ç‰ˆæœ¬
                </button>
            `;
            
            return `
                <div class="max-w-6xl mx-auto space-y-6">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <form id="job-form" onsubmit="${formAction}(event)">
                            ${!isNew ? `<input type="hidden" name="job_id" value="${escapeHtml(baseJobId)}">` : ''}
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <h2 class="text-xl font-semibold text-gray-800">åŸºæœ¬ä¿¡æ¯</h2>
                                        ${versionTag}
                                    </div>
                                    <div class="flex items-center gap-2">
                                        ${versionSelector}
                                        ${useVersionButton}
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="job_id" class="block text-sm font-medium text-gray-700 mb-2">å²—ä½ ID *</label>
                                        ${jobIdField}
                                    </div>
                                    <div>
                                        <label for="position" class="block text-sm font-medium text-gray-700 mb-2">å²—ä½åç§° *</label>
                                        <input type="text" id="position" name="position" required
                                               value="${escapeHtml(job.position || '')}"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-4 mt-8">
                                <h2 class="text-xl font-semibold text-gray-800">å²—ä½è¯¦æƒ…</h2>
                                <div>
                                    <label for="background" class="block text-sm font-medium text-gray-700 mb-2">å…¬å¸èƒŒæ™¯</label>
                                    <textarea id="background" name="background" rows="4"
                                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                              placeholder="æè¿°å…¬å¸èƒŒæ™¯å’Œä¸šåŠ¡...">${escapeHtml(job.background || '')}</textarea>
                                </div>
                                <div>
                                    <label for="responsibilities" class="block text-sm font-medium text-gray-700 mb-2">ä¸»è¦èŒè´£</label>
                                    <textarea id="responsibilities" name="responsibilities" rows="4"
                                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                              placeholder="æè¿°å²—ä½çš„ä¸»è¦èŒè´£...">${escapeHtml(job.responsibilities || '')}</textarea>
                                </div>
                                <div>
                                    <label for="requirements" class="block text-sm font-medium text-gray-700 mb-2">ä»»èŒè¦æ±‚</label>
                                    <textarea id="requirements" name="requirements" rows="4"
                                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                              placeholder="æè¿°ä»»èŒè¦æ±‚...">${escapeHtml(job.requirements || '')}</textarea>
                                </div>
                                <div>
                                    <label for="description" class="block text-sm font-medium text-gray-700 mb-2">å²—ä½æ¦‚è¿°</label>
                                    <textarea id="description" name="description" rows="4"
                                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                              placeholder="æè¿°å²—ä½æ¦‚è¿°...">${escapeHtml(job.description || '')}</textarea>
                                </div>
                                <div>
                                    <label for="target_profile" class="block text-sm font-medium text-gray-700 mb-2">ç†æƒ³äººé€‰</label>
                                    <textarea id="target_profile" name="target_profile" rows="4"
                                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                              placeholder="æè¿°ç†æƒ³äººé€‰ç‰¹å¾...">${escapeHtml(job.target_profile || '')}</textarea>
                                </div>
                            </div>
                            <div class="space-y-4 mt-8">
                                <h2 class="text-xl font-semibold text-gray-800">è¿½é—®é—®é¢˜</h2>
                                <p class="text-sm text-gray-500">ç”¨äºAIç”Ÿæˆå¯¹è¯æ—¶ï¼Œè¿›ä¸€æ­¥ç¡®è®¤å€™é€‰äººèƒ½åŠ›ä¸ç»å†ã€‚</p>
                                <div>
                                    <label for="drill_down_questions_text" class="block text-sm font-medium text-gray-700 mb-2">é—®é¢˜åˆ—è¡¨</label>
                                    <textarea id="drill_down_questions_text" name="drill_down_questions_text" rows="6"
                                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                              placeholder="ä¾‹å¦‚ï¼š\nè¯·è¯¦ç»†æè¿°ä½ åœ¨RLHFé¡¹ç›®ä¸­çš„å…·ä½“èŒè´£å’Œè´¡çŒ®ï¼Ÿ\nä½ å¦‚ä½•è¯„ä¼°ä¸€ä¸ªå¯¹é½ç®—æ³•çš„æœ‰æ•ˆæ€§ï¼Ÿ\nåœ¨å·¥ç¨‹å®è·µä¸­ä½ å¦‚ä½•æƒè¡¡æ¨ç†æ€§èƒ½ä¸æˆæœ¬ï¼Ÿ">${escapeHtml(job.drill_down_questions || '')}</textarea>
                                </div>
                            </div>
                            <div class="space-y-4 mt-8">
                                <h2 class="text-xl font-semibold text-gray-800">å€™é€‰äººç­›é€‰æ¡ä»¶</h2>
                                <p class="text-sm text-gray-500">ç”¨äºåœ¨æ¨èé¡µé¢ç­›é€‰å€™é€‰äººçš„æ¡ä»¶ï¼ŒJSONæ ¼å¼ã€‚</p>
                                <div>
                                    <label for="candidate_filters_json" class="block text-sm font-medium text-gray-700 mb-2">
                                        ç­›é€‰æ¡ä»¶ (JSON)
                                        <button type="button" onclick="formatCandidateFilters()" class="ml-2 px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded text-gray-600">
                                            âœ¨ æ ¼å¼åŒ–
                                        </button>
                                        <button type="button" onclick="validateCandidateFilters()" class="ml-1 px-2 py-1 text-xs bg-blue-100 hover:bg-blue-200 rounded text-blue-600">
                                            âœ“ éªŒè¯
                                        </button>
                                    </label>
                                    <textarea id="candidate_filters_json" name="candidate_filters_json" rows="8"
                                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm"
                                              placeholder='{"æ´»è·ƒåº¦": "æœ¬å‘¨æ´»è·ƒ", "é™¢æ ¡": ["985", "ç•™å­¦"], "å­¦å†": "ç¡•å£«"}'
                                              onblur="validateCandidateFilters()">${job.candidate_filters ? JSON.stringify(job.candidate_filters, null, 2) : ''}</textarea>
                                    <p id="candidate_filters_validation" class="text-xs mt-1"></p>
                                </div>
                            </div>
                            <div class="space-y-4 mt-8">
                                <h2 class="text-xl font-semibold text-gray-800">DingTalk é€šçŸ¥é…ç½®</h2>
                                <p class="text-sm text-gray-500">ä¸ºå½“å‰å²—ä½é…ç½®ç‹¬ç«‹çš„é’‰é’‰é€šçŸ¥æ¸ é“ï¼Œç•™ç©ºåˆ™ä½¿ç”¨é»˜è®¤é…ç½®</p>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="dingtalk_url" class="block text-sm font-medium text-gray-700 mb-2">Webhook URL</label>
                                        <input type="text" id="dingtalk_url" name="dingtalk_url"
                                               value="${escapeHtml(job.notification?.url || '')}"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                               placeholder="https://oapi.dingtalk.com/robot/send?access_token=...">
                                    </div>
                                    <div>
                                        <label for="dingtalk_secret" class="block text-sm font-medium text-gray-700 mb-2">Secret</label>
                                        <input type="password" id="dingtalk_secret" name="dingtalk_secret"
                                               value="${escapeHtml(job.notification?.secret || '')}"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                               placeholder="SEC...">
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-4 mt-8">
                                <h2 class="text-xl font-semibold text-gray-800">å…³é”®è¯</h2>
                                <p class="text-sm text-gray-500">ç”¨äºåŒ¹é…å€™é€‰äººçš„å…³é”®è¯ï¼Œæ­£å‘å…³é”®è¯è¡¨ç¤ºå¸Œæœ›å…·å¤‡çš„æŠ€èƒ½ï¼Œè´Ÿå‘å…³é”®è¯ä»£è¡¨æ‰£åˆ†çš„å†…å®¹ï¼Œä¾‹å¦‚åˆçº§èƒ½åŠ›ã€æ³›æ³›è€Œè°ˆã€ä¸åŒ¹é…çš„èƒ½åŠ›ç­‰</p>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">æ­£å‘å…³é”®è¯</label>
                                        <div id="positive-keywords-editor" class="tag-editor" data-field="positive_keywords">
                                            <div class="tag-input-container">
                                                <input type="text" 
                                                       class="tag-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                                       placeholder="è¾“å…¥å…³é”®è¯åå›è½¦ï¼Œæˆ–ç”¨é€—å·ã€åˆ†å·åˆ†éš”å¤šä¸ªå…³é”®è¯"
                                                       data-field="positive_keywords">
                                                <div class="tag-suggestions hidden absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-40 overflow-y-auto"></div>
                                            </div>
                                            <div class="tag-list flex flex-wrap gap-2 mt-2 min-h-[40px] p-2 border border-gray-200 rounded-md bg-gray-50"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">è´Ÿå‘å…³é”®è¯</label>
                                        <div id="negative-keywords-editor" class="tag-editor" data-field="negative_keywords">
                                            <div class="tag-input-container">
                                                <input type="text" 
                                                       class="tag-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                                       placeholder="è¾“å…¥å…³é”®è¯åå›è½¦ï¼Œæˆ–ç”¨é€—å·ã€åˆ†å·åˆ†éš”å¤šä¸ªå…³é”®è¯"
                                                       data-field="negative_keywords">
                                                <div class="tag-suggestions hidden absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-40 overflow-y-auto"></div>
                                            </div>
                                            <div class="tag-list flex flex-wrap gap-2 mt-2 min-h-[40px] p-2 border border-gray-200 rounded-md bg-gray-50"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-4 mt-8 pt-6 border-t">
                                ${formActions}
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }
        
        // Load job form
        async function loadJobForm(job) {
            const baseJobId = getBaseJobId(job.job_id || job.base_job_id || '');
            const currentVersion = job.version || 1;
            const isCurrent = job.current !== false;
            let versions = [];
            try {
                const result = await apiCall(`/jobs/${baseJobId}/versions`);
                if (result.success) {
                    versions = result.data;
                }
            } catch (error) {
                console.error('Failed to load versions:', error);
            }
            
            // Generate form HTML using helper function
            const content = document.getElementById('job-content');
            content.innerHTML = generateJobFormHTML({
                isNew: false,
                job: job,
                baseJobId: baseJobId,
                currentVersion: currentVersion,
                versions: versions,
                isCurrent: isCurrent
            });
            
            setTimeout(() => {
                initializeTagEditors();
                const setTagsWhenReady = () => {
                    if (job.keywords && job.keywords.positive) {
                        const positiveEditor = window.tagEditors['positive_keywords'];
                        if (positiveEditor && typeof positiveEditor.setTags === 'function') {
                            positiveEditor.setTags(job.keywords.positive);
                        } else {
                            setTimeout(setTagsWhenReady, 50);
                        }
                    }
                    if (job.keywords && job.keywords.negative) {
                        const negativeEditor = window.tagEditors['negative_keywords'];
                        if (negativeEditor && typeof negativeEditor.setTags === 'function') {
                            negativeEditor.setTags(job.keywords.negative);
                        } else {
                            setTimeout(setTagsWhenReady, 50);
                        }
                    }
                };
                setTagsWhenReady();
            }, 200);
        }
        
        // Load new job form
        async function loadNewJobForm() {
            // Generate form HTML using helper function
            const content = document.getElementById('job-content');
            content.innerHTML = generateJobFormHTML({
                isNew: true,
                job: {}
            });
            
            setTimeout(() => {
                initializeTagEditors();
            }, 200);
        }
        
        // Initialize tag editors
        function initializeTagEditors() {
            if (!window.tagEditors) {
                window.tagEditors = {};
            }
            document.querySelectorAll('.tag-editor').forEach(container => {
                const fieldName = container.dataset.field;
                if (!fieldName) return;
                window.tagEditors[fieldName] = new TagEditor(container);
            });
        }
        
        // TagEditor class
        class TagEditor {
            constructor(container) {
                this.container = container;
                this.fieldName = container.dataset.field;
                this.input = container.querySelector('.tag-input');
                this.tagList = container.querySelector('.tag-list');
                this.suggestions = container.querySelector('.tag-suggestions');
                this.tags = new Set();
                this.init();
            }
            init() {
                this.input.addEventListener('keydown', (e) => this.handleKeydown(e));
                this.input.addEventListener('input', (e) => this.handleInput(e));
                this.input.addEventListener('blur', () => this.hideSuggestions());
            }
            handleKeydown(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.addCurrentTag();
                } else if (e.key === 'Backspace' && this.input.value === '') {
                    this.removeLastTag();
                } else if (e.key === ',' || e.key === ';') {
                    e.preventDefault();
                    this.addCurrentTag();
                }
            }
            handleInput(e) {
                const value = e.target.value.trim();
                if (value) {
                    this.showSuggestions(value);
                } else {
                    this.hideSuggestions();
                }
            }
            addCurrentTag() {
                const value = this.input.value.trim();
                if (value) {
                    const tags = value.split(/[,;]/).map(tag => tag.trim()).filter(tag => tag);
                    tags.forEach(tag => {
                        if (!this.tags.has(tag)) {
                            this.addTag(tag);
                        }
                    });
                    this.input.value = '';
                }
                this.hideSuggestions();
            }
            addTag(tag) {
                this.tags.add(tag);
                this.renderTags();
                this.updateHiddenInputs();
            }
            removeTag(tag) {
                this.tags.delete(tag);
                this.renderTags();
                this.updateHiddenInputs();
            }
            removeLastTag() {
                if (this.tags.size > 0) {
                    const lastTag = Array.from(this.tags).pop();
                    this.removeTag(lastTag);
                }
            }
            renderTags() {
                this.tagList.innerHTML = '';
                if (this.tags.size === 0) return;
                Array.from(this.tags).forEach(tag => {
                    const tagElement = document.createElement('div');
                    tagElement.className = `tag-item ${this.fieldName.includes('negative') ? 'negative' : ''}`;
                    tagElement.innerHTML = `
                        <span>${tag}</span>
                        <span class="tag-remove" onclick="this.parentElement.remove(); window.tagEditors['${this.fieldName}'].removeTag('${tag.replace(/'/g, "\\'")}')">Ã—</span>
                    `;
                    this.tagList.appendChild(tagElement);
                });
            }
            updateHiddenInputs() {
                const existingInputs = document.querySelectorAll(`input[name="${this.fieldName}[]"]`);
                existingInputs.forEach(input => input.remove());
                Array.from(this.tags).forEach(tag => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = `${this.fieldName}[]`;
                    input.value = tag;
                    this.container.appendChild(input);
                });
            }
            showSuggestions(value) {
                const suggestions = this.getSuggestions(value);
                if (suggestions.length > 0) {
                    this.suggestions.innerHTML = suggestions.map(suggestion => 
                        `<div class="tag-suggestion" onclick="window.tagEditors['${this.fieldName}'].selectSuggestion('${suggestion.replace(/'/g, "\\'")}')">${suggestion}</div>`
                    ).join('');
                    this.suggestions.classList.remove('hidden');
                } else {
                    this.hideSuggestions();
                }
            }
            getSuggestions(value) {
                const commonKeywords = [
                    'Python', 'Java', 'JavaScript', 'React', 'Vue', 'Node.js',
                    'æœºå™¨å­¦ä¹ ', 'æ·±åº¦å­¦ä¹ ', 'AI', 'ç®—æ³•', 'æ•°æ®ç»“æ„',
                    'å¾®æœåŠ¡', 'åˆ†å¸ƒå¼', 'é«˜å¹¶å‘', 'é«˜å¯ç”¨', 'äº‘åŸç”Ÿ'
                ];
                return commonKeywords.filter(keyword => 
                    keyword.toLowerCase().includes(value.toLowerCase()) && 
                    !this.tags.has(keyword)
                ).slice(0, 5);
            }
            selectSuggestion(suggestion) {
                this.addTag(suggestion);
                this.input.value = '';
                this.hideSuggestions();
            }
            hideSuggestions() {
                this.suggestions.classList.add('hidden');
            }
            setTags(tags) {
                this.tags.clear();
                tags.forEach(tag => this.addTag(tag));
            }
        }
        
        // Save or create job (unified function)
        async function saveJob(event) {
            event.preventDefault();
            const jobData = extractJobDataFromForm();
            if (!jobData) return;
            
            const isNewJob = currentJobIndex === -1 || currentJobIndex >= jobsData.length;
            const baseJobId = getBaseJobId(jobData.job_id || '');
            const endpoint = isNewJob ? `/jobs/create` : `/jobs/${baseJobId}/update`;
            
            try {
                const result = await apiCall(endpoint, 'POST', jobData);
                if (result.success) {
                    showToast(isNewJob ? 'å²—ä½å·²åˆ›å»º' : 'å²—ä½å·²ä¿å­˜', 'success');
                    await loadJobsData();
                    
                    if (isNewJob) {
                        const jobIndex = jobsData.findIndex(j => {
                            const jBaseId = j.base_job_id || getBaseJobId(j.job_id || '');
                            return jBaseId === baseJobId;
                        });
                        if (jobIndex !== -1) {
                            switchToJob(jobIndex);
                        } else if (jobsData.length > 0) {
                            switchToJob(jobsData.length - 1);
                        }
                    }
                } else {
                    showToast((isNewJob ? 'åˆ›å»º' : 'ä¿å­˜') + 'å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                showToast((isNewJob ? 'åˆ›å»º' : 'ä¿å­˜') + 'å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // Alias for createJob (for backward compatibility with form onsubmit)
        async function createJob(event) {
            return saveJob(event);
        }
        
        // Delete job version
        async function deleteJob(job_id, version, totalVersions) {
            const baseJobId = getBaseJobId(job_id);
            
            // Special handling when only 1 version left
            if (totalVersions <= 1) {
                const confirmed = await showDeleteJobConfirm(`ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå²—ä½å—ï¼Ÿ\nåˆ é™¤åå°†æ— æ³•æ¢å¤ï¼`, 'åˆ é™¤å²—ä½');
                if (!confirmed) return;
            } else {
                const confirmed = await showConfirm(`æ‚¨ç¡®å®šè¦åˆ é™¤ç‰ˆæœ¬ v${version} å—ï¼Ÿ\næ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼`, 'åˆ é™¤ç‰ˆæœ¬');
                if (!confirmed) return;
            }
            
            try {
                const result = await apiCall(`/jobs/${baseJobId}/delete`, 'DELETE', { version });
                if (result.success) {
                    if (totalVersions <= 1) {
                        showToast('å²—ä½å·²åˆ é™¤', 'success');
                    } else {
                        showToast(`ç‰ˆæœ¬ v${version} å·²åˆ é™¤`, 'success');
                    }
                    await loadJobsData();
                    const jobIndex = jobsData.findIndex(j => getBaseJobId(j.job_id || j.base_job_id || '') === baseJobId);
                    if (jobIndex !== -1) {
                        switchToJob(jobIndex);
                    } else if (jobsData.length > 0) {
                        switchToJob(0);
                    } else {
                        loadNewJobForm();
                    }
                } else {
                    showToast('åˆ é™¤å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // Create new job (simple wrapper)
        function createNewJob() {
            switchToJob(jobsData.length);
        }
        
        // Switch to view a different version
        async function switchVersion(baseJobId, version) {
            const versionNum = parseInt(version);
            if (isNaN(versionNum)) return;
            
            try {
                // Fetch the full job data for the specific version
                const versionedJobId = `${baseJobId}_v${versionNum}`;
                const result = await apiCall(`/jobs/${versionedJobId}`);
                if (result.success && result.data) {
                    loadJobForm(result.data);
                } else {
                    showToast('ç‰ˆæœ¬æ•°æ®åŠ è½½å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('åˆ‡æ¢ç‰ˆæœ¬å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // Set a version as current
        async function useThisVersion(baseJobId, version) {
            const versionNum = parseInt(version);
            if (isNaN(versionNum)) {
                showToast('æ— æ•ˆçš„ç‰ˆæœ¬å·', 'error');
                return;
            }
            const confirmed = await showConfirm(`ç¡®å®šè¦å°†ç‰ˆæœ¬ v${versionNum} è®¾ä¸ºå½“å‰ç‰ˆæœ¬å—ï¼Ÿ`, 'åˆ‡æ¢å½“å‰ç‰ˆæœ¬');
            if (!confirmed) return;
            
            try {
                const result = await apiCall(`/jobs/${baseJobId}/switch-version`, 'POST', { version: versionNum });
                if (result.success) {
                    showToast('ç‰ˆæœ¬åˆ‡æ¢æˆåŠŸ', 'success');
                    await loadJobsData();
                    const jobIndex = jobsData.findIndex(j => getBaseJobId(j.job_id || j.base_job_id || '') === baseJobId);
                    if (jobIndex !== -1) {
                        switchToJob(jobIndex);
                    }
                } else {
                    showToast('åˆ‡æ¢ç‰ˆæœ¬å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                showToast('åˆ‡æ¢ç‰ˆæœ¬å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // Validate and format candidate filters JSON
        function validateCandidateFilters() {
            const el = document.getElementById('candidate_filters_json');
            const validationEl = document.getElementById('candidate_filters_validation');
            if (!el) return true;
            if (!validationEl) return true;
            
            const value = el.value.trim();
            if (!value) {
                validationEl.textContent = '';
                el.classList.remove('border-red-500', 'border-green-500');
                el.classList.add('border-gray-300');
                return true;
            }
            
            try {
                JSON.parse(value);
                validationEl.textContent = 'âœ“ JSON æ ¼å¼æ­£ç¡®';
                validationEl.className = 'text-xs mt-1 text-green-600';
                el.classList.remove('border-red-500');
                el.classList.add('border-gray-300');
                return true;
            } catch (e) {
                validationEl.textContent = 'âœ— JSON æ ¼å¼é”™è¯¯: ' + e.message;
                validationEl.className = 'text-xs mt-1 text-red-600';
                el.classList.remove('border-gray-300', 'border-green-500');
                el.classList.add('border-red-500');
                return false;
            }
        }
        
        // Format candidate filters (validates and formats)
        function formatCandidateFilters() {
            const el = document.getElementById('candidate_filters_json');
            if (!el) return;
            const value = el.value.trim();
            if (!value) {
                el.value = '';
                const validationEl = document.getElementById('candidate_filters_validation');
                if (validationEl) validationEl.textContent = '';
                return;
            }
            try {
                const parsed = JSON.parse(value);
                el.value = JSON.stringify(parsed, null, 2);
                validateCandidateFilters(); // Update validation display
            } catch (e) {
                validateCandidateFilters(); // Show error
            }
        }
    </script>
</body>
</html>

