<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼˜åŒ–å²—ä½è‚–åƒ - BOSSæ‹›è˜åŠ©æ‰‹</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <a href="/" class="text-2xl font-bold text-blue-600">ğŸ¤– BOSSæ‹›è˜åŠ©æ‰‹</a>
                </div>
                <div class="flex space-x-6">
                    <a href="/" class="text-gray-700 hover:text-blue-600 transition">é¦–é¡µ</a>
                    <a href="/jobs" class="text-gray-700 hover:text-blue-600 transition">å²—ä½ç”»åƒ</a>
                    <span class="text-gray-500">ä¼˜åŒ–</span>
                </div>
            </div>
        </div>
    </nav>

    <div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col space-y-2"></div>

    <div class="container mx-auto p-4">
        <div class="space-y-6">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">å²—ä½ç”»åƒä¼˜åŒ–</h1>
                        <p class="text-gray-600 mt-2">
                            å²—ä½ï¼š<span class="font-medium text-gray-800" id="job-position">åŠ è½½ä¸­...</span>
                            <span class="text-gray-400" id="job-base-id"></span>
                        </p>
                    </div>
                    <div class="flex gap-2">
                        <a id="back-to-jobs" href="/jobs"
                           class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                            â† è¿”å›å²—ä½é¡µ
                        </a>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-12 gap-4">
                <div class="col-span-4 space-y-3">
                    <div class="bg-white rounded-lg border shadow-sm p-4">
                        <div class="flex items-center justify-between">
                            <h2 class="text-lg font-semibold text-gray-800">
                                ä¼˜åŒ–æ¸…å•
                                <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-gray-100 text-gray-700"
                                      id="opt-feedback-count">0</span>
                            </h2>
                            <button onclick="refreshOptimizationList()"
                                    class="px-3 py-1 text-xs bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition">
                                åˆ·æ–°
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">
                            é€‰æ‹©â€œæœ‰é—®é¢˜â€çš„å€™é€‰äººåé¦ˆï¼ˆå¯å¤šé€‰ï¼‰ï¼Œå†ç”Ÿæˆæ–°ç‰ˆå²—ä½è‚–åƒã€‚
                        </p>
                    </div>

                    <div id="opt-feedback-list" class="space-y-2"></div>

                    <div class="bg-white rounded-lg border shadow-sm p-4 space-y-2">
                        <button onclick="goToGeneratePage()"
                                class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                            ç”Ÿæˆæ–°ç‰ˆå²—ä½è‚–åƒï¼ˆGPT-5.2ï¼‰
                        </button>
                        <p class="text-xs text-gray-500">
                            ç”Ÿæˆåå¯é€å­—æ®µå¯¹æ¯”ä¸ç¼–è¾‘ï¼Œç¡®è®¤æäº¤åä¼šå‘å¸ƒæ–°ç‰ˆæœ¬å¹¶è‡ªåŠ¨å…³é—­æœ¬æ¬¡é€‰ä¸­çš„åé¦ˆã€‚
                        </p>
                    </div>
                </div>

                <div class="col-span-8 space-y-4">
                    <div class="bg-white rounded-lg border shadow-sm">
                        <div class="flex items-center justify-between border-b bg-gray-100 p-2">
                            <h3 class="font-bold text-gray-800">ä¼˜åŒ–å»ºè®®ï¼ˆå¯ç¼–è¾‘ï¼‰</h3>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-gray-500" id="opt-active-updated-at"></span>
                                <button onclick="saveOptimizationItem()"
                                        class="px-3 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700 transition">
                                    ä¿å­˜
                                </button>
                            </div>
                        </div>
                        <div class="p-4 space-y-4">
                            <div class="grid grid-cols-4 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ç›®æ ‡ overall *</label>
                                    <input id="opt-edit-overall" type="number" min="1" max="10"
                                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                           placeholder="ä¸å˜">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ç›®æ ‡ skill *</label>
                                    <input id="opt-edit-skill" type="number" min="1" max="10"
                                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                           placeholder="ä¸å˜">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ç›®æ ‡ background *</label>
                                    <input id="opt-edit-background" type="number" min="1" max="10"
                                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                           placeholder="ä¸å˜">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ç›®æ ‡ startup_fit *</label>
                                    <input id="opt-edit-startup-fit" type="number" min="1" max="10"
                                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                           placeholder="ä¸å˜">
                                </div>
                            </div>
                            <div class="text-xs text-gray-500" id="opt-original-scores">å½“å‰åˆ†æ•°ï¼š-</div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">å»ºè®®ä¸ç†ç”± *</label>
                                <textarea id="opt-edit-suggestion"
                                          rows="5"
                                          class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                          placeholder="å†™æ¸…æ¥šï¼šå“ªé‡Œä¸å‡†â†’åŸå› â†’å¸Œæœ›å¦‚ä½•è°ƒæ•´è¯„åˆ†æ ‡å‡†/çº¢æ——/é—®æ³•ï¼ˆä¸è¦è®©AIçº¦é¢è¯•/èŠè–ªèµ„ï¼‰"></textarea>
                            </div>
                            <input type="hidden" id="opt-active-item-id" value="">
                        </div>
                    </div>

                    <div class="bg-white rounded-lg border shadow-sm">
                        <div class="flex items-center justify-between border-b bg-gray-100 p-2">
                            <h3 class="font-bold text-gray-800">å€™é€‰äººä¿¡æ¯ï¼ˆåªè¯»ï¼‰</h3>
                            <div class="text-xs text-gray-500">ä½¿ç”¨å€™é€‰äººè¯¦æƒ…é¡µ</div>
                        </div>
                        <div class="p-0">
                            <iframe id="candidate-iframe"
                                    class="w-full h-[780px] border-0"
                                    src="about:blank"></iframe>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let BASE_JOB_ID = '';
        let ITEMS = [];
        let __opt_dirty = false;

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colors = {
                info: 'bg-blue-600',
                success: 'bg-green-600',
                error: 'bg-red-600',
                warning: 'bg-yellow-600'
            };
            toast.className = `${colors[type] || colors.info} text-white px-6 py-3 rounded-lg shadow-lg mb-2`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function _clampScore(v) {
            if (v === undefined || v === null || v === '') return null;
            const n = parseInt(v, 10);
            if (Number.isNaN(n)) return null;
            return Math.max(1, Math.min(10, n));
        }

        function _getSelectedItemIds() {
            return Array.from(document.querySelectorAll('.opt-item-checkbox:checked')).map(el => el.value);
        }

        function _qs(name) {
            return new URL(window.location.href).searchParams.get(name) || '';
        }

        async function apiCall(endpoint, method = 'GET', body = null) {
            const options = { method, headers: { 'Content-Type': 'application/json' } };
            if (body) options.body = JSON.stringify(body);
            const resp = await fetch(`${API_BASE}${endpoint}`, options);
            const data = await resp.json();
            if (!data || data.success === false) {
                throw new Error(data?.error || 'request failed');
            }
            return data;
        }

        async function initPage() {
            BASE_JOB_ID = (_qs('job_id') || '').trim();
            if (!BASE_JOB_ID) {
                showToast('ç¼ºå°‘ job_id å‚æ•°', 'error');
                document.getElementById('job-position').textContent = 'ç¼ºå°‘ job_id';
                return;
            }
            document.getElementById('job-base-id').textContent = `(${BASE_JOB_ID})`;
            document.getElementById('back-to-jobs').href = `/jobs?tab=${encodeURIComponent(BASE_JOB_ID)}`;

            try {
                const jobResp = await apiCall(`/jobs/${encodeURIComponent(BASE_JOB_ID)}`);
                const job = jobResp.data || {};
                document.getElementById('job-position').textContent = job.position || BASE_JOB_ID;
            } catch (e) {
                document.getElementById('job-position').textContent = BASE_JOB_ID;
            }

            await refreshOptimizationList();

            // Dirty tracking
            ['opt-edit-overall','opt-edit-skill','opt-edit-background','opt-edit-startup-fit','opt-edit-suggestion'].forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                el.addEventListener('input', () => { __opt_dirty = true; });
            });

            window.addEventListener('beforeunload', (e) => {
                if (!__opt_dirty) return;
                e.preventDefault();
                e.returnValue = '';
            });
        }

        async function refreshOptimizationList() {
            const listEl = document.getElementById('opt-feedback-list');
            listEl.innerHTML = '<div class="bg-white rounded-lg border shadow-sm p-6 text-center text-gray-500">åŠ è½½ä¸­...</div>';
            try {
                const resp = await apiCall(`/jobs/optimizations/list?job_id=${encodeURIComponent(BASE_JOB_ID)}`);
                ITEMS = resp.data || [];
                document.getElementById('opt-feedback-count').textContent = String(ITEMS.length);
                if (!ITEMS.length) {
                    listEl.innerHTML = '<div class="bg-white rounded-lg border shadow-sm p-6 text-center text-gray-500">æš‚æ— ä¼˜åŒ–æ¸…å•ã€‚è¯·å…ˆæ‰“å¼€å€™é€‰äººè¯¦æƒ…é¡µï¼Œç‚¹å‡»â€œè¯„åˆ†ä¸å‡†â€æ·»åŠ åé¦ˆã€‚</div>';
                    return;
                }

                listEl.innerHTML = ITEMS.map(it => {
                    const ts = it.target_scores || {};
                    const updatedAt = it.updated_at ? ` Â· ${it.updated_at}` : '';
                    const jobApplied = it.job_applied || '';
                    const name = it.candidate_name || 'æœªå‘½å';
                    const suggestion = (it.suggestion || '').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                    return `
                        <div class="bg-white rounded-lg border shadow-sm p-3 hover:border-blue-300 transition cursor-pointer"
                             data-item-id="${it.id}"
                             onclick="selectOptimizationItem('${it.id}')">
                            <div class="flex items-start justify-between gap-2">
                                <label class="flex items-start gap-2 cursor-pointer" onclick="event.stopPropagation()">
                                    <input type="checkbox" class="opt-item-checkbox mt-1" value="${it.id}">
                                    <div>
                                        <div class="font-medium text-gray-800">${name}</div>
                                        <div class="text-xs text-gray-500 mt-0.5">${jobApplied}${updatedAt}</div>
                                    </div>
                                </label>
                            </div>
                            <div class="mt-2 text-xs text-gray-600 line-clamp-3">${suggestion}</div>
                            <div class="mt-2 text-xs text-gray-500">
                                ç›®æ ‡åˆ†ï¼šoverall=${ts.overall ?? '-'}, skill=${ts.skill ?? '-'}, background=${ts.background ?? '-'}, startup_fit=${ts.startup_fit ?? '-'}
                            </div>
                        </div>
                    `;
                }).join('');

                // Preselect first item
                const first = ITEMS[0];
                if (first?.id) {
                    selectOptimizationItem(first.id);
                }
            } catch (e) {
                console.error(e);
                listEl.innerHTML = `<div class="bg-white rounded-lg border shadow-sm p-6 text-center text-red-600">åŠ è½½å¤±è´¥ï¼š${e.message}</div>`;
            }
        }

        async function selectOptimizationItem(itemId) {
            const activeId = document.getElementById('opt-active-item-id')?.value;
            if (__opt_dirty && activeId) {
                const shouldSave = window.confirm('ä½ æœ‰æœªä¿å­˜çš„ä¿®æ”¹ï¼Œæ˜¯å¦å…ˆä¿å­˜ï¼Ÿ\nç¡®å®š=ä¿å­˜å¹¶ç»§ç»­ï¼›å–æ¶ˆ=å¿½ç•¥ä¿®æ”¹å¹¶ç»§ç»­');
                if (shouldSave) {
                    await saveOptimizationItem({ silent: true });
                }
                __opt_dirty = false;
            }

            const it = ITEMS.find(x => x.id === itemId);
            if (!it) {
                showToast('æœªæ‰¾åˆ°è¯¥è®°å½•', 'error');
                return;
            }
            document.getElementById('opt-active-item-id').value = it.id;
            document.getElementById('opt-active-updated-at').textContent = it.updated_at ? `updated_at: ${it.updated_at}` : '';

            const ts = it.target_scores || {};
            document.getElementById('opt-edit-overall').value = ts.overall ?? '';
            document.getElementById('opt-edit-skill').value = ts.skill ?? '';
            document.getElementById('opt-edit-background').value = ts.background ?? '';
            document.getElementById('opt-edit-startup-fit').value = ts.startup_fit ?? '';
            document.getElementById('opt-edit-suggestion').value = it.suggestion || '';
            __opt_dirty = false;

            // Render original scores if available
            const a = it.current_analysis || {};
            document.getElementById('opt-original-scores').textContent =
                `å½“å‰åˆ†æ•°ï¼šoverall=${a.overall ?? '-'}ï¼Œskill=${a.skill ?? '-'}ï¼Œbackground=${a.background ?? '-'}ï¼Œstartup_fit=${a.startup_fit ?? '-'}`;

            const iframe = document.getElementById('candidate-iframe');
            if (iframe && it.candidate_id) {
                iframe.src = `/candidate/${encodeURIComponent(it.candidate_id)}?context=optimize`;
            }
        }

        async function saveOptimizationItem({ silent = false } = {}) {
            const itemId = document.getElementById('opt-active-item-id')?.value || '';
            if (!itemId) {
                if (!silent) showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå€™é€‰äººè®°å½•', 'warning');
                return;
            }
            const suggestion = document.getElementById('opt-edit-suggestion')?.value?.trim() || '';
            if (!suggestion || suggestion.length < 5) {
                showToast('å»ºè®®ä¸ç†ç”±è‡³å°‘ 5 ä¸ªå­—', 'error');
                return;
            }
            const targetScores = {
                overall: _clampScore(document.getElementById('opt-edit-overall')?.value),
                skill: _clampScore(document.getElementById('opt-edit-skill')?.value),
                background: _clampScore(document.getElementById('opt-edit-background')?.value),
                startup_fit: _clampScore(document.getElementById('opt-edit-startup-fit')?.value),
            };
            const hasAnyScore = Object.values(targetScores).some(v => v !== null);
            if (!hasAnyScore) {
                showToast('è¯·è‡³å°‘å¡«å†™ä¸€ä¸ªç›®æ ‡åˆ†æ•°ï¼ˆæœªå¡«è¡¨ç¤ºâ€œä¸å˜â€ï¼‰', 'error');
                return;
            }
            try {
                await apiCall('/jobs/optimizations/update', 'POST', { id: itemId, suggestion, target_scores: targetScores });
                __opt_dirty = false;
                if (!silent) showToast('å·²ä¿å­˜', 'success');
                await refreshOptimizationList();
            } catch (e) {
                console.error(e);
                showToast('ä¿å­˜å¤±è´¥ï¼š' + e.message, 'error');
            }
        }

        function goToGeneratePage() {
            const selected = _getSelectedItemIds();
            if (!selected.length) {
                showToast('è¯·å…ˆå‹¾é€‰è‡³å°‘ä¸€ä¸ªå€™é€‰äººåé¦ˆ', 'warning');
                return;
            }
            const qp = selected.map(encodeURIComponent).join(',');
            window.location.href = `/jobs/optimize/generate?job_id=${encodeURIComponent(BASE_JOB_ID)}&item_ids=${qp}`;
        }

        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>

