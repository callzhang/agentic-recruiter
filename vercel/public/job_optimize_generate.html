<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿæˆæ–°ç‰ˆå²—ä½è‚–åƒ - BOSSæ‹›è˜åŠ©æ‰‹</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="/vendor/diff.min.js"></script>
    <style>
        .diff-add { font-weight: 600; color: #166534; background: #dcfce7; }
        .diff-del { text-decoration: line-through; color: #6b7280; background: #f3f4f6; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <a href="/" class="text-2xl font-bold text-blue-600">ğŸ¤– BOSSæ‹›è˜åŠ©æ‰‹</a>
                </div>
                <div class="flex space-x-6">
                    <a href="/" class="text-gray-700 hover:text-blue-600 transition">é¦–é¡µ</a>
                    <a href="/jobs" class="text-gray-700 hover:text-blue-600 transition">å²—ä½ç”»åƒ</a>
                    <span class="text-gray-500">ç”Ÿæˆæ–°ç‰ˆ</span>
                </div>
            </div>
        </div>
    </nav>

    <div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col space-y-2"></div>

    <div class="container mx-auto p-4">
        <div class="space-y-6">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">ç”Ÿæˆæ–°ç‰ˆå²—ä½è‚–åƒ</h1>
                        <p class="text-gray-600 mt-2">
                            å²—ä½ï¼š<span class="font-medium text-gray-800" id="job-position">åŠ è½½ä¸­...</span>
                            <span class="text-gray-400" id="job-base-id"></span>
                        </p>
                    </div>
                    <div class="flex gap-2">
                        <a id="back-to-opt" href="/jobs/optimize"
                           class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                            â† è¿”å›ä¼˜åŒ–æ¸…å•
                        </a>
                        <a id="back-to-jobs" href="/jobs"
                           class="px-4 py-2 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100 transition">
                            è¿”å›å²—ä½é¡µ
                        </a>
                    </div>
                </div>
            </div>

            <div id="progress-card" class="bg-white rounded-lg border shadow-sm p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-lg font-semibold text-gray-800">æ­£åœ¨ç”Ÿæˆï¼ˆå¤§çº¦éœ€è¦ 30sï¼‰</div>
                        <div class="text-sm text-gray-500 mt-1" id="progress-desc">æ­£åœ¨å‡†å¤‡è¾“å…¥ä¸çº¦æŸâ€¦</div>
                    </div>
                    <div class="text-sm text-gray-600 font-mono" id="progress-percent">0%</div>
                </div>
                <div class="mt-4 w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                    <div id="progress-bar" class="bg-blue-600 h-3 rounded-full" style="width: 0%"></div>
                </div>
            </div>

            <div id="result-card" class="bg-white rounded-lg border shadow-sm p-6 hidden">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-gray-800">å¯¹æ¯”ä¸ç¼–è¾‘</h2>
                    <div class="flex items-center gap-2">
                        <button onclick="copyGeneratedPortraitJson()"
                                class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded text-gray-700">
                            æ‹·è´å²—ä½è‚–åƒ JSON
                        </button>
                        <button onclick="pastePortraitJsonIntoEditors()"
                                class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded text-gray-700">
                            ç²˜è´´å‰ªåˆ‡æ¿ JSON
                        </button>
                        <button onclick="publishOptimizedPortrait()"
                                class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-medium">
                            ç¡®è®¤æäº¤ï¼ˆå‘å¸ƒæ–°ç‰ˆæœ¬ï¼‰
                        </button>
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-2">
                    å·¦ä¾§ä¸ºå½“å‰çº¿ä¸Šç‰ˆæœ¬ï¼›å³ä¾§é»˜è®¤å±•ç¤ºå­—ç¬¦çº§ diffï¼Œç‚¹â€œç¼–è¾‘/é¢„è§ˆâ€åˆ‡æ¢ã€‚
                </p>
                <div id="fields" class="mt-4 space-y-6"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let BASE_JOB_ID = '';
        let ITEM_IDS = [];
        let currentPortrait = null;
        let generatedPortrait = null;
        let rationale = null;

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colors = { info: 'bg-blue-600', success: 'bg-green-600', error: 'bg-red-600', warning: 'bg-yellow-600' };
            toast.className = `${colors[type] || colors.info} text-white px-6 py-3 rounded-lg shadow-lg mb-2`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function _qs(name) {
            return new URL(window.location.href).searchParams.get(name) || '';
        }

        async function apiCall(endpoint, method = 'GET', body = null) {
            const options = { method, headers: { 'Content-Type': 'application/json' } };
            if (body) options.body = JSON.stringify(body);
            const resp = await fetch(`${API_BASE}${endpoint}`, options);
            const data = await resp.json();
            if (!data || data.success === false) {
                throw new Error(data?.error || 'request failed');
            }
            return data;
        }

        function _progressEase(elapsedSec) {
            // ç›®æ ‡ï¼šçº¦ 30s åˆ° 95%ï¼Œä¹‹åæ¸è¿‘ 100%
            if (elapsedSec <= 30) {
                return Math.min(95, (elapsedSec / 30) * 95);
            }
            const tail = elapsedSec - 30;
            const asymptote = 99.9;
            const k = 0.03; // slower approach
            const v = 95 + (asymptote - 95) * (1 - Math.exp(-k * tail));
            return Math.min(asymptote, v);
        }

        function _renderCharDiffHtml(oldText, newText) {
            try {
                const parts = Diff.diffChars(String(oldText || ''), String(newText || ''));
                return parts.map(p => {
                    const safe = (p.value || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    if (p.added) return `<span class="diff-add">${safe}</span>`;
                    if (p.removed) return `<span class="diff-del">${safe}</span>`;
                    return `<span>${safe}</span>`;
                }).join('');
            } catch (e) {
                return (newText || '').toString();
            }
        }

        function _normalizeDisplay(v) {
            if (v === null || v === undefined) return '';
            return String(v);
        }

        function _appendRationaleCallout(container, text) {
            const t = (text || '').trim();
            if (!t) return;
            const wrap = document.createElement('div');
            wrap.className = 'flex gap-2 text-sm text-gray-700 bg-gray-50 border rounded-lg p-3';
            const icon = document.createElement('div');
            icon.className = 'text-gray-500';
            icon.textContent = 'â';
            const body = document.createElement('div');
            body.className = 'whitespace-pre-wrap';
            body.textContent = t;
            wrap.appendChild(icon);
            wrap.appendChild(body);
            container.appendChild(wrap);
        }

        function _buildDiffEditor(fieldKey, currentValue, newValue) {
            const wrap = document.createElement('div');
            wrap.className = 'space-y-2';
            const diffView = document.createElement('div');
            diffView.className = 'w-full min-h-[120px] px-3 py-2 border rounded-lg bg-white text-xs font-mono whitespace-pre-wrap';
            diffView.innerHTML = _renderCharDiffHtml(currentValue || '', newValue || '');
            const textarea = document.createElement('textarea');
            textarea.className = 'w-full min-h-[120px] px-3 py-2 border rounded-lg text-xs font-mono hidden';
            textarea.dataset.fieldKey = fieldKey;
            textarea.value = _normalizeDisplay(newValue || '');
            wrap.appendChild(diffView);
            wrap.appendChild(textarea);
            wrap.__diffView = diffView;
            wrap.__textarea = textarea;
            wrap.__currentValue = currentValue || '';
            wrap.__setEditing = (editing) => {
                if (editing) {
                    diffView.classList.add('hidden');
                    textarea.classList.remove('hidden');
                    textarea.focus();
                } else {
                    textarea.classList.add('hidden');
                    diffView.classList.remove('hidden');
                    diffView.innerHTML = _renderCharDiffHtml(wrap.__currentValue || '', textarea.value || '');
                }
            };
            wrap.__isEditing = () => !textarea.classList.contains('hidden');
            return wrap;
        }

        function _renderTwoColumnField(container, label, key, currentValue, newValue) {
            const changed = (currentValue || '') !== (newValue || '');
            const rationaleText = container.__rationale?.[key] || '';
            const header = document.createElement('div');
            header.className = 'flex items-center justify-between';
            const leftTitle = document.createElement('div');
            leftTitle.className = 'font-medium text-gray-800';
            leftTitle.textContent = label;

            const rightControls = document.createElement('div');
            rightControls.className = 'flex items-center gap-2';
            const status = document.createElement('div');
            status.className = `text-xs ${changed ? 'text-amber-700' : 'text-gray-400'}`;
            status.textContent = changed ? 'å·²å˜åŒ–' : 'æ— å˜åŒ–';
            const editBtn = document.createElement('button');
            editBtn.type = 'button';
            editBtn.className = 'px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded text-gray-700';
            editBtn.textContent = 'ç¼–è¾‘';

            rightControls.appendChild(status);
            rightControls.appendChild(editBtn);
            header.appendChild(leftTitle);
            header.appendChild(rightControls);
            container.appendChild(header);

            _appendRationaleCallout(container, rationaleText);

            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-2 gap-3';

            const left = document.createElement('textarea');
            left.className = 'w-full min-h-[120px] px-3 py-2 border rounded-lg bg-gray-50 text-xs font-mono';
            left.readOnly = true;
            left.value = _normalizeDisplay(currentValue || '');

            const right = _buildDiffEditor(key, currentValue || '', newValue || '');
            editBtn.addEventListener('click', () => {
                const nowEditing = !right.__isEditing();
                right.__setEditing(nowEditing);
                editBtn.textContent = nowEditing ? 'é¢„è§ˆ' : 'ç¼–è¾‘';
            });

            grid.appendChild(left);
            grid.appendChild(right);
            container.appendChild(grid);
        }

        function _renderKeywords(container, currentKeywords, newKeywords) {
            const rationaleText = container.__rationale?.keywords || '';
            const norm = (kw) => (kw && typeof kw === 'object') ? kw : { positive: [], negative: [] };
            const c = norm(currentKeywords);
            const n = norm(newKeywords);

            const block = document.createElement('div');
            block.className = 'space-y-2';
            const header = document.createElement('div');
            header.className = 'font-medium text-gray-800';
            header.textContent = 'keywordsï¼ˆé€è¡Œç¼–è¾‘ï¼‰';
            block.appendChild(header);

            _appendRationaleCallout(block, rationaleText);

            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-2 gap-3';

            const left = document.createElement('textarea');
            left.className = 'w-full min-h-[120px] px-3 py-2 border rounded-lg bg-gray-50 text-xs font-mono';
            left.readOnly = true;
            left.value = `positive:\n${(c.positive || []).join('\n')}\n\nnegative:\n${(c.negative || []).join('\n')}`;

            const rightText = `positive:\n${(n.positive || []).join('\n')}\n\nnegative:\n${(n.negative || []).join('\n')}`;
            const right = _buildDiffEditor('keywords', left.value, rightText);

            grid.appendChild(left);
            grid.appendChild(right);
            block.appendChild(grid);
            container.appendChild(block);
        }

        function _parseKeywords(text) {
            // Allow pasted JSON escaping; normalize literal backslash sequences to real newlines.
            const normalized = String(text || '').replace(/\\r\\n/g, '\n').replace(/\\n/g, '\n');
            const lines = normalized.split(/\r?\n/);
            let mode = null;
            const positive = [];
            const negative = [];
            for (const raw of lines) {
                const line = raw.trim();
                if (!line) continue;
                if (line.toLowerCase().startsWith('positive')) { mode = 'positive'; continue; }
                if (line.toLowerCase().startsWith('negative')) { mode = 'negative'; continue; }
                if (mode === 'positive') positive.push(line);
                else if (mode === 'negative') negative.push(line);
            }
            return { positive, negative };
        }

        function _collectEditedPortraitFromPage() {
            const out = {};
            const fieldKeys = ['description', 'responsibilities', 'requirements', 'target_profile', 'drill_down_questions'];
            for (const key of fieldKeys) {
                const textarea = document.querySelector(`textarea[data-field-key="${key}"]`);
                out[key] = textarea ? textarea.value : (generatedPortrait?.[key] ?? '');
            }
            // keywords
            const kwWrap = document.querySelector('textarea[data-field-key="keywords"]');
            if (kwWrap) {
                out.keywords = _parseKeywords(kwWrap.value);
            } else {
                out.keywords = generatedPortrait?.keywords ?? { positive: [], negative: [] };
            }
            out.position = generatedPortrait?.position || currentPortrait?.position || '';
            out.candidate_filters = null;
            return out;
        }

        async function _readClipboardText() {
            try {
                if (navigator.clipboard && navigator.clipboard.readText) {
                    return await navigator.clipboard.readText();
                }
            } catch (e) {}
            return prompt('æ— æ³•ç›´æ¥è¯»å–å‰ªåˆ‡æ¿ï¼Œè¯·ç²˜è´´ JSONï¼š', '') || '';
        }

        async function _writeClipboardText(text) {
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(text);
                    return;
                }
            } catch (e) {}
            prompt('æ— æ³•ç›´æ¥å†™å…¥å‰ªåˆ‡æ¿ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼š', text);
        }

        function _unwrapPortraitPayload(obj) {
            if (!obj || typeof obj !== 'object') return null;
            if (obj.job_portrait && typeof obj.job_portrait === 'object') return obj.job_portrait;
            if (obj.data && typeof obj.data === 'object') return obj.data;
            return obj;
        }

        async function copyGeneratedPortraitJson() {
            try {
                const portrait = _collectEditedPortraitFromPage();
                await _writeClipboardText(JSON.stringify(portrait, null, 2));
                showToast('å·²å¤åˆ¶å²—ä½è‚–åƒ JSON', 'success');
            } catch (e) {
                console.error(e);
                showToast('å¤åˆ¶å¤±è´¥', 'error');
            }
        }

        async function pastePortraitJsonIntoEditors() {
            try {
                const raw = await _readClipboardText();
                if (!raw || raw.trim().length < 2) {
                    showToast('å‰ªåˆ‡æ¿ä¸ºç©ºæˆ–ä¸æ˜¯ JSON', 'error');
                    return;
                }
                let obj;
                try {
                    obj = JSON.parse(raw);
                } catch (e) {
                    showToast('è§£æ JSON å¤±è´¥', 'error');
                    return;
                }
                const portrait = _unwrapPortraitPayload(obj) || {};

                const fieldKeys = ['description', 'responsibilities', 'requirements', 'target_profile', 'drill_down_questions'];
                for (const key of fieldKeys) {
                    if (!(key in portrait)) continue;
                    const textarea = document.querySelector(`textarea[data-field-key="${key}"]`);
                    if (!textarea) continue;
                    textarea.value = _normalizeDisplay(portrait[key] ?? '');
                    textarea.dispatchEvent(new Event('input', { bubbles: true }));
                }

                if ('keywords' in portrait && portrait.keywords && typeof portrait.keywords === 'object') {
                    const text = `positive:\n${(portrait.keywords.positive || []).join('\n')}\n\nnegative:\n${(portrait.keywords.negative || []).join('\n')}`;
                    const textarea = document.querySelector('textarea[data-field-key="keywords"]');
                    if (textarea) {
                        textarea.value = text;
                        textarea.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                }
                showToast('å·²ç²˜è´´åˆ°é¡µé¢ï¼ˆç¼ºå­—æ®µä¸è¦†ç›–ï¼‰', 'success');
            } catch (e) {
                console.error(e);
                showToast('ç²˜è´´å¤±è´¥', 'error');
            }
        }

        function _renderAllFields() {
            const fields = document.getElementById('fields');
            fields.innerHTML = '';
            fields.__rationale = rationale || {};
            _renderTwoColumnField(fields, 'å²—ä½æ¦‚è¿°ï¼ˆdescriptionï¼‰', 'description', currentPortrait?.description || '', generatedPortrait?.description || '');
            _renderTwoColumnField(fields, 'æ ¸å¿ƒèŒè´£ï¼ˆresponsibilitiesï¼‰', 'responsibilities', currentPortrait?.responsibilities || '', generatedPortrait?.responsibilities || '');
            _renderTwoColumnField(fields, 'è¯„åˆ†æ ‡å‡†ï¼ˆrequirementsï¼‰', 'requirements', currentPortrait?.requirements || '', generatedPortrait?.requirements || '');
            _renderTwoColumnField(fields, 'ç†æƒ³äººé€‰ï¼ˆtarget_profileï¼‰', 'target_profile', currentPortrait?.target_profile || '', generatedPortrait?.target_profile || '');
            _renderTwoColumnField(fields, 'çº¿ä¸Šç”„åˆ«é—®é¢˜åº“ï¼ˆdrill_down_questionsï¼‰', 'drill_down_questions', currentPortrait?.drill_down_questions || '', generatedPortrait?.drill_down_questions || '');
            _renderKeywords(fields, currentPortrait?.keywords || {positive:[],negative:[]}, generatedPortrait?.keywords || {positive:[],negative:[]});

            // Make keywords editable by binding a textarea in the right editor
            const kwEditor = document.querySelector('#fields textarea[data-field-key="keywords"]');
            if (!kwEditor) {
                const rightText = `positive:\n${(generatedPortrait?.keywords?.positive || []).join('\n')}\n\nnegative:\n${(generatedPortrait?.keywords?.negative || []).join('\n')}`;
                const container = document.querySelector('#fields');
                const hidden = document.createElement('textarea');
                hidden.className = 'hidden';
                hidden.dataset.fieldKey = 'keywords';
                hidden.value = rightText;
                container.appendChild(hidden);
            }
        }

        async function publishOptimizedPortrait() {
            try {
                const portrait = _collectEditedPortraitFromPage();
                const resp = await apiCall('/jobs/optimizations/publish', 'POST', {
                    job_id: BASE_JOB_ID,
                    item_ids: ITEM_IDS,
                    job_portrait: portrait,
                });
                showToast('å·²å‘å¸ƒæ–°ç‰ˆæœ¬ï¼Œå¹¶å…³é—­æœ¬æ¬¡åé¦ˆ', 'success');
                setTimeout(() => {
                    window.location.href = `/jobs?tab=${encodeURIComponent(BASE_JOB_ID)}`;
                }, 500);
            } catch (e) {
                console.error(e);
                showToast('å‘å¸ƒå¤±è´¥ï¼š' + e.message, 'error');
            }
        }

        async function initPage() {
            BASE_JOB_ID = (_qs('job_id') || '').trim();
            const itemIdsRaw = (_qs('item_ids') || '').trim();
            ITEM_IDS = itemIdsRaw ? itemIdsRaw.split(',').map(s => decodeURIComponent(s)).filter(Boolean) : [];
            if (!BASE_JOB_ID || !ITEM_IDS.length) {
                showToast('ç¼ºå°‘ job_id æˆ– item_ids å‚æ•°', 'error');
                return;
            }
            document.getElementById('job-base-id').textContent = `(${BASE_JOB_ID})`;
            document.getElementById('back-to-opt').href = `/jobs/optimize?job_id=${encodeURIComponent(BASE_JOB_ID)}`;
            document.getElementById('back-to-jobs').href = `/jobs?tab=${encodeURIComponent(BASE_JOB_ID)}`;

            try {
                const jobResp = await apiCall(`/jobs/${encodeURIComponent(BASE_JOB_ID)}`);
                currentPortrait = jobResp.data || {};
                document.getElementById('job-position').textContent = currentPortrait.position || BASE_JOB_ID;
            } catch (e) {
                document.getElementById('job-position').textContent = BASE_JOB_ID;
            }

            const t0 = Date.now();
            let done = false;
            const tick = () => {
                if (done) return;
                const elapsed = (Date.now() - t0) / 1000.0;
                const pct = _progressEase(elapsed);
                document.getElementById('progress-bar').style.width = `${pct}%`;
                document.getElementById('progress-percent').textContent = `${pct.toFixed(1)}%`;
                requestAnimationFrame(tick);
            };
            tick();

            try {
                document.getElementById('progress-desc').textContent = 'æ­£åœ¨è°ƒç”¨æ¨¡å‹ç”Ÿæˆâ€¦';
                const gen = await apiCall('/jobs/optimizations/generate', 'POST', { job_id: BASE_JOB_ID, item_ids: ITEM_IDS });
                generatedPortrait = gen.data?.job_portrait || {};
                rationale = gen.data?.rationale || {};
                done = true;
                document.getElementById('progress-bar').style.width = '100%';
                document.getElementById('progress-percent').textContent = '100%';
                document.getElementById('progress-card').classList.add('hidden');
                document.getElementById('result-card').classList.remove('hidden');
                _renderAllFields();
            } catch (e) {
                console.error(e);
                done = true;
                showToast('ç”Ÿæˆå¤±è´¥ï¼š' + e.message, 'error');
                document.getElementById('progress-desc').textContent = 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·è¿”å›é‡è¯•æˆ–æ£€æŸ¥ OpenAI ç¯å¢ƒå˜é‡ã€‚';
            }
        }

        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>

