{% extends "base.html" %}

{% block title %}{% if assistant %}ç¼–è¾‘åŠ©æ‰‹{% else %}åˆ›å»ºæ–°åŠ©æ‰‹{% endif %} - BOSSæ‹›è˜åŠ©æ‰‹{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-6">
    <!-- Page header -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">
                    {% if assistant %}ç¼–è¾‘åŠ©æ‰‹{% else %}åˆ›å»ºæ–°åŠ©æ‰‹{% endif %}
                </h1>
                <p class="text-gray-600 mt-2">é…ç½® AI åŠ©æ‰‹çš„æŒ‡ä»¤ã€æ¨¡å‹å’Œå…ƒæ•°æ®</p>
            </div>
            <button onclick="location.href='/assistants'" 
                    class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                â† è¿”å›åˆ—è¡¨
            </button>
        </div>
    </div>

    <!-- Assistant form -->
    <div class="bg-white rounded-lg shadow-lg p-6">
        <form id="assistant-form" hx-post="{% if assistant %}/assistants/{{ assistant.id }}/update{% else %}/assistants/create{% endif %}" 
              hx-target="#form-result" hx-swap="innerHTML">
            
            <!-- Basic Information -->
            <div class="space-y-4">
                <h2 class="text-xl font-semibold text-gray-800">åŸºæœ¬ä¿¡æ¯</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 mb-2">åç§° *</label>
                        <input type="text" id="name" name="name" required
                               value="{{ assistant.name if assistant else '' }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label for="model" class="block text-sm font-medium text-gray-700 mb-2">æ¨¡å‹</label>
                        <select id="model" name="model" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="gpt-4o-mini" {% if not assistant or assistant.model == 'gpt-4o-mini' %}selected{% endif %}>gpt-4o-mini</option>
                            <option value="gpt-4o" {% if assistant and assistant.model == 'gpt-4o' %}selected{% endif %}>gpt-4o</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-2">æè¿°</label>
                    <textarea id="description" name="description" rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                              placeholder="åŠ©æ‰‹çš„æè¿°ä¿¡æ¯">{{ assistant.description if assistant else '' }}</textarea>
                </div>
            </div>

            <!-- Instructions -->
            <div class="space-y-4 mt-8">
                <h2 class="text-xl font-semibold text-gray-800">ğŸ’¬ æ²Ÿé€šè®¾ç½®</h2>
                <div>
                    <label for="instructions" class="block text-sm font-medium text-gray-700 mb-2">æŒ‡ä»¤</label>
                    <textarea id="instructions" name="instructions" rows="15"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                              placeholder="è®¾ç½®AIæ¨¡å‹çš„æ²Ÿé€šé£æ ¼å’ŒæŒ‡ä»¤...">{{ assistant.instructions if assistant else default_instructions }}</textarea>
                    <p class="text-sm text-gray-500 mt-1">ç”¨äºè®¾ç½®AIæ¨¡å‹çš„æ²Ÿé€šé£æ ¼ï¼Œå…¬å¸ä¿¡æ¯éƒ½ä¿å­˜åœ¨"æ²Ÿé€šè®¾ç½®é‡Œé¢"ï¼Œç”¨äºå›ç­”åŠ©æ‰‹çš„é—®é¢˜</p>
                </div>
            </div>

            <!-- Metadata -->
            <div class="space-y-4 mt-8">
                <h2 class="text-xl font-semibold text-gray-800">å…ƒæ•°æ® (Metadata)</h2>
                <p class="text-sm text-gray-500">å¯ç”¨äºä¿å­˜ä¸€äº›é¢å¤–ä¿¡æ¯ï¼Œä¸ç”¨äºAIæ¨¡å‹è¿è¡Œ</p>
                
                <div id="metadata-container">
                    <div class="space-y-3" id="metadata-fields">
                        {% if assistant and assistant.metadata %}
                            {% for key, value in assistant.metadata.items() %}
                            <div class="flex gap-3 metadata-row">
                                <input type="text" name="metadata_key" placeholder="é”®" value="{{ key }}"
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <input type="text" name="metadata_value" placeholder="å€¼" value="{{ value }}"
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <button type="button" onclick="removeMetadataRow(this)" 
                                        class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">ğŸ—‘ï¸ åˆ é™¤</button>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="flex gap-3 metadata-row">
                                <input type="text" name="metadata_key" placeholder="é”®"
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <input type="text" name="metadata_value" placeholder="å€¼"
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <button type="button" onclick="removeMetadataRow(this)" 
                                        class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">ğŸ—‘ï¸ åˆ é™¤</button>
                            </div>
                        {% endif %}
                    </div>
                    <button type="button" onclick="addMetadataRow()" 
                            class="mt-3 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                        â• æ·»åŠ å…ƒæ•°æ®
                    </button>
                    <p class="text-sm text-gray-500 mt-2">ğŸ’¡ æç¤ºï¼šè‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªå…ƒæ•°æ®è¡Œ</p>
                </div>
            </div>

            <!-- Assistant Info (for existing assistants) -->
            {% if assistant %}
            <div class="space-y-4 mt-8">
                <h2 class="text-xl font-semibold text-gray-800">åŠ©æ‰‹ä¿¡æ¯</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600">
                    <div>
                        <span class="font-medium">åˆ›å»ºæ—¶é—´:</span> 
                        <span id="created-time">{{ assistant.created_at | format_timestamp if assistant.created_at else 'æœªçŸ¥' }}</span>
                    </div>
                    <div>
                        <span class="font-medium">ID:</span> 
                        <span class="font-mono">{{ assistant.id }}</span>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Form result -->
            <div id="form-result"></div>

            <!-- Action buttons -->
            <div class="flex gap-4 mt-8 pt-6 border-t">
                <button type="submit" 
                        class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                    {% if assistant %}ğŸ’¾ ä¿å­˜{% else %}âœ¨ åˆ›å»º{% endif %}
                </button>
                
                {% if assistant %}
                <button type="button" onclick="deleteAssistant()" 
                        class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium">
                    ğŸ—‘ï¸ åˆ é™¤åŠ©æ‰‹
                </button>
                {% endif %}
                
                <button type="button" onclick="location.href='/assistants'" 
                        class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 font-medium">
                    å–æ¶ˆ
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Add metadata row
function addMetadataRow() {
    const container = document.getElementById('metadata-fields');
    const row = document.createElement('div');
    row.className = 'flex gap-3 metadata-row';
    row.innerHTML = `
        <input type="text" name="metadata_key" placeholder="é”®"
               class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        <input type="text" name="metadata_value" placeholder="å€¼"
               class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        <button type="button" onclick="removeMetadataRow(this)" 
                class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">åˆ é™¤</button>
    `;
    container.appendChild(row);
}

// Remove metadata row
function removeMetadataRow(button) {
    console.log('removeMetadataRow called', button);
    
    // Find the parent row element
    const row = button.closest('.metadata-row');
    console.log('Found row:', row);
    
    if (row) {
        // Check if this is the last row - if so, don't allow deletion
        const allRows = document.querySelectorAll('.metadata-row');
        console.log('Total rows:', allRows.length);
        
        if (allRows.length <= 1) {
            alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªå…ƒæ•°æ®è¡Œ');
            return;
        }
        
        // Add a fade-out effect before removing
        row.style.opacity = '0.5';
        row.style.transition = 'opacity 0.3s ease';
        
        setTimeout(() => {
            row.remove();
            console.log('Row removed successfully');
        }, 300);
    } else {
        console.log('Row not found, trying fallback');
        // Fallback: try to remove the parent element
        if (button.parentElement) {
            button.parentElement.remove();
        }
    }
}

// Delete assistant
function deleteAssistant() {
    if (confirm('âš ï¸ æ‚¨ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåŠ©æ‰‹å—ï¼Ÿ\næ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼')) {
        fetch('/assistants/{{ assistant.id }}/delete', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('åŠ©æ‰‹å·²åˆ é™¤');
                location.href = '/assistants';
            } else {
                alert('åˆ é™¤å¤±è´¥: ' + data.error);
            }
        })
        .catch(error => {
            alert('åˆ é™¤å¤±è´¥: ' + error);
        });
    }
}

// Ensure at least one metadata row exists
function ensureMetadataRow() {
    const allRows = document.querySelectorAll('.metadata-row');
    if (allRows.length === 0) {
        addMetadataRow();
    }
}

// Initialize metadata section
document.addEventListener('DOMContentLoaded', function() {
    ensureMetadataRow();
    console.log('Metadata section initialized');
});

// Handle form submission
document.getElementById('assistant-form').addEventListener('htmx:afterRequest', function(event) {
    if (event.detail.xhr.status === 200) {
        const response = JSON.parse(event.detail.xhr.responseText);
        if (response.success) {
            alert('{% if assistant %}åŠ©æ‰‹å·²æ›´æ–°{% else %}åŠ©æ‰‹å·²åˆ›å»º{% endif %}');
            location.href = '/assistants';
        } else {
            document.getElementById('form-result').innerHTML = 
                `<div class="mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded">${response.error}</div>`;
        }
    }
});
</script>
{% endblock %}
