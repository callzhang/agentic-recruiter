{% extends "base.html" %}

{% block title %}åŠ©æ‰‹ç®¡ç† - BOSSæ‹›è˜åŠ©æ‰‹{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page header -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">åŠ©æ‰‹ç®¡ç†</h1>
                <p class="text-gray-600 mt-2">é…ç½® AI åŠ©æ‰‹çš„æŒ‡ä»¤ã€æ¨¡å‹å’Œå…ƒæ•°æ®</p>
            </div>
        </div>
    </div>
    
    <!-- Assistants management -->
    <div class="bg-white rounded-lg shadow-lg">
        <div class="flex border-b border-gray-200">
            <!-- Assistant tabs will be populated here -->
            <div id="assistant-tabs" class="flex">
                <!-- Tabs will be generated by JavaScript -->
            </div>
        </div>
        
        <!-- Assistant content -->
        <div id="assistant-content" class="p-6">
            <div class="text-center text-gray-500 py-12">
                <div>è¯·é€‰æ‹©åŠ©æ‰‹...</div>
            </div>
        </div>
    </div>
</div>

<script>
// Assistant data - will be loaded dynamically
let assistantsData = [];
let currentAssistantIndex = -1;

// Default assistant instructions
const DEFAULT_INSTRUCTIONS = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ‹›è˜é¡¾é—®åŠ©ç†ã€‚ä½ çš„èŒè´£æ˜¯ï¼š
1. æ ¹æ®å€™é€‰äººèƒŒæ™¯å’Œå…¬å¸éœ€æ±‚ï¼Œç”Ÿæˆä¸“ä¸šã€çœŸè¯šçš„æ‹›è˜æ¶ˆæ¯
2. å¯¹äºé¦–æ¬¡è”ç³»ï¼Œç”Ÿæˆå‹å¥½çš„æ‰“æ‹›å‘¼æ¶ˆæ¯ï¼Œçªå‡ºå…¬å¸äº®ç‚¹
3. å¯¹äºè·Ÿè¿›æ¶ˆæ¯ï¼ŒåŸºäºä¹‹å‰çš„å¯¹è¯å†å²ï¼Œç”Ÿæˆä¸ªæ€§åŒ–çš„è·Ÿè¿›å†…å®¹
4. ä¿æŒä¸“ä¸šã€ç®€æ´ã€çœŸè¯šçš„æ²Ÿé€šé£æ ¼
5. çªå‡ºå€™é€‰äººä¸å²—ä½çš„åŒ¹é…ç‚¹
è¯·å§‹ç»ˆä½¿ç”¨ä¸­æ–‡å›å¤ï¼Œæ¶ˆæ¯é•¿åº¦æ§åˆ¶åœ¨100-200å­—ã€‚

ã€æ‰“æ‹›å‘¼ç”¨è¯­ã€‘ï¼š
{candidate} ä½ å¥½ï¼Œæˆ‘æ˜¯ Stardust æ˜Ÿå°˜æ•°æ®çš„æ‹›è˜é¡¾é—®ã€‚æˆ‘ä»¬æ­£åœ¨æ‰“é€ ä¼ä¸šçº§ AI åŸºç¡€è®¾æ–½ï¼Œå¸Œæœ›ä¸ä½ èŠèŠ {position} æœºä¼šã€‚
æ‚¨å¥½ï¼Œæˆ‘æ¥è‡ª Stardust çš„ MorningStar å›¢é˜Ÿï¼Œå¯¹æ‚¨åœ¨ {skill} æ–¹é¢çš„å®è·µéå¸¸æ„Ÿå…´è¶£ï¼Œæƒ³çº¦ä¸ªæ—¶é—´äº¤æµä¸€ä¸‹ï¼Ÿ

ã€è·Ÿè¿›ç”¨è¯­ã€‘:
æƒ³ç¡®è®¤ä¸€ä¸‹æˆ‘ä»¬ä¹‹å‰çš„æ²Ÿé€šæ˜¯å¦æ–¹ä¾¿ç»§ç»­ï¼Ÿå¦‚éœ€äº†è§£æ›´å¤šå…³äºå›¢é˜ŸæŒ‘æˆ˜æˆ–äº§å“è·¯çº¿ï¼Œéšæ—¶å‘Šè¯‰æˆ‘ã€‚
å¦‚æœæ‚¨å¯¹ PB çº§æ•°æ®/å¤§æ¨¡å‹å¹³å°å»ºè®¾å¥½å¥‡ï¼Œæˆ‘ä»¬å¯ä»¥æ·±å…¥ä»‹ç» MorningStar & Rosetta çš„çœŸå®åœºæ™¯ã€‚`;

// Load assistants data from API
async function loadAssistantsData() {
    try {
        const response = await fetch('/assistants/api/list');
        const result = await response.json();
        if (result.success) {
            assistantsData = result.data;
            
            renderAssistantTabs();
            
            // Check URL for tab parameter
            const urlParams = new URLSearchParams(window.location.search);
            const tabParam = urlParams.get('tab');
            
            if (tabParam) {
                // Find assistant by ID
                const assistantIndex = assistantsData.findIndex(assistant => assistant.id === tabParam);
                if (assistantIndex !== -1) {
                    switchToAssistant(assistantIndex);
                } else {
                    switchToAssistant(0);
                }
            } else if (assistantsData.length > 0) {
                switchToAssistant(0);
            } else {
                loadNewAssistantForm();
            }
        } else {
            console.error('Failed to load assistants:', result.error);
        }
    } catch (error) {
        console.error('Error loading assistants:', error);
    }
}

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    loadAssistantsData();
});

// Render assistant tabs
function renderAssistantTabs() {
    const tabsContainer = document.getElementById('assistant-tabs');
    let tabsHtml = '';
    
    // Add existing assistant tabs
    assistantsData.forEach((assistant, index) => {
        const activeClass = index === currentAssistantIndex ? 'active bg-blue-50 border-blue-500 text-blue-700' : 'inactive bg-gray-50 border-gray-300 text-gray-700';
        tabsHtml += `
            <button class="assistant-tab px-4 py-2 border-b-2 ${activeClass} hover:bg-blue-50 transition-colors"
                    onclick="switchToAssistant(${index})">
                ${assistant.name || assistant.id || 'Unknown'}
            </button>
        `;
    });
    
    // Add new assistant tab
    const newAssistantActiveClass = currentAssistantIndex === assistantsData.length ? 'active bg-blue-50 border-blue-500 text-blue-700' : 'inactive bg-gray-50 border-gray-300 text-gray-700';
    tabsHtml += `
        <button class="assistant-tab px-4 py-2 border-b-2 ${newAssistantActiveClass} hover:bg-blue-50 transition-colors"
                onclick="switchToAssistant(${assistantsData.length})">
            â• æ–°å¢åŠ©æ‰‹
        </button>
    `;
    
    tabsContainer.innerHTML = tabsHtml;
}

// Switch to a specific assistant
function switchToAssistant(assistantIndex) {
    currentAssistantIndex = assistantIndex;
    renderAssistantTabs();
    
    // Update URL
    const url = new URL(window.location);
    if (assistantIndex < assistantsData.length) {
        url.searchParams.set('tab', assistantsData[assistantIndex].id);
        // Load existing assistant
        loadAssistantForm(assistantsData[assistantIndex]);
    } else {
        url.searchParams.delete('tab');
        // Load new assistant form
        loadNewAssistantForm();
    }
    window.history.pushState({}, '', url);
}

// Load assistant form
function loadAssistantForm(assistant) {
    const content = document.getElementById('assistant-content');
    const metadataHtml = assistant.metadata ? 
        Object.entries(assistant.metadata).map(([key, value]) => `
            <div class="flex gap-3 metadata-row">
                <input type="text" name="metadata_key" placeholder="é”®" value="${escapeHtml(key)}"
                       class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <input type="text" name="metadata_value" placeholder="å€¼" value="${escapeHtml(value)}"
                       class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <button type="button" onclick="removeMetadataRow(this)" 
                        class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">ğŸ—‘ï¸ åˆ é™¤</button>
            </div>
        `).join('') :
        `
            <div class="flex gap-3 metadata-row">
                <input type="text" name="metadata_key" placeholder="é”®"
                       class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <input type="text" name="metadata_value" placeholder="å€¼"
                       class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <button type="button" onclick="removeMetadataRow(this)" 
                        class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">ğŸ—‘ï¸ åˆ é™¤</button>
            </div>
        `;
    
    const createdTime = assistant.created_at ? formatTimestamp(assistant.created_at) : 'æœªçŸ¥';
    
    content.innerHTML = `
        <div class="max-w-4xl mx-auto space-y-6">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <form id="assistant-form" onsubmit="saveAssistant(event, '${assistant.id}')">
                    
                    <!-- Basic Information -->
                    <div class="space-y-4">
                        <h2 class="text-xl font-semibold text-gray-800">åŸºæœ¬ä¿¡æ¯</h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="name" class="block text-sm font-medium text-gray-700 mb-2">åç§° *</label>
                                <input type="text" id="name" name="name" required
                                       value="${escapeHtml(assistant.name || '')}"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            
                            <div>
                                <label for="model" class="block text-sm font-medium text-gray-700 mb-2">æ¨¡å‹</label>
                                <select id="model" name="model" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="gpt-4o-mini" ${assistant.model === 'gpt-4o-mini' ? 'selected' : ''}>gpt-4o-mini</option>
                                    <option value="gpt-4o" ${assistant.model === 'gpt-4o' ? 'selected' : ''}>gpt-4o</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label for="description" class="block text-sm font-medium text-gray-700 mb-2">æè¿°</label>
                            <textarea id="description" name="description" rows="3"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                      placeholder="åŠ©æ‰‹çš„æè¿°ä¿¡æ¯">${escapeHtml(assistant.description || '')}</textarea>
                        </div>
                    </div>

                    <!-- Instructions -->
                    <div class="space-y-4 mt-8">
                        <h2 class="text-xl font-semibold text-gray-800">ğŸ’¬ æ²Ÿé€šè®¾ç½®</h2>
                        <div>
                            <label for="instructions" class="block text-sm font-medium text-gray-700 mb-2">æŒ‡ä»¤</label>
                            <textarea id="instructions" name="instructions" rows="15"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                      placeholder="è®¾ç½®AIæ¨¡å‹çš„æ²Ÿé€šé£æ ¼å’ŒæŒ‡ä»¤...">${escapeHtml(assistant.instructions || DEFAULT_INSTRUCTIONS)}</textarea>
                            <p class="text-sm text-gray-500 mt-1">ç”¨äºè®¾ç½®AIæ¨¡å‹çš„æ²Ÿé€šé£æ ¼ï¼Œå…¬å¸ä¿¡æ¯éƒ½ä¿å­˜åœ¨"æ²Ÿé€šè®¾ç½®é‡Œé¢"ï¼Œç”¨äºå›ç­”åŠ©æ‰‹çš„é—®é¢˜</p>
                        </div>
                    </div>

                    <!-- Metadata -->
                    <div class="space-y-4 mt-8">
                        <h2 class="text-xl font-semibold text-gray-800">å…ƒæ•°æ® (Metadata)</h2>
                        <p class="text-sm text-gray-500">å¯ç”¨äºä¿å­˜ä¸€äº›é¢å¤–ä¿¡æ¯ï¼Œä¸ç”¨äºAIæ¨¡å‹è¿è¡Œ</p>
                        
                        <div id="metadata-container">
                            <div class="space-y-3" id="metadata-fields">
                                ${metadataHtml}
                            </div>
                            <button type="button" onclick="addMetadataRow()" 
                                    class="mt-3 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                                â• æ·»åŠ å…ƒæ•°æ®
                            </button>
                            <p class="text-sm text-gray-500 mt-2">ğŸ’¡ æç¤ºï¼šè‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªå…ƒæ•°æ®è¡Œ</p>
                        </div>
                    </div>

                    <!-- Assistant Info -->
                    <div class="space-y-4 mt-8">
                        <h2 class="text-xl font-semibold text-gray-800">åŠ©æ‰‹ä¿¡æ¯</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600">
                            <div>
                                <span class="font-medium">åˆ›å»ºæ—¶é—´:</span> 
                                <span id="created-time">${createdTime}</span>
                            </div>
                            <div>
                                <span class="font-medium">ID:</span> 
                                <span class="font-mono">${assistant.id}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Form result -->
                    <div id="form-result"></div>

                    <!-- Action buttons -->
                    <div class="flex gap-4 mt-8 pt-6 border-t">
                        <button type="submit" 
                                class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                            ğŸ’¾ ä¿å­˜
                        </button>
                        
                        <button type="button" onclick="deleteAssistant('${assistant.id}')" 
                                class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium">
                            ğŸ—‘ï¸ åˆ é™¤åŠ©æ‰‹
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;
}

// Load new assistant form
function loadNewAssistantForm() {
    const content = document.getElementById('assistant-content');
    content.innerHTML = `
        <div class="max-w-4xl mx-auto space-y-6">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <form id="assistant-form" onsubmit="createAssistant(event)">
                    
                    <!-- Basic Information -->
                    <div class="space-y-4">
                        <h2 class="text-xl font-semibold text-gray-800">åŸºæœ¬ä¿¡æ¯</h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="name" class="block text-sm font-medium text-gray-700 mb-2">åç§° *</label>
                                <input type="text" id="name" name="name" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            
                            <div>
                                <label for="model" class="block text-sm font-medium text-gray-700 mb-2">æ¨¡å‹</label>
                                <select id="model" name="model" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="gpt-4o-mini" selected>gpt-4o-mini</option>
                                    <option value="gpt-4o">gpt-4o</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label for="description" class="block text-sm font-medium text-gray-700 mb-2">æè¿°</label>
                            <textarea id="description" name="description" rows="3"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                      placeholder="åŠ©æ‰‹çš„æè¿°ä¿¡æ¯"></textarea>
                        </div>
                    </div>

                    <!-- Instructions -->
                    <div class="space-y-4 mt-8">
                        <h2 class="text-xl font-semibold text-gray-800">ğŸ’¬ æ²Ÿé€šè®¾ç½®</h2>
                        <div>
                            <label for="instructions" class="block text-sm font-medium text-gray-700 mb-2">æŒ‡ä»¤</label>
                            <textarea id="instructions" name="instructions" rows="15"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                      placeholder="è®¾ç½®AIæ¨¡å‹çš„æ²Ÿé€šé£æ ¼å’ŒæŒ‡ä»¤...">${DEFAULT_INSTRUCTIONS}</textarea>
                            <p class="text-sm text-gray-500 mt-1">ç”¨äºè®¾ç½®AIæ¨¡å‹çš„æ²Ÿé€šé£æ ¼ï¼Œå…¬å¸ä¿¡æ¯éƒ½ä¿å­˜åœ¨"æ²Ÿé€šè®¾ç½®é‡Œé¢"ï¼Œç”¨äºå›ç­”åŠ©æ‰‹çš„é—®é¢˜</p>
                        </div>
                    </div>

                    <!-- Metadata -->
                    <div class="space-y-4 mt-8">
                        <h2 class="text-xl font-semibold text-gray-800">å…ƒæ•°æ® (Metadata)</h2>
                        <p class="text-sm text-gray-500">å¯ç”¨äºä¿å­˜ä¸€äº›é¢å¤–ä¿¡æ¯ï¼Œä¸ç”¨äºAIæ¨¡å‹è¿è¡Œ</p>
                        
                        <div id="metadata-container">
                            <div class="space-y-3" id="metadata-fields">
                                <div class="flex gap-3 metadata-row">
                                    <input type="text" name="metadata_key" placeholder="é”®"
                                           class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <input type="text" name="metadata_value" placeholder="å€¼"
                                           class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <button type="button" onclick="removeMetadataRow(this)" 
                                            class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">ğŸ—‘ï¸ åˆ é™¤</button>
                                </div>
                            </div>
                            <button type="button" onclick="addMetadataRow()" 
                                    class="mt-3 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                                â• æ·»åŠ å…ƒæ•°æ®
                            </button>
                            <p class="text-sm text-gray-500 mt-2">ğŸ’¡ æç¤ºï¼šè‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªå…ƒæ•°æ®è¡Œ</p>
                        </div>
                    </div>

                    <!-- Form result -->
                    <div id="form-result"></div>

                    <!-- Action buttons -->
                    <div class="flex gap-4 mt-8 pt-6 border-t">
                        <button type="submit" 
                                class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                            âœ¨ åˆ›å»º
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;
}

// Save assistant (update)
async function saveAssistant(event, assistantId) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    
    // Build metadata object
    const metadata = {};
    const keys = formData.getAll('metadata_key');
    const values = formData.getAll('metadata_value');
    
    for (let i = 0; i < keys.length; i++) {
        const key = keys[i]?.trim();
        const value = values[i]?.trim();
        if (key && value) {
            metadata[key] = value;
        }
    }
    
    const payload = {
        name: formData.get('name'),
        model: formData.get('model'),
        description: formData.get('description') || '',
        instructions: formData.get('instructions'),
        metadata: metadata
    };
    
    try {
        const response = await fetch(`/assistants/${assistantId}/update`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams(Object.entries(payload).flatMap(([k, v]) => 
                k === 'metadata' ? 
                    Object.entries(v).flatMap(([mk, mv]) => [
                        ['metadata_key', mk],
                        ['metadata_value', mv]
                    ]) :
                    [[k, v]]
            ))
        });
        
        const result = await response.json();
        if (result.success) {
            alert('åŠ©æ‰‹å·²æ›´æ–°');
            loadAssistantsData();
        } else {
            document.getElementById('form-result').innerHTML = 
                `<div class="mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded">${result.error}</div>`;
        }
    } catch (error) {
        document.getElementById('form-result').innerHTML = 
            `<div class="mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded">æ›´æ–°å¤±è´¥: ${error.message}</div>`;
    }
}

// Create assistant
async function createAssistant(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    
    // Build metadata object
    const metadata = {};
    const keys = formData.getAll('metadata_key');
    const values = formData.getAll('metadata_value');
    
    for (let i = 0; i < keys.length; i++) {
        const key = keys[i]?.trim();
        const value = values[i]?.trim();
        if (key && value) {
            metadata[key] = value;
        }
    }
    
    const payload = {
        name: formData.get('name'),
        model: formData.get('model'),
        description: formData.get('description') || '',
        instructions: formData.get('instructions'),
        metadata: metadata
    };
    
    try {
        const response = await fetch('/assistants/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams(Object.entries(payload).flatMap(([k, v]) => 
                k === 'metadata' ? 
                    Object.entries(v).flatMap(([mk, mv]) => [
                        ['metadata_key', mk],
                        ['metadata_value', mv]
                    ]) :
                    [[k, v]]
            ))
        });
        
        const result = await response.json();
        if (result.success) {
            alert('åŠ©æ‰‹å·²åˆ›å»º');
            loadAssistantsData();
        } else {
            document.getElementById('form-result').innerHTML = 
                `<div class="mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded">${result.error}</div>`;
        }
    } catch (error) {
        document.getElementById('form-result').innerHTML = 
            `<div class="mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded">åˆ›å»ºå¤±è´¥: ${error.message}</div>`;
    }
}

// Delete assistant
async function deleteAssistant(assistantId) {
    if (!confirm('âš ï¸ æ‚¨ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåŠ©æ‰‹å—ï¼Ÿ\næ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼')) {
        return;
    }
    
    try {
        const response = await fetch(`/assistants/${assistantId}/delete`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        if (result.success) {
            alert('åŠ©æ‰‹å·²åˆ é™¤');
            loadAssistantsData();
        } else {
            alert('åˆ é™¤å¤±è´¥: ' + result.error);
        }
    } catch (error) {
        alert('åˆ é™¤å¤±è´¥: ' + error.message);
    }
}

// Add metadata row
function addMetadataRow() {
    const container = document.getElementById('metadata-fields');
    const row = document.createElement('div');
    row.className = 'flex gap-3 metadata-row';
    row.innerHTML = `
        <input type="text" name="metadata_key" placeholder="é”®"
               class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        <input type="text" name="metadata_value" placeholder="å€¼"
               class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        <button type="button" onclick="removeMetadataRow(this)" 
                class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">ğŸ—‘ï¸ åˆ é™¤</button>
    `;
    container.appendChild(row);
}

// Remove metadata row
function removeMetadataRow(button) {
    const row = button.closest('.metadata-row');
    if (row) {
        const allRows = document.querySelectorAll('.metadata-row');
        if (allRows.length <= 1) {
            alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªå…ƒæ•°æ®è¡Œ');
            return;
        }
        row.style.opacity = '0.5';
        row.style.transition = 'opacity 0.3s ease';
        setTimeout(() => {
            row.remove();
        }, 300);
    }
}

// Utility functions
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatTimestamp(timestamp) {
    if (!timestamp) return 'æœªçŸ¥';
    try {
        const date = new Date(timestamp * 1000);
        return date.toLocaleString('zh-CN');
    } catch {
        return 'æœªçŸ¥';
    }
}
</script>
{% endblock %}
