{% extends "base.html" %}

{% block title %}è‡ªåŠ¨åŒ–å·¥ä½œæµ - BOSSæ‹›è˜åŠ©æ‰‹{% endblock %}

{% block content %}
<div x-data="automationControl()" x-init="initSSE()" class="space-y-6">
    <!-- Page header -->
    <div class="bg-white rounded-lg shadow p-6">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">è‡ªåŠ¨åŒ–å·¥ä½œæµ</h1>
        <p class="text-gray-600">é…ç½®å¹¶å¯åŠ¨è‡ªåŠ¨åŒ–æ‹›è˜æµç¨‹ï¼Œå®æ—¶ç›‘æ§æ‰§è¡ŒçŠ¶æ€</p>
    </div>
    
    <!-- Tunnel URL info panel -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg shadow p-4 mb-6">
        <div class="flex items-center justify-between">
            <div class="flex-1">
                <h3 class="text-lg font-semibold text-blue-900 mb-2">ğŸŒ è¿œç¨‹è®¿é—® URL</h3>
                <p class="text-sm text-blue-700 mb-3">
                    å°†æ­¤ URL æä¾›ç»™è¿œç¨‹ LangGraph Agent æœåŠ¡ä»¥è®¿é—®æ­¤ APIï¼š
                </p>
                <div class="flex items-center space-x-2" x-show="tunnelUrl">
                    <input type="text" 
                           :value="tunnelUrl" 
                           readonly
                           id="tunnel-url-input"
                           class="flex-1 px-4 py-2 bg-white border border-blue-300 rounded-lg font-mono text-sm text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button @click="copyTunnelUrl()"
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition">
                        ğŸ“‹ å¤åˆ¶
                    </button>
                </div>
                <div x-show="!tunnelUrl" class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                    <p class="text-sm text-yellow-800 mb-2">âš ï¸ æœªæ£€æµ‹åˆ° Cloudflare Tunnel URLã€‚</p>
                    <div class="flex items-center space-x-2">
                        <button @click="startTunnel()"
                                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition">
                            ğŸš€ å¯åŠ¨ Cloudflare Tunnel
                        </button>
                        <span class="text-xs text-yellow-700">éœ€è¦æœ¬æœºå·²å®‰è£… cloudflared</span>
                    </div>
                    <div class="text-xs text-yellow-700 mt-2">
                        æˆ–è€…ä½¿ç”¨æœ¬åœ° URL: <code class="bg-yellow-100 px-1 rounded">http://127.0.0.1:5001</code>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Configuration panel -->
    <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">å·¥ä½œæµé…ç½®</h2>
        
        <form id="automation-form">
            <!-- Workflow selection -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <label class="flex items-center space-x-3 p-4 border rounded-lg cursor-pointer hover:bg-blue-50 transition">
                    <input type="checkbox" name="enable_recommend" value="true" class="w-5 h-5">
                    <span class="font-medium">â­ æ¨èç‰›äºº</span>
                </label>
                
                <label class="flex items-center space-x-3 p-4 border rounded-lg cursor-pointer hover:bg-blue-50 transition">
                    <input type="checkbox" name="enable_new_chats" value="true" checked class="w-5 h-5">
                    <span class="font-medium">ğŸ’¬ æ–°æ‹›å‘¼</span>
                </label>
                
                <label class="flex items-center space-x-3 p-4 border rounded-lg cursor-pointer hover:bg-blue-50 transition">
                    <input type="checkbox" name="enable_active_chats" value="true" class="w-5 h-5">
                    <span class="font-medium">ğŸ”¥ æ²Ÿé€šä¸­</span>
                </label>
                
                <label class="flex items-center space-x-3 p-4 border rounded-lg cursor-pointer hover:bg-blue-50 transition">
                    <input type="checkbox" name="enable_followups" value="true" class="w-5 h-5">
                    <span class="font-medium">â° è¿½ç»“æœ</span>
                </label>
            </div>
            
            <!-- Job and thresholds -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">å²—ä½</label>
                    <select name="job_id" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                            hx-get="/jobs/list-simple" hx-trigger="load" hx-swap="innerHTML">
                        <option>åŠ è½½ä¸­...</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Borderline (åŠæ ¼çº¿)
                        <span class="text-xs text-gray-500">â‰¥ æ­¤åˆ†æ•°è¡¨ç¤ºå…´è¶£</span>
                    </label>
                    <input type="number" name="threshold_borderline" value="7.0" min="1" max="10" step="0.5"
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Seek (å¼ºåŒ¹é…é˜ˆå€¼)
                        <span class="text-xs text-gray-500">â‰¥ æ­¤åˆ†æ•°è¦æ±‚è”ç³»æ–¹å¼</span>
                    </label>
                    <input type="number" name="threshold_seek" value="9.0" min="1" max="10" step="0.5"
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            
            <!-- Candidate limit -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">å¤„ç†æ•°é‡é™åˆ¶</label>
                <input type="number" name="limit" value="20" min="5" max="100" step="5"
                       class="w-64 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>
        </form>
        
        <!-- Control buttons -->
        <div class="flex space-x-4">
            <button @click="startAutomation()"
                    :disabled="isRunning"
                    :class="isRunning ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700'"
                    class="px-6 py-3 text-white rounded-lg font-medium transition">
                â–¶ï¸ å¯åŠ¨
            </button>
            
            <button @click="nextStep()"
                    :disabled="!isRunning || !isPaused"
                    :class="(!isRunning || !isPaused) ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'"
                    class="px-6 py-3 text-white rounded-lg font-medium transition">
                â­ï¸ ä¸‹ä¸€æ­¥
            </button>
            
            <button @click="pauseAutomation()"
                    :disabled="!isRunning || isPaused"
                    :class="(!isRunning || isPaused) ? 'bg-gray-400 cursor-not-allowed' : 'bg-yellow-600 hover:bg-yellow-700'"
                    class="px-6 py-3 text-white rounded-lg font-medium transition">
                â¸ï¸ æš‚åœ
            </button>
            
            <button @click="stopAutomation()"
                    :disabled="!isRunning"
                    :class="!isRunning ? 'bg-gray-400 cursor-not-allowed' : 'bg-red-600 hover:bg-red-700'"
                    class="px-6 py-3 text-white rounded-lg font-medium transition">
                â¹ï¸ åœæ­¢
            </button>
            
            <button @click="clearEvents()"
                    class="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition">
                ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—
            </button>
        </div>
        
        <!-- Status indicator -->
        <div class="mt-4 flex items-center space-x-3">
            <div class="flex items-center space-x-2">
                <div :class="isRunning ? 'bg-green-500 animate-pulse' : 'bg-gray-400'" 
                     class="w-3 h-3 rounded-full"></div>
                <span class="text-sm font-medium text-gray-700">
                    çŠ¶æ€: <span x-text="isRunning ? (isPaused ? 'å·²æš‚åœ' : 'è¿è¡Œä¸­') : 'å·²åœæ­¢'"></span>
                </span>
            </div>
            <div class="text-sm text-gray-600">
                äº‹ä»¶æ•°: <span x-text="events.length"></span>
            </div>
        </div>
    </div>
    
    <!-- Event stream log -->
    <div class="bg-gray-900 rounded-lg shadow-lg p-4">
        <div class="flex justify-between items-center mb-2">
            <h2 class="text-lg font-bold text-green-400">å®æ—¶äº‹ä»¶æ—¥å¿—</h2>
            <div class="text-sm text-gray-400">è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨</div>
        </div>
        
        <div id="event-log" 
             class="event-log h-96 overflow-y-auto bg-black rounded p-4 font-mono text-sm space-y-1">
            <template x-for="event in events" :key="event.timestamp">
                <div :class="getEventClass(event.level)" class="flex space-x-2">
                    <span class="text-gray-500" x-text="event.timestamp.substring(11, 19)"></span>
                    <span x-text="event.message"></span>
                </div>
            </template>
            
            <div x-show="events.length === 0" class="text-gray-500 text-center py-12">
                ç­‰å¾…å¯åŠ¨å·¥ä½œæµ...
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Automation control methods
function automationControl() {
    return {
        events: [],
        eventSource: null,
        isRunning: false,
        isPaused: false,
        tunnelUrl: "{{ tunnel_url|tojson|safe }}" || null,

        initSSE() {
            // SSE connection will be established when automation starts
            console.log('Automation control initialized');
            
            // Fetch tunnel URL from API if not already set
            if (!this.tunnelUrl) {
                this.fetchTunnelUrl();
            }
        },
        
        async fetchTunnelUrl() {
            try {
                const response = await fetch('/automation/tunnel-url');
                const data = await response.json();
                if (data.tunnel_url) {
                    this.tunnelUrl = data.tunnel_url;
                }
            } catch (error) {
                console.error('Failed to fetch tunnel URL:', error);
            }
        },
        
        async startTunnel() {
            try {
                const response = await fetch('/automation/tunnel/start', { method: 'POST' });
                const data = await response.json();
                if (data.success && data.tunnel_url) {
                    this.tunnelUrl = data.tunnel_url;
                    showToast('Cloudflare Tunnel å·²å¯åŠ¨', 'success');
                } else {
                    showToast('å¯åŠ¨å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                showToast('å¯åŠ¨å¤±è´¥: ' + error.message, 'error');
            }
        },
        
        copyTunnelUrl() {
            const input = document.getElementById('tunnel-url-input');
            if (input) {
                input.select();
                document.execCommand('copy');
                showToast('URL å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            }
        },
        
        startAutomation() {
            const form = document.getElementById('automation-form');
            const formData = new FormData(form);
            
            // Post to start endpoint
            fetch('/automation/start', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.isRunning = true;
                    this.isPaused = false;
                    this.connectSSE();
                    showToast('å·¥ä½œæµå·²å¯åŠ¨', 'success');
                } else {
                    showToast('å¯åŠ¨å¤±è´¥: ' + data.error, 'error');
                }
            })
            .catch(err => {
                showToast('å¯åŠ¨å¤±è´¥: ' + err.message, 'error');
            });
        },
        
        connectSSE() {
            if (this.eventSource) {
                this.eventSource.close();
            }
            
            this.eventSource = new EventSource('/automation/stream');
            
            this.eventSource.onmessage = (e) => {
                const event = JSON.parse(e.data);
                this.events.push(event);
                
                // Auto-scroll to bottom
                this.$nextTick(() => {
                    const log = document.getElementById('event-log');
                    if (log) {
                        log.scrollTop = log.scrollHeight;
                    }
                });
                
                // Keep only last 1000 events
                if (this.events.length > 1000) {
                    this.events = this.events.slice(-1000);
                }
                
                // Check for completion/stop events
                if (event.message.includes('å·¥ä½œæµå·²å®Œæˆ') || event.message.includes('å·¥ä½œæµå·²åœæ­¢')) {
                    this.isRunning = false;
                    this.isPaused = false;
                    this.eventSource.close();
                }
            };
            
            this.eventSource.onerror = (e) => {
                console.error('SSE Error:', e);
                this.isRunning = false;
                this.isPaused = false;
                if (this.eventSource) {
                    this.eventSource.close();
                }
            };
        },
        
        pauseAutomation() {
            fetch('/automation/pause', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        this.isPaused = true;
                        showToast('å·¥ä½œæµå·²æš‚åœ', 'info');
                    }
                });
        },
        
        nextStep() {
            fetch('/automation/next', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('å¤„ç†ä¸‹ä¸€ä¸ªå€™é€‰äºº', 'info');
                    }
                });
        },
        
        stopAutomation() {
            fetch('/automation/stop', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        this.isRunning = false;
                        this.isPaused = false;
                        if (this.eventSource) {
                            this.eventSource.close();
                        }
                        showToast('å·¥ä½œæµå·²åœæ­¢', 'warning');
                    }
                });
        },
        
        clearEvents() {
            this.events = [];
        },
        
        getEventClass(level) {
            const classes = {
                'info': 'event-info',
                'warning': 'event-warning',
                'error': 'event-error',
                'success': 'event-success'
            };
            return classes[level] || 'event-info';
        }
    };
}
</script>
{% endblock %}

