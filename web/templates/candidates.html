{% extends "base.html" %}

{% block title %}å€™é€‰äººç®¡ç† - BOSSæ‹›è˜åŠ©æ‰‹{% endblock %}

{% block content %}

<div x-data="candidateTabs()" x-init="init()" class="space-y-6">
    <!-- Page header with controls -->
    <div class="bg-white rounded-lg shadow p-6">
        <!-- <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">å€™é€‰äººç®¡ç†</h1>
            <button onclick="location.reload()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition">
                ğŸ”„ åˆ·æ–°
            </button>
        </div> -->
        
        <!-- Tab switcher -->
        <div class="flex space-x-2 border-b mb-4" id="tab-buttons">
            <button 
                @click="switchTab('recommend')"
                data-tab="recommend"
                :class="activeTab === 'recommend' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'"
                class="tab-btn px-4 py-3 font-medium hover:text-blue-600 transition">
                â­ æ¨èç‰›äºº
            </button>
            <button 
                @click="switchTab('greet')"
                data-tab="greet"
                :class="activeTab === 'greet' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'"
                class="tab-btn px-4 py-3 font-medium hover:text-blue-600 transition">
                ğŸ‘‹ æ–°æ‹›å‘¼
            </button>
            <button 
                @click="switchTab('chat')"
                data-tab="chat"
                :class="activeTab === 'chat' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'"
                class="tab-btn px-4 py-3 font-medium hover:text-blue-600 transition">
                ğŸ’¬ æ²Ÿé€šä¸­
            </button>
            <button 
                @click="switchTab('followup')"
                data-tab="followup"
                :class="activeTab === 'followup' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'"
                class="tab-btn px-4 py-3 font-medium hover:text-blue-600 transition">
                ğŸ“­ ç‰›äººå·²è¯»æœªå›
            </button>
        </div>
        
        <!-- Filters -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">å²—ä½</label>
                <select id="job-selector" name="job_id" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                        hx-get="/jobs/list-simple" hx-trigger="load" hx-swap="innerHTML"
                        hx-on::after-swap="window.updateCandidateURL && window.updateCandidateURL()"
                        @change="updateURL()">
                    <option>åŠ è½½ä¸­...</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    æ²Ÿé€šé˜ˆå€¼
                    <span class="text-xs text-gray-500">â‰¥ æ­¤åˆ†æ•°ç”Ÿæˆæ¶ˆæ¯</span>
                </label>
                <input type="number" id="threshold-chat" name="threshold_chat" 
                       value="5.0" 
                       min="1" max="10" step="0.5"
                       @change="updateURL()"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                     åŠæ ¼çº¿
                    <span class="text-xs text-gray-500">â‰¥ æ­¤åˆ†æ•°è¡¨ç¤ºå…´è¶£</span>
                </label>
                <input type="number" id="threshold-borderline" name="threshold_borderline" 
                       value="7.0" 
                       min="1" max="10" step="0.5"
                       @change="updateURL()"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    å¼ºåŒ¹é…é˜ˆå€¼
                    <span class="text-xs text-gray-500">â‰¥ æ­¤åˆ†æ•°è¦æ±‚è”ç³»æ–¹å¼</span>
                </label>
                <input type="number" id="threshold-seek" name="threshold_seek" 
                       value="9.0" 
                       min="1" max="10" step="0.5"
                       @change="updateURL()"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
        </div>
    </div>
    
    <!-- Main content area: List + Detail -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        <!-- Candidate list (left sidebar) -->
        <div class="lg:col-span-4">
            <div class="bg-white rounded-lg shadow-lg h-[1000px] overflow-y-auto">
                <!-- Batch analyze button (hidden initially) -->
                <div class="p-4 pb-0">
                    <div class="relative">
                        <button 
                            id="batch-analyze-btn"
                            onclick="if (typeof processAllCandidates === 'function') { processAllCandidates(); } else { showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå€™é€‰äººä»¥åŠ è½½æ‰¹å¤„ç†åŠŸèƒ½', 'warning'); }"
                            class="hidden w-full px-4 py-2 mb-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                            <span>å…¨éƒ¨åˆ†æ</span>
                            <span 
                                class="info-icon cursor-help text-white/80 hover:text-white"
                                title="æ‰¹å¤„ç†æµç¨‹è¯´æ˜"
                                data-tooltip="æ‰¹å¤„ç†å°†æŒ‰ä»¥ä¸‹æ­¥éª¤è‡ªåŠ¨å¤„ç†æ¯ä¸ªå€™é€‰äººï¼š\n1. åŠ è½½åœ¨çº¿ç®€å†ï¼ˆå¦‚æœªåŠ è½½ï¼‰\n2. åˆå§‹åŒ–å¯¹è¯ï¼ˆå¦‚æœªåˆå§‹åŒ–ï¼‰\n3. è¿›è¡ŒAIåˆ†æï¼ˆå¦‚æœªåˆ†æï¼‰\n4. æ ¹æ®åŒ¹é…åº¦é˜ˆå€¼ï¼š\n   - è¾¾åˆ°æ²Ÿé€šé˜ˆå€¼ï¼šç”Ÿæˆæ¶ˆæ¯\n   - è¾¾åˆ°åŠæ ¼çº¿ï¼šè·å–å®Œæ•´ç®€å†å¹¶é‡æ–°åˆ†æï¼ˆæ²Ÿé€šä¸­æ¨¡å¼ï¼‰æˆ–å‘é€æ‹›å‘¼ï¼ˆæ¨èæ¨¡å¼ï¼‰\n5. æ›´æ–°å€™é€‰äººå¡ç‰‡çŠ¶æ€"
                                onmouseenter="showBatchInfoTooltip(event)"
                                onmouseleave="hideBatchInfoTooltip()">
                                â„¹ï¸
                            </span>
                        </button>
                    </div>
                </div>
                <div id="candidate-list" class="p-4 space-y-2">
                    <!-- Initial message -->
                    <div id="initial-message" class="text-center text-gray-500 py-12">
                        ç‚¹å‡»ä¸‹æ–¹"æŸ¥è¯¢å€™é€‰äºº"æŒ‰é’®åŠ è½½æ•°æ®
                    </div>
                    <!-- Candidates will be appended here -->
                </div>
                
                <!-- Load more button at bottom of list -->
                <div class="p-4 border-t bg-gray-50">
                    <div class="flex gap-2 items-end">
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ•°é‡é™åˆ¶</label>
                            <input 
                                type="number" 
                                id="limit-input" 
                                name="limit" 
                                value="50" 
                                min="1" 
                                max="999" 
                                step="1"
                                @change="updateURL()"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    <button 
                        @click="loadCandidates()"
                        id="load-more-btn"
                        :disabled="loading"
                        :class="loading ? 'opacity-50 cursor-not-allowed' : ''"
                            class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        <span x-text="loading ? 'â³ åŠ è½½ä¸­...' : 'ğŸ” æŸ¥è¯¢å€™é€‰äºº'"></span>
                    </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Candidate detail (right panel) -->
        <div class="lg:col-span-8">
            <div id="detail-pane" class="bg-white rounded-lg shadow-lg p-6">
                <!-- Will be populated when candidate is selected -->
                <div class="text-center text-gray-500 py-24">
                    <div class="text-6xl mb-4">ğŸ‘¤</div>
                    <p class="text-lg">è¯·ä»å·¦ä¾§åˆ—è¡¨ä¸­é€‰æ‹©å€™é€‰äºº</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- All candidate logic is now handled by Alpine.js in app.js via candidateTabs() -->

<script>
// Candidate list page logic is now centralized in candidate_detail.html

// Tooltip for batch analyze button
let batchTooltip = null;

function showBatchInfoTooltip(event) {
    const target = event.currentTarget;
    const tooltipText = target.getAttribute('data-tooltip');
    
    // Remove existing tooltip if any
    if (batchTooltip) {
        batchTooltip.remove();
    }
    
    // Create tooltip element
    batchTooltip = document.createElement('div');
    batchTooltip.className = 'fixed z-50 bg-gray-900 text-white text-sm rounded-lg shadow-lg p-3 max-w-sm pointer-events-none';
    batchTooltip.style.whiteSpace = 'pre-line';
    batchTooltip.style.lineHeight = '1.6';
    // Replace \n with actual newlines
    batchTooltip.textContent = tooltipText.replace(/\\n/g, '\n');
    document.body.appendChild(batchTooltip);
    
    // Position tooltip
    const rect = target.getBoundingClientRect();
    batchTooltip.style.left = `${rect.right + 10}px`;
    batchTooltip.style.top = `${rect.top}px`;
    
    // Adjust if tooltip goes off screen
    setTimeout(() => {
        if (batchTooltip) {
            const tooltipRect = batchTooltip.getBoundingClientRect();
            if (tooltipRect.right > window.innerWidth) {
                batchTooltip.style.left = `${rect.left - tooltipRect.width - 10}px`;
            }
            if (tooltipRect.bottom > window.innerHeight) {
                batchTooltip.style.top = `${window.innerHeight - tooltipRect.height - 10}px`;
            }
        }
    }, 0);
}

function hideBatchInfoTooltip() {
    if (batchTooltip) {
        batchTooltip.remove();
        batchTooltip = null;
    }
}
</script>
{% endblock %}

