{% extends "base.html" %}

{% block title %}候选人管理 - BOSS招聘助手{% endblock %}

{% block content %}

<!-- Troubleshooting Modal -->
<div x-data="{ 
        showTroubleshooting: false,
        contentKey: 'candidates-troubleshooting',
        content: '如果出现问题，请按照下面流程排查：\n1. 请查看boss页面是否正常\n2. 刷新页面\n3. 查看终端（terminal）的提示，是否有错误\n4. 如终端有错误，复制终端错误并问问cursor或者尝试用cursor修复\n5. 将cursor的回答发送到群里让工程师修复',
        init() {
            // Use hash-based notification system
            if (typeof window.shouldShowNotification === 'function') {
                this.showTroubleshooting = window.shouldShowNotification(this.contentKey, this.content);
            }
            if (this.showTroubleshooting) {
                this.$el.style.display = 'flex';
            }
        },
        dismiss() {
            if (typeof window.acknowledgeNotification === 'function') {
                window.acknowledgeNotification(this.contentKey, this.content);
            }
            this.showTroubleshooting = false;
        }
     }" 
     x-show="showTroubleshooting"
     x-transition:enter="transition ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="transition ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0"
     class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
     style="display: none;">
    <div class="bg-white rounded-lg shadow-2xl max-w-md w-full mx-4"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform scale-95"
         x-transition:enter-end="opacity-100 transform scale-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100 transform scale-100"
         x-transition:leave-end="opacity-0 transform scale-95">
        <div class="p-6">
            <div class="flex items-center mb-4">
                <div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center mr-3">
                    <span class="text-2xl">⚠️</span>
                </div>
                <h3 class="text-xl font-bold text-gray-800">问题排查提示</h3>
            </div>
            <div class="mb-6">
                <p class="text-gray-700 leading-relaxed whitespace-pre-line" x-text="content"></p>
            </div>
            <div class="flex justify-end">
                <button @click="dismiss()"
                        class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                    已知晓
                </button>
            </div>
        </div>
    </div>
</div>

<div x-data="candidateTabs()" x-init="init()" class="space-y-6">
    <!-- Page header with controls -->
    <div class="bg-white rounded-lg shadow p-6">
        <!-- <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">候选人管理</h1>
            <button onclick="location.reload()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition">
                🔄 刷新
            </button>
        </div> -->
        
        <!-- Tab switcher with batch analyze button -->
        <div class="flex justify-between items-center border-b mb-4">
            <div class="flex space-x-2" id="tab-buttons">
            <button 
                @click="switchTab('recommend')"
                data-tab="recommend"
                :class="activeTab === 'recommend' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'"
                class="tab-btn px-4 py-3 font-medium hover:text-blue-600 transition">
                ⭐ 推荐牛人
            </button>
            <button 
                @click="switchTab('greet')"
                data-tab="greet"
                :class="activeTab === 'greet' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'"
                class="tab-btn px-4 py-3 font-medium hover:text-blue-600 transition">
                👋 新招呼
            </button>
            <button 
                @click="switchTab('chat')"
                data-tab="chat"
                :class="activeTab === 'chat' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'"
                class="tab-btn px-4 py-3 font-medium hover:text-blue-600 transition">
                💬 沟通中
            </button>
            <button 
                @click="switchTab('followup')"
                data-tab="followup"
                :class="activeTab === 'followup' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'"
                class="tab-btn px-4 py-3 font-medium hover:text-blue-600 transition">
                📭 牛人已读未回
            </button>
            </div>
            <!-- Top-right controls: Auto-send checkbox and Process button -->
            <div class="flex items-center gap-4">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" id="auto-send-checkbox" checked class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <span class="text-sm text-gray-700 font-medium">自动发送</span>
                </label>
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" id="process-all-modes-checkbox" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <span class="text-sm text-gray-700 font-medium">处理所有模式</span>
                </label>
                <button 
                    id="cycle-reply-btn"
                    onclick="startCycleReply()"
                    title="处理候选人：&#10;&#10;• 未勾选"处理所有模式"：只处理当前模式的候选人&#10;• 勾选"处理所有模式"：自动循环处理所有4个模式（推荐牛人、新招呼、沟通中、牛人已读未回）&#10;&#10;处理流程：&#10;1. 加载在线简历（如未加载）&#10;2. 初始化对话（如未初始化）&#10;3. 进行AI分析（如未分析）&#10;4. 根据匹配度阈值生成消息或发送招呼&#10;5. 更新候选人卡片状态&#10;&#10;提示：确保已选择岗位并设置好阈值参数"
                    class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
                    🔄 开始处理
                </button>
            </div>
        </div>
        
        <!-- Filters -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">岗位</label>
                <select id="job-selector" name="job_id" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                        hx-get="/jobs/list-simple" hx-trigger="load" hx-swap="innerHTML"
                        hx-on::after-swap="window.updateCandidateURL && window.updateCandidateURL()"
                        @change="updateURL()">
                    <option>加载中...</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    沟通阈值
                    <span class="text-xs text-gray-500">≥ 此分数生成消息</span>
                </label>
                <input type="number" id="threshold-chat" name="threshold_chat" 
                       value="6.0" 
                       min="1" max="10" step="0.5"
                       @change="updateURL()"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                     及格线
                    <span class="text-xs text-gray-500">≥ 此分数表示兴趣</span>
                </label>
                <input type="number" id="threshold-borderline" name="threshold_borderline" 
                       value="7.0" 
                       min="1" max="10" step="0.5"
                       @change="updateURL()"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    强匹配阈值
                    <span class="text-xs text-gray-500">≥ 此分数要求联系方式</span>
                </label>
                <input type="number" id="threshold-seek" name="threshold_seek" 
                       value="8.0" 
                       min="1" max="10" step="0.5"
                       @change="updateURL()"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
        </div>
    </div>
    
    <!-- Main content area: List + Detail -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        <!-- Candidate list (left sidebar) -->
        <div class="lg:col-span-4">
            <div class="bg-white rounded-lg shadow-lg h-[1000px] overflow-y-auto">
                <div id="candidate-list" class="p-4 space-y-2">
                    <!-- Initial message -->
                    <div id="initial-message" class="text-center text-gray-500 py-12">
                        点击下方"查询候选人"按钮加载数据
                    </div>
                    <!-- Candidates will be appended here -->
                </div>
                
                <!-- Load more button at bottom of list -->
                <div class="p-4 border-t bg-gray-50">
                    <div class="flex gap-2 items-end">
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">数量限制</label>
                            <input 
                                type="number" 
                                id="limit-input" 
                                name="limit" 
                                value="50" 
                                min="1" 
                                max="999" 
                                step="1"
                                @change="updateURL()"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    <button 
                        @click="loadCandidates()"
                        id="load-more-btn"
                        :disabled="loading"
                        :class="loading ? 'opacity-50 cursor-not-allowed' : ''"
                            class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        <span x-text="loading ? '⏳ 加载中...' : '🔍 查询候选人'"></span>
                    </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Candidate detail (right panel) -->
        <div class="lg:col-span-8">
            <div id="detail-pane" class="bg-white rounded-lg shadow-lg p-6">
                <!-- Will be populated when candidate is selected -->
                <div class="text-center text-gray-500 py-24">
                    <div class="text-6xl mb-4">👤</div>
                    <p class="text-lg">请从左侧列表中选择候选人</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}