{% extends "base.html" %}

{% block title %}é¦–é¡µ - Stardustæ‹›è˜åŠ©æ‰‹{% endblock %}

{% block content %}
<!-- Warning Modal -->
<div x-data="{ 
        showWarning: false,
        contentKey: 'homepage-warning',
        content: 'è¯·æ³¨æ„ï¼Œæ‰€æœ‰çš„è¯·æ±‚éƒ½æ¨¡æ‹Ÿäººå·¥åŠ¨ä½œï¼Œä¸ä¼šæš´éœ²ä»»ä½•å¤–æŒ‚ä¿¡æ¯ã€‚å¦‚æœè¢«å°ï¼Œè”ç³»å®¢æœä¸€å®šä¸æ‰¿è®¤ä½¿ç”¨å¤–æŒ‚ï¼Œè€Œæ˜¯åšå†³è¡¨è¾¾æ˜¯åå°çš„è¯¯åˆ¤ã€‚',
        init() {
            // Use hash-based notification system
            if (typeof window.shouldShowNotification === 'function') {
                this.showWarning = window.shouldShowNotification(this.contentKey, this.content);
            } else {
                // Fallback to old behavior if function not available
            this.showWarning = localStorage.getItem('warningAcknowledged') !== 'true';
            }
            if (this.showWarning) {
                this.$el.style.display = 'flex';
            }
        },
        dismiss() {
            if (typeof window.acknowledgeNotification === 'function') {
                window.acknowledgeNotification(this.contentKey, this.content);
            } else {
                // Fallback to old behavior
                localStorage.setItem('warningAcknowledged', 'true');
            }
            this.showWarning = false;
        }
     }" 
     x-show="showWarning"
     x-transition:enter="transition ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="transition ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0"
     class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
     style="display: none;">
    <div class="bg-white rounded-lg shadow-2xl max-w-md w-full mx-4"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform scale-95"
         x-transition:enter-end="opacity-100 transform scale-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100 transform scale-100"
         x-transition:leave-end="opacity-0 transform scale-95">
        <div class="p-6">
            <div class="flex items-center mb-4">
                <div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center mr-3">
                    <span class="text-2xl">âš ï¸</span>
                </div>
                <h3 class="text-xl font-bold text-gray-800">é‡è¦æç¤º</h3>
            </div>
            <div class="mb-6">
                <p class="text-gray-700 leading-relaxed" x-text="content"></p>
            </div>
            <div class="flex justify-end">
                <button @click="dismiss()"
                        class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                    æˆ‘å·²äº†è§£
                </button>
            </div>
        </div>
    </div>
</div>

<div class="space-y-8">
    <!-- Quick stats -->
    <div id="quick-stats" class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Loading skeleton - will be replaced by JavaScript -->
        <div id="quick-stats-loading" class="bg-white rounded-lg shadow p-6 animate-pulse col-span-1 md:col-span-2">
            <div class="h-4 bg-gray-200 rounded w-3/4 mb-4"></div>
            <div class="h-8 bg-gray-200 rounded mb-4"></div>
            <div class="h-64 bg-gray-200 rounded"></div>
        </div>
    </div>
    
    <!-- Job statistics -->
    <div id="job-stats" class="space-y-6">
        <!-- Will be loaded via JavaScript -->
    </div>
    
    <!-- Quick actions -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Candidate management -->
        <a href="/candidates" class="bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition transform hover:-translate-y-1">
            <div class="flex items-center mb-4">
                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                    <span class="text-2xl">ğŸ‘¥</span>
                </div>
                <h3 class="text-xl font-bold ml-4 text-gray-800">æ‰‹åŠ¨æ‹›è˜</h3>
            </div>
            <p class="text-gray-600">æ‰‹åŠ¨ç®¡ç†å€™é€‰äººï¼ŒæŸ¥çœ‹ç®€å†ã€åˆ†æåŒ¹é…åº¦ã€å‘é€æ¶ˆæ¯</p>
        </a>
        
        <!-- Automation -->
        <div class="bg-white rounded-lg shadow-lg p-6 opacity-60 cursor-not-allowed">
            <div class="flex items-center mb-4">
                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                    <span class="text-2xl">ğŸ¤–</span>
                </div>
                <h3 class="text-xl font-bold ml-4 text-gray-800">è‡ªåŠ¨åŒ–å·¥ä½œæµ</h3>
            </div>
            <p class="text-gray-600">é…ç½®å¹¶å¯åŠ¨è‡ªåŠ¨åŒ–æ‹›è˜æµç¨‹ï¼Œå®æ—¶ç›‘æ§æ‰§è¡ŒçŠ¶æ€</p>
            <p class="text-sm text-gray-500 mt-2">ğŸš§ å¼€å‘ä¸­</p>
        </div>
        
        <!-- Jobs -->
        <a href="/jobs" class="bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition transform hover:-translate-y-1">
            <div class="flex items-center mb-4">
                <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                    <span class="text-2xl">ğŸ’¼</span>
                </div>
                <h3 class="text-xl font-bold ml-4 text-gray-800">å²—ä½ç”»åƒ</h3>
            </div>
            <p class="text-gray-600">ç®¡ç†æ‹›è˜å²—ä½çš„èƒŒæ™¯ã€èŒè´£ã€è¦æ±‚å’Œç†æƒ³äººé€‰ç”»åƒ</p>
        </a>
    </div>
    
    <!-- Update log -->
    <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">æ›´æ–°æ—¥å¿—</h2>
        <div hx-get="/recent-activity" hx-trigger="load" hx-swap="innerHTML" class="space-y-2">
            <!-- Will be loaded via HTMX -->
            <div class="animate-pulse space-y-2">
                <div class="h-4 bg-gray-200 rounded w-full"></div>
                <div class="h-4 bg-gray-200 rounded w-5/6"></div>
                <div class="h-4 bg-gray-200 rounded w-4/6"></div>
            </div>
        </div>
    </div>
</div>

<script>
// ============================================================================
// Stats Page JavaScript (View-only, only used on index page)
// ============================================================================

// Store chart instances to allow proper cleanup
if (typeof window.chartInstances === 'undefined') {
    window.chartInstances = new Map();
}
const chartInstances = window.chartInstances;

/**
 * Format date string to MM-DD format
 */
function formatDate(dateStr) {
    const date = new Date(dateStr);
    if (isNaN(date.getTime())) {
        return dateStr.split('T')[0].slice(5) || dateStr.slice(-5);
    }
    return `${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
}

/**
 * Render bar chart for daily stats using Chart.js
 */
function renderDailyChart(container) {
    const dailyDataStr = container.getAttribute('data-daily');
    if (!dailyDataStr) return;
    
    const dailyData = JSON.parse(dailyDataStr);
    if (!dailyData || dailyData.length === 0) return;
    
    if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded');
        return;
    }
    
    let canvas = container.querySelector('canvas');
    if (!canvas) {
        const oldChart = container.querySelector('.flex.items-end');
        if (oldChart) oldChart.remove();
        canvas = document.createElement('canvas');
        canvas.style.maxHeight = '250px';
        container.insertBefore(canvas, container.firstChild);
    }
    
    const chartId = container.getAttribute('data-chart-id') || `chart-${Date.now()}-${Math.random()}`;
    container.setAttribute('data-chart-id', chartId);
    
    if (chartInstances.has(chartId)) {
        chartInstances.get(chartId).destroy();
        chartInstances.delete(chartId);
    }
    
    const labels = dailyData.map(d => formatDate(d.date));
    const newData = dailyData.map(d => d.new || 0);
    const seekData = dailyData.map(d => d.seek || 0);
    
    const chart = new Chart(canvas, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'æ–°å¢',
                    data: newData,
                    backgroundColor: 'rgba(59, 130, 246, 0.6)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 1,
                    borderRadius: 4,
                },
                {
                    label: 'SEEK',
                    data: seekData,
                    backgroundColor: 'rgba(99, 102, 241, 0.6)',
                    borderColor: 'rgba(99, 102, 241, 1)',
                    borderWidth: 1,
                    borderRadius: 4,
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 15,
                        font: { size: 12 }
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.parsed.y}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    stacked: false,
                    grid: { display: false },
                    ticks: { font: { size: 11 } }
                },
                y: {
                    beginAtZero: true,
                    stacked: false,
                    grid: { color: 'rgba(0, 0, 0, 0.05)' },
                    ticks: { stepSize: 1, font: { size: 11 } }
                }
            },
            interaction: {
                mode: 'index',
                intersect: false
            }
        }
    });
    
    if (window.chartInstances) {
        window.chartInstances.set(chartId, chart);
    }
    canvas.chart = chart;
}

function initDailyCharts() {
    document.querySelectorAll('.daily-chart-container').forEach(container => {
        renderDailyChart(container);
    });
}

/**
 * Get color for a stage
 */
function getStageColor(stage) {
    const colors = {
        'PASS': 'rgba(156, 163, 175, 0.8)',
        'CHAT': 'rgba(59, 130, 246, 0.8)',
        'SEEK': 'rgba(251, 191, 36, 0.8)',
        'CONTACT': 'rgba(34, 197, 94, 0.8)',
    };
    return colors[stage] || 'rgba(156, 163, 175, 0.8)';
}

function getStageBorderColor(stage) {
    const colors = {
        'PASS': 'rgba(156, 163, 175, 1)',
        'CHAT': 'rgb(73, 107, 162)',
        'SEEK': 'rgb(251, 251, 36)',
        'CONTACT': 'rgb(78, 229, 28)',
    };
    return colors[stage] || 'rgba(156, 163, 175, 1)';
}

/**
 * Render pie chart for conversion data using Chart.js
 */
function renderConversionPieChart(container) {
    const conversionsDataStr = container.getAttribute('data-conversions');
    if (!conversionsDataStr) return;
    
    const conversionsData = JSON.parse(conversionsDataStr);
    if (!conversionsData || conversionsData.length === 0) return;
    
    if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded');
        return;
    }
    
    let canvas = container.querySelector('canvas');
    if (!canvas) {
        canvas = document.createElement('canvas');
        canvas.style.maxHeight = '250px';
        container.insertBefore(canvas, container.firstChild);
    }
    
    const chartId = container.getAttribute('data-chart-id') || `pie-chart-${Date.now()}-${Math.random()}`;
    container.setAttribute('data-chart-id', chartId);
    
    if (chartInstances.has(chartId)) {
        chartInstances.get(chartId).destroy();
        chartInstances.delete(chartId);
    }
    
    const validData = conversionsData.filter(c => c && c.stage);
    if (validData.length === 0) {
        console.warn('No valid conversion data for pie chart');
        return;
    }
    
    const labels = validData.map(c => c.stage);
    const data = validData.map(c => c.count || 0);
    const backgroundColor = validData.map(c => getStageColor(c.stage));
    const borderColor = validData.map(c => getStageBorderColor(c.stage));
    const total = data.reduce((sum, val) => sum + val, 0);
    
    const chart = new Chart(canvas, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: backgroundColor,
                borderColor: borderColor,
                borderWidth: 2,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'right',
                    labels: {
                        usePointStyle: true,
                        padding: 15,
                        font: { size: 12 },
                        generateLabels: function(chart) {
                            const legendLabels = [];
                            for (let i = 0; i < labels.length; i++) {
                                const value = data[i] || 0;
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                const stageName = labels[i] || 'Unknown';
                                legendLabels.push({
                                    text: `${stageName}: ${value} (${percentage}%)`,
                                    fillStyle: backgroundColor[i],
                                    strokeStyle: borderColor[i],
                                    lineWidth: 2,
                                    hidden: false,
                                    index: i
                                });
                            }
                            return legendLabels;
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                            const conversion = validData[context.dataIndex];
                            const rate = conversion ? (conversion.rate * 100).toFixed(0) : '0';
                            return [
                                `${label}: ${value} (${percentage}%)`,
                                `è½¬åŒ–ç‡: ${rate}%`
                            ];
                        }
                    }
                }
            }
        }
    });
    
    if (window.chartInstances) {
        window.chartInstances.set(chartId, chart);
    }
    canvas.chart = chart;
}

function initConversionPieCharts() {
    document.querySelectorAll('.conversion-pie-chart-container').forEach(container => {
        renderConversionPieChart(container);
    });
}

/**
 * Render daily candidate count mixed chart (bar for daily new, line for cumulative)
 */
function renderDailyCandidateChart() {
    const container = document.querySelector('.daily-candidate-chart-container');
    if (!container) return;
    
    const dailyDataStr = container.getAttribute('data-daily');
    if (!dailyDataStr) return;
    
    const dailyData = JSON.parse(dailyDataStr);
    if (!dailyData || dailyData.length === 0) return;
    
    if (typeof Chart === 'undefined') {
        throw new Error('Chart.js is not loaded');
    }
    
    const existingChartId = container.getAttribute('data-chart-id');
    if (existingChartId && window.chartInstances && window.chartInstances.has(existingChartId)) {
        window.chartInstances.get(existingChartId).destroy();
        window.chartInstances.delete(existingChartId);
    }
    
    const canvas = document.createElement('canvas');
    canvas.style.maxHeight = '250px';
    container.innerHTML = '';
    container.appendChild(canvas);
    
    const chartId = `candidate-chart-${Date.now()}`;
    container.setAttribute('data-chart-id', chartId);
    
    const labels = dailyData.map(d => formatDate(d.date));
    const cumulativeData = dailyData.map(d => d.count || 0);
    const newData = dailyData.map(d => d.new || 0);
    
    const chart = new Chart(canvas, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'å½“æ—¥æ–°å¢',
                    data: newData,
                    type: 'bar',
                    backgroundColor: 'rgba(16, 185, 129, 0.6)',
                    borderColor: 'rgba(16, 185, 129, 1)',
                    borderWidth: 1,
                    borderRadius: 4,
                    yAxisID: 'y',
                },
                {
                    label: 'ç´¯è®¡æ€»æ•°',
                    data: cumulativeData,
                    type: 'line',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.4,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    yAxisID: 'y1',
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 15,
                        font: { size: 12 }
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.parsed.y}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: { display: false },
                    ticks: {
                        font: { size: 11 },
                        maxRotation: 45,
                        minRotation: 45
                    }
                },
                y: {
                    type: 'linear',
                    position: 'left',
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'å½“æ—¥æ–°å¢',
                        font: { size: 12 }
                    },
                    grid: { color: 'rgba(0, 0, 0, 0.05)' },
                    ticks: { font: { size: 11 } }
                },
                y1: {
                    type: 'linear',
                    position: 'right',
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'ç´¯è®¡æ€»æ•°',
                        font: { size: 12 }
                    },
                    grid: { drawOnChartArea: false },
                    ticks: { font: { size: 11 } }
                }
            },
            interaction: {
                mode: 'index',
                intersect: false
            }
        }
    });
    
    if (window.chartInstances) {
        window.chartInstances.set(chartId, chart);
    }
    canvas.chart = chart;
}

/**
 * Render quick stats cards
 */
function renderQuickStats(data) {
    const container = document.getElementById('quick-stats');
    if (!container) return;
    
    const stats = data.quick_stats || {};
    const dailyData = stats.daily_candidate_counts || [];
    
    container.innerHTML = `
        <div class="bg-white rounded-lg shadow p-6 col-span-1 md:col-span-2">
            <h3 class="text-sm text-gray-600 mb-2">å·²ç­›é€‰å€™é€‰äººæ€»æ•°</h3>
            <p class="text-3xl font-bold text-blue-600 mb-4">${stats.total_candidates || 0}</p>
            <div class="daily-candidate-chart-container" data-daily='${JSON.stringify(dailyData)}' style="min-height: 250px;">
                <!-- Chart.js canvas will be inserted here -->
        </div>
        </div>
    `;
    
    setTimeout(() => {
        renderDailyCandidateChart();
    }, 100);
}

function formatRateBadge(rate) {
    let color = 'text-amber-600';
    if (rate >= 0.6) {
        color = 'text-green-600';
    } else if (rate < 0.3) {
        color = 'text-red-600';
    }
    return `<span class="font-semibold ${color}">${(rate * 100).toFixed(0)}%</span>`;
}

/**
 * Render job statistics
 */
function renderJobStats(data) {
    const container = document.getElementById('job-stats');
    if (!container) return;
    
    let jobs = data.jobs || [];
    const best = data.best;
    
    if (jobs.length === 0) {
        container.innerHTML = '<div class="text-gray-600">æš‚æ— æ•°æ®ï¼Œå…ˆå»å¤„ç†å€™é€‰äººå§ã€‚</div>';
        return;
    }
    
    jobs = jobs.sort((a, b) => {
        const metricA = (a.today && a.today.metric) || 0;
        const metricB = (b.today && b.today.metric) || 0;
        return metricB - metricA;
    });
    
    let html = '';
    
    if (best) {
        const ss = best.score_summary;
        html += `
            <div class="bg-gradient-to-r from-indigo-600 to-blue-500 text-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm opacity-80">ä»Šæ—¥æœ€ä¼˜ç§€æˆ˜ç»©</p>
                        <h3 class="text-2xl font-bold">${best.job}</h3>
                        <p class="mt-2 text-lg">è¿›å±•åˆ† ${best.today.metric.toFixed(1)} = (è¿‘7æ—¥ ${best.today.count} äºº + SEEK ${best.today.seek} äºº) Ã— è‚–åƒå¾—åˆ† ${ss.quality_score} Ã· 10</p>
                        <p class="text-sm opacity-80">é«˜åˆ†å æ¯” ${(ss.high_share * 100).toFixed(1)}% Â· å¹³å‡åˆ† ${ss.average}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm opacity-80">è‚–åƒå¾—åˆ†</p>
                        <p class="text-4xl font-extrabold">${ss.quality_score}</p>
                        <p class="text-xs opacity-70 mt-1">åˆ†å¸ƒå‡åŒ€åº¦40% + é«˜åˆ†å æ¯”30% + ä¸­å¿ƒåˆ†æ•°30%</p>
                        <p class="text-sm opacity-80 mt-2">${ss.comment}</p>
                    </div>
                </div>
            </div>
        `;
    }
    
    jobs.forEach(job => {
        const ss = job.score_summary;
        const dailyData = job.daily || [];
        const conversionData = job.conversions || [];
        
        html += `
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h3 class="text-xl font-bold text-gray-800">${job.job}</h3>
                        <p class="text-sm text-gray-500">æ€»å€™é€‰äºº ${job.total} Â· é«˜åˆ†å æ¯” ${(ss.high_share * 100).toFixed(1)}% Â· ç”»åƒè´¨é‡ ${ss.quality_score}/10</p>
                        <p class="text-sm text-gray-500">è¯„è¯­ï¼š${ss.comment}</p>
                        ${job.today ? `
                        <p class="text-sm text-gray-600 mt-2">
                            <span class="font-semibold">è¿›å±•åˆ† ${job.today.metric.toFixed(1)}</span> = 
                            (è¿‘7æ—¥ ${job.today.count} äºº + SEEK ${job.today.seek} äºº) Ã— è‚–åƒå¾—åˆ† ${ss.quality_score} Ã· 10
                        </p>
                        ` : ''}
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-500">è‚–åƒå¾—åˆ†</p>
                        <p class="text-3xl font-extrabold text-indigo-600">${ss.quality_score}</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h4 class="text-sm font-semibold text-gray-700 mb-2">è¿‘7æ—¥æ–°å¢/SEEK</h4>
                        <div class="daily-chart-container p-4 bg-gray-50 rounded-lg" data-daily='${JSON.stringify(dailyData)}' style="min-height: 250px;">
                            <!-- Chart.js canvas will be inserted here -->
                        </div>
                    </div>
                    <div>
                        <h4 class="text-sm font-semibold text-gray-700 mb-2">é˜¶æ®µè½¬åŒ–ç‡</h4>
                        <div class="conversion-pie-chart-container p-4 bg-gray-50 rounded-lg" data-conversions='${JSON.stringify(conversionData)}' style="min-height: 250px;">
                            <!-- Chart.js canvas will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    
    initDailyCharts();
    initConversionPieCharts();
}

/**
 * Load and render stats page
 */
async function loadStatsPage() {
    const quickStatsContainer = document.getElementById('quick-stats');
    const jobStatsContainer = document.getElementById('job-stats');
    
    if (!quickStatsContainer && !jobStatsContainer) {
        return;
    }
    
    try {
        const response = await fetch('/stats', {
            method: 'GET',
            headers: { 'Accept': 'application/json' }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Stats API returned success=false');
        }
        
        if (quickStatsContainer) {
            renderQuickStats(data);
        }
        if (jobStatsContainer) {
            renderJobStats(data);
        }
    } catch (error) {
        console.error('Failed to load stats:', error);
        if (quickStatsContainer) {
            quickStatsContainer.innerHTML = '<div class="text-red-600 p-4">åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥: ' + error.message + '</div>';
        }
        if (jobStatsContainer) {
            jobStatsContainer.innerHTML = '<div class="text-red-600 p-4">åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥: ' + error.message + '</div>';
        }
    }
}

// Initialize charts and load stats on page load
document.addEventListener('DOMContentLoaded', function() {
    initDailyCharts();
    initConversionPieCharts();
    
    if (document.getElementById('quick-stats') || document.getElementById('job-stats')) {
        loadStatsPage();
    }
});
</script>

{% endblock %}

