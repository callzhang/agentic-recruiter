{% extends "base.html" %}

{% block title %}ç”Ÿæˆå²—ä½ç”»åƒ - BOSSæ‹›è˜åŠ©æ‰‹{% endblock %}

{% block content %}
<div class="space-y-4">
    <style>
        .diff-view { white-space: pre-wrap; word-break: break-word; }
        .diff-add { color: #15803d; font-weight: 600; }
        .diff-del { color: #9ca3af; text-decoration: line-through; }
        .diff-ctx { color: #374151; }
    </style>
<style>
@keyframes pulse-jump {
    0%, 100% { transform: translateY(0); box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
    15% { transform: translateY(-4px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
    30% { transform: translateY(0); box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
    45% { transform: translateY(-2px); box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1); }
    60% { transform: translateY(0); box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
}
.animate-jump-interval {
    animation: pulse-jump 2s ease-in-out infinite; 
    /* The animation itself is 2s, but we want it every 10s. 
       Standard CSS doesn't support "wait 8s then play". 
       We will use JS to toggle the class or use a long animation with delay.
       Let's use a pure CSS keyframe trick: make the animation 10s long, action happens in first 2s. 
    */
    animation: pulse-jump-10s 10s ease-in-out infinite;
}
@keyframes pulse-jump-10s {
    0%, 20% { transform: translateY(0); } /* Wait */
    22% { transform: translateY(-5px) scale(1.02); box-shadow: 0 10px 15px -3px rgba(22, 163, 74, 0.3); }
    24% { transform: translateY(0) scale(1); }
    26% { transform: translateY(-3px) scale(1.01); }
    28%, 100% { transform: translateY(0); box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
}
</style>
    <div class="bg-white rounded-lg shadow p-5">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">ç”Ÿæˆæ–°ç‰ˆå²—ä½è‚–åƒ</h1>
                <p class="text-gray-600 mt-1">
                    å²—ä½ï¼š<span class="font-medium text-gray-800">{{ job.position }}</span>
                    <span class="text-gray-400">({{ base_job_id }})</span>
                </p>
            </div>
            <div class="flex gap-2">
                <a href="/jobs?tab={{ base_job_id }}"
                   class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition font-medium">
                    â† è¿”å›å²—ä½è‚–åƒ
                </a>
            </div>
        </div>
    </div>

    <!-- Progress -->
    <div id="gen-progress-card" class="bg-white rounded-lg border shadow-sm p-5">
        <div class="flex items-center justify-between">
            <div class="font-semibold text-gray-800">ç”Ÿæˆä¸­ï¼ˆGPT-5.2ï¼‰</div>
            <div class="text-sm text-gray-600"><span id="gen-progress-text">0</span>%</div>
        </div>
        <div class="mt-3 w-full bg-gray-200 rounded-full h-3 overflow-hidden">
            <div id="gen-progress-bar" class="h-3 bg-blue-600 rounded-full transition-all duration-300" style="width:0%"></div>
        </div>
        <p class="text-xs text-gray-500 mt-2">
            <span id="gen-estimate-text">é¢„è®¡è®¡ç®—ä¸­...</span>ï¼ˆè§†ç½‘ç»œä¸æ¨¡å‹è´Ÿè½½è€Œå®šï¼‰ã€‚
        </p>
    </div>

    <!-- Result -->
    <div id="gen-result" class="hidden space-y-4">
        <div class="bg-white rounded-lg border shadow-sm">
            <div class="flex items-center justify-between border-b bg-gray-100 p-2">
                <h3 class="font-bold text-gray-800">æ€»ä½“ä¼˜åŒ–å»ºè®®</h3>
            </div>
            <div id="gen-overall-notes" class="p-4 text-sm text-gray-700 whitespace-pre-wrap">æš‚æ— </div>
        </div>

	        <div class="bg-white rounded-lg border shadow-sm">
	            <div class="flex items-center justify-between border-b bg-gray-100 p-2">
	                <h3 class="font-bold text-gray-800">å¯¹æ¯”ä¸ç¼–è¾‘ï¼ˆå¯ä¿®æ”¹åæäº¤ï¼‰</h3>
	                <div class="flex items-center gap-2">
	                    <button onclick="copyGeneratedPortraitJson()"
	                            class="px-3 py-1 text-xs bg-indigo-100 text-indigo-700 border border-indigo-200 rounded hover:bg-indigo-200 transition font-medium">
	                        ğŸ“„ æ‹·è´å²—ä½è‚–åƒæ–‡æ¡£
	                    </button>
	                    <button onclick="pastePortraitJsonIntoEditors()" id="btn-paste-json"
	                            class="px-3 py-1 text-xs bg-green-600 text-white rounded hover:bg-green-700 transition font-medium shadow-sm">
	                        ğŸ“‹ ç²˜è´´å‰ªåˆ‡æ¿ JSON åˆ°é¡µé¢
	                    </button>
	                    <button onclick="publishGeneratedPortrait()"
	                            class="px-3 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700 transition">
	                        ğŸš€ ç¡®è®¤æäº¤ï¼ˆå‘å¸ƒæ–°ç‰ˆæœ¬ï¼‰
	                    </button>
	                </div>
	            </div>
	            <div class="p-4 space-y-4">
	                <p class="text-xs text-gray-500">å·¦ä¾§ä¸ºå½“å‰ç‰ˆæœ¬ï¼Œå³ä¾§ä¸ºç”Ÿæˆç‰ˆæœ¬ï¼ˆå¯ç¼–è¾‘ï¼‰ã€‚å­—ç¬¦ä¸²ä¼šåš url decodeï¼ˆè‹¥çœ‹èµ·æ¥åƒè¢«ç¼–ç è¿‡ï¼‰ã€‚</p>

                <div id="gen-fields" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <!-- Closed Alert Overlay -->
    <div id="closed-alert-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-[60] hidden flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full text-center space-y-4">
            <div class="mx-auto w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
                 <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                 </svg>
            </div>
            <h3 class="text-xl font-bold text-gray-900">åé¦ˆå·²å½’æ¡£</h3>
            <p class="text-gray-600" id="closed-alert-msg">
                æ‰€é€‰åé¦ˆå·²è¢«æ¶ˆè´¹ï¼Œæ— æ³•é‡å¤ç”Ÿæˆã€‚
            </p>
            <div class="pt-4">
                <a href="javascript:history.back()" class="w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none sm:text-sm">
                    è¿”å›ä¸Šä¸€é¡µ
                </a>
            </div>
        </div>
    </div>
</div>

<script src="/static/vendor/diff.min.js"></script>
<script>
const GEN_BASE_JOB_ID = {{ base_job_id | tojson }};
const GEN_ITEM_IDS = {{ item_ids | tojson }};
const JOB_INITIAL_DATA = {{ job | tojson }};
const GEN_EST_SECONDS = 20 + 10 * (GEN_ITEM_IDS?.length || 0);

function _safeDecodeURIComponent(s) {
    if (typeof s !== 'string') return s;
    if (!s.includes('%')) return s;
    try { return decodeURIComponent(s); } catch { return s; }
}

function _normalizeDisplay(s) {
    if (s === null || s === undefined) return '';
    if (typeof s !== 'string') return s;
    // If strings were double-escaped somewhere, try to make it readable for humans.
    let out = _safeDecodeURIComponent(s);
    // Turn literal backslash escapes into real whitespace for readability.
    out = out.replace(/\\r\\n/g, '\n').replace(/\\n/g, '\n').replace(/\\t/g, '\t');
    return out;
}

function _escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = String(text ?? '');
    return div.innerHTML;
}

function _unwrapPortraitPayload(obj) {
    if (!obj || typeof obj !== 'object') return null;
    if (obj.job_portrait && typeof obj.job_portrait === 'object') return obj.job_portrait;
    if (obj.data && typeof obj.data === 'object' && obj.data.job_portrait && typeof obj.data.job_portrait === 'object') return obj.data.job_portrait;
    if (obj.payload && typeof obj.payload === 'object' && obj.payload.job_portrait && typeof obj.payload.job_portrait === 'object') return obj.payload.job_portrait;
    return obj;
}

async function _readClipboardText() {
    try {
        if (navigator.clipboard?.readText) return await navigator.clipboard.readText();
    } catch (e) {
        // fall through
    }
    const fallback = window.prompt('æµè§ˆå™¨é™åˆ¶æ— æ³•ç›´æ¥è¯»å–å‰ªåˆ‡æ¿ï¼Œè¯·ç²˜è´´ JSONï¼š');
    return fallback || '';
}

async function _writeClipboardText(text) {
    try {
        await navigator.clipboard.writeText(text);
        return true;
    } catch (e) {
        window.prompt('æµè§ˆå™¨é™åˆ¶æ— æ³•ç›´æ¥å†™å…¥å‰ªåˆ‡æ¿ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼š', text);
        return false;
    }
}

function _formatKeywordsBlock(kw) {
    const positive = Array.isArray(kw?.positive) ? kw.positive : [];
    const negative = Array.isArray(kw?.negative) ? kw.negative : [];
    return `positive:\n${positive.map(s => String(s || '').trim()).filter(Boolean).join('\n')}\n\nnegative:\n${negative.map(s => String(s || '').trim()).filter(Boolean).join('\n')}`;
}

function _collectEditedPortraitFromPage() {
    const edited = {};
    const keywords = { positive: [], negative: [] };
    for (const el of document.querySelectorAll('textarea[data-field-key]')) {
        const key = el.dataset.fieldKey;
        const val = el.value || '';
        if (key === 'keywords_positive') {
            keywords.positive = val.split('\n').map(s => s.trim()).filter(Boolean);
        } else if (key === 'keywords_negative') {
            keywords.negative = val.split('\n').map(s => s.trim()).filter(Boolean);
        } else if (key === 'keywords') {
            const p = _parseKeywords(val);
            keywords.positive = p.positive;
            keywords.negative = p.negative;
        } else {
            edited[key] = val;
        }
    }
    return {
        description: edited.description || '',
        responsibilities: edited.responsibilities || '',
        requirements: edited.requirements || '',
        target_profile: edited.target_profile || '',
        keywords: keywords,
        drill_down_questions: edited.drill_down_questions || '',
    };
}

function _appendRationaleCallout(container, text) {
    const t = String(text || '').trim();
    if (!t) return;

    const wrap = document.createElement('div');
    wrap.className = 'mt-2 flex gap-2 rounded-lg border border-gray-200 bg-gray-50 px-3 py-2';

    const icon = document.createElement('div');
    icon.className = 'text-gray-500 text-xl leading-none select-none';
    icon.textContent = 'â';

    const body = document.createElement('div');
    body.className = 'text-sm text-gray-700 whitespace-pre-wrap';
    body.textContent = t;

    wrap.appendChild(icon);
    wrap.appendChild(body);
    container.appendChild(wrap);
}

function _splitLines(text) {
    if (!text) return [];
    return String(text).split(/\r?\n/);
}

function _renderCharDiffHtml(oldText, newText) {
    const oldValue = _normalizeDisplay(oldText || '');
    const newValue = _normalizeDisplay(newText || '');
    const diffApi = (window.Diff && typeof window.Diff.diffChars === 'function') ? window.Diff : null;
    if (!diffApi) {
        return `<span class="diff-ctx">${_escapeHtml(newValue)}</span>`;
    }
    const parts = diffApi.diffChars(oldValue, newValue);
    return parts.map(p => {
        const v = _escapeHtml(p.value || '');
        if (p.added) return `<span class="diff-add">${v}</span>`;
        if (p.removed) return `<span class="diff-del">${v}</span>`;
        return `<span class="diff-ctx">${v}</span>`;
    }).join('');
}

function _buildDiffEditor(fieldKey, currentValue, newValue) {
    const wrap = document.createElement('div');
    wrap.className = 'w-full';

    const diffView = document.createElement('div');
    diffView.className = 'diff-view w-full min-h-[120px] px-3 py-2 border rounded-lg bg-white text-xs font-mono overflow-auto';
    diffView.innerHTML = _renderCharDiffHtml(currentValue || '', newValue || '');

    const textarea = document.createElement('textarea');
    textarea.className = 'hidden w-full min-h-[120px] px-3 py-2 border rounded-lg text-xs font-mono focus:ring-2 focus:ring-blue-500 focus:border-blue-500';
    textarea.dataset.fieldKey = fieldKey;
    textarea.value = _normalizeDisplay(newValue || '');

    // Live update diff while editing (debounced).
    let t = null;
    textarea.addEventListener('input', () => {
        if (t) clearTimeout(t);
        t = setTimeout(() => {
            diffView.innerHTML = _renderCharDiffHtml(currentValue || '', textarea.value || '');
        }, 120);
    });

    wrap.appendChild(diffView);
    wrap.appendChild(textarea);
    wrap.__diffView = diffView;
    wrap.__textarea = textarea;
    wrap.__currentValue = currentValue || '';
    wrap.__setEditing = (editing) => {
        if (editing) {
            diffView.classList.add('hidden');
            textarea.classList.remove('hidden');
            textarea.focus();
        } else {
            textarea.classList.add('hidden');
            diffView.classList.remove('hidden');
            diffView.innerHTML = _renderCharDiffHtml(wrap.__currentValue || '', textarea.value || '');
        }
    };
    wrap.__isEditing = () => !textarea.classList.contains('hidden');
    return wrap;
}

function _renderTwoColumnField(container, label, key, currentValue, newValue) {
    const changed = (currentValue || '') !== (newValue || '');
    const rationaleText = container.__rationale?.[key] || '';
    const header = document.createElement('div');
    header.className = 'flex items-center justify-between';
    const leftTitle = document.createElement('div');
    leftTitle.className = 'font-medium text-gray-800';
    leftTitle.textContent = label;

    const rightControls = document.createElement('div');
    rightControls.className = 'flex items-center gap-2';
    const status = document.createElement('div');
    status.className = `text-xs ${changed ? 'text-amber-700' : 'text-gray-400'}`;
    status.textContent = changed ? 'å·²å˜åŒ–' : 'æ— å˜åŒ–';
    const editBtn = document.createElement('button');
    editBtn.type = 'button';
    editBtn.className = 'px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded text-gray-700';
    editBtn.textContent = 'ç¼–è¾‘';

    rightControls.appendChild(status);
    rightControls.appendChild(editBtn);
    header.appendChild(leftTitle);
    header.appendChild(rightControls);
    container.appendChild(header);

    _appendRationaleCallout(container, rationaleText);

    const grid = document.createElement('div');
    grid.className = 'grid grid-cols-2 gap-3';

    const left = document.createElement('textarea');
    left.className = 'w-full min-h-[120px] px-3 py-2 border rounded-lg bg-gray-50 text-xs font-mono';
    left.readOnly = true;
    left.value = _normalizeDisplay(currentValue || '');

    const right = _buildDiffEditor(key, currentValue || '', newValue || '');
    editBtn.addEventListener('click', () => {
        const nowEditing = !right.__isEditing();
        right.__setEditing(nowEditing);
        editBtn.textContent = nowEditing ? 'é¢„è§ˆ' : 'ç¼–è¾‘';
    });

    grid.appendChild(left);
    grid.appendChild(right);
    container.appendChild(grid);
}

function _renderKeywords(container, currentKeywords, newKeywords) {
    const rationaleText = container.__rationale?.keywords || '';
    const norm = (kw) => (kw && typeof kw === 'object') ? kw : { positive: [], negative: [] };
    const c = norm(currentKeywords);
    const n = norm(newKeywords);

    const block = document.createElement('div');
    block.className = 'space-y-4 pt-4 border-t';
    const header = document.createElement('div');
    header.className = 'font-bold text-gray-800 text-lg';
    header.textContent = 'Keywords (åŠ åˆ†é¡¹/å‡åˆ†é¡¹)';
    block.appendChild(header);

    _appendRationaleCallout(block, rationaleText);

    const subContainer = document.createElement('div');
    subContainer.className = 'space-y-4';
    subContainer.__rationale = {}; // Already rendered rationale above

    _renderTwoColumnField(subContainer, 'åŠ åˆ†é¡¹ (Positive Keywords)', 'keywords_positive', (c.positive || []).join('\n'), (n.positive || []).join('\n'));
    _renderTwoColumnField(subContainer, 'å‡åˆ†é¡¹ (Negative Keywords)', 'keywords_negative', (c.negative || []).join('\n'), (n.negative || []).join('\n'));

    block.appendChild(subContainer);
    container.appendChild(block);
}

function _parseKeywords(text) {
    const normalized = String(text || '').replace(/\\r\\n/g, '\n').replace(/\\n/g, '\n');
    const lines = normalized.split(/\r?\n/);
    let mode = null;
    const positive = [];
    const negative = [];
    for (const raw of lines) {
        const line = raw.trim();
        if (!line) continue;
        if (line.toLowerCase().startsWith('positive')) { mode = 'positive'; continue; }
        if (line.toLowerCase().startsWith('negative')) { mode = 'negative'; continue; }
        if (mode === 'positive') positive.push(line);
        else if (mode === 'negative') negative.push(line);
    }
    return { positive, negative };
}

async function copyGeneratedPortraitJson() {
    try {
        const portrait = _collectEditedPortraitFromPage();
        const text = JSON.stringify(portrait, null, 2);
        await _writeClipboardText(text);
        showToast('å·²å¤åˆ¶å²—ä½è‚–åƒ JSON', 'success');
    } catch (e) {
        console.error(e);
        showToast('å¤åˆ¶å¤±è´¥', 'error');
    }
}

async function pastePortraitJsonIntoEditors() {
    // Stop animation on first interaction attempt
    const pasteBtn = document.getElementById('btn-paste-json');
    if (pasteBtn) {
        pasteBtn.classList.remove('animate-jump-interval');
        pasteBtn.classList.remove('ring-offset-2', 'ring-2', 'ring-green-400');
    }
    try {
        let raw = '';
        try {
            if (navigator.clipboard?.readText) raw = await navigator.clipboard.readText();
        } catch (e) {
            // fall through
        }

        // Always prompt if empty or failure, as this is a primary action
        if (!raw) {
            raw = window.prompt('è¯·ç²˜è´´å²—ä½è‚–åƒ JSONï¼ˆæ”¯æŒå®Œæ•´å¯¹è±¡æˆ– data.job_portrait æ ¼å¼ï¼‰ï¼š');
        }

        if (!raw || raw.trim().length < 2) {
            if (raw !== null) showToast('å†…å®¹ä¸ºç©ºæˆ–æ— æ•ˆ', 'error');
            return;
        }
        let obj;
        try {
            obj = JSON.parse(raw);
        } catch (e) {
            showToast('è§£æ JSON å¤±è´¥', 'error');
            return;
        }
        const portrait = _unwrapPortraitPayload(obj) || {};

        const fieldKeys = ['description', 'responsibilities', 'requirements', 'target_profile', 'drill_down_questions'];
        for (const key of fieldKeys) {
            if (!(key in portrait)) continue; // missing => keep current
            const textarea = document.querySelector(`textarea[data-field-key="${key}"]`);
            if (!textarea) continue;
            textarea.value = _normalizeDisplay(portrait[key] ?? '');
            textarea.dispatchEvent(new Event('input', { bubbles: true }));
        }

        if ('keywords' in portrait) {
            const kw = portrait.keywords || { positive: [], negative: [] };
            const pTa = document.querySelector('textarea[data-field-key="keywords_positive"]');
            if (pTa) {
                pTa.value = (kw.positive || []).join('\n');
                pTa.dispatchEvent(new Event('input', { bubbles: true }));
            }
            const nTa = document.querySelector('textarea[data-field-key="keywords_negative"]');
            if (nTa) {
                nTa.value = (kw.negative || []).join('\n');
                nTa.dispatchEvent(new Event('input', { bubbles: true }));
            }
        }

        showToast('å·²ä»å‰ªåˆ‡æ¿åº”ç”¨ JSONï¼ˆç¼ºå°‘å­—æ®µä¸ä¼šè¦†ç›–ï¼‰', 'success');
    } catch (e) {
        console.error(e);
        showToast('ç²˜è´´å¤±è´¥', 'error');
    }
}

function _progressByElapsedSeconds(t) {
    // Phase 1 (0-30s): ease-out to ~95%
    // Phase 2 (30s+): slow down, asymptotically approach ~99.9% (never reaches 100 until the real result returns)
    const x = Math.max(0, t);
    const phase1 = Math.max(20.0, GEN_EST_SECONDS || 30.0);
    const p1 = 95.0;
    const pMax = 99.9;

    if (x <= phase1) {
        const u = x / phase1; // 0..1
        // easeOutCubic
        return p1 * (1 - Math.pow(1 - u, 3));
    }

    const dt = x - phase1;
    const k2 = 0.08; // smaller => slower approach after 30s
    return p1 + (pMax - p1) * (1 - Math.exp(-k2 * dt));
}

async function startGeneration() {
    const startedAt = Date.now();
    const bar = document.getElementById('gen-progress-bar');
    const text = document.getElementById('gen-progress-text');

    let done = false;
    const timer = setInterval(() => {
        if (done) return;
        const t = (Date.now() - startedAt) / 1000.0;
        const p = _progressByElapsedSeconds(t);
        const pInt = Math.floor(p);
        bar.style.width = `${p.toFixed(1)}%`;
        text.textContent = String(pInt);
    }, 200);

    try {
        const resp = await fetch('/jobs/api/optimizations/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ job_id: GEN_BASE_JOB_ID, item_ids: GEN_ITEM_IDS }),
        });
        const payload = await resp.json();
        if (!payload?.success) {
            // Check for closed feedback case
            if (payload?.code === 'FEEDBACK_CLOSED' || (payload?.error && payload.error.includes('å·²å½’æ¡£'))) {
                done = true;
                clearInterval(timer);
                document.getElementById('closed-alert-msg').textContent = payload.error;
                document.getElementById('closed-alert-overlay').classList.remove('hidden');
                document.getElementById('gen-progress-card').classList.add('hidden');
                return;
            }
            throw new Error(payload?.error || 'ç”Ÿæˆå¤±è´¥');
        }

        done = true;
        clearInterval(timer);
        bar.style.width = '100%';
        text.textContent = '100';
        setTimeout(() => {
            const card = document.getElementById('gen-progress-card');
            card?.classList.add('hidden');
        }, 300);

        renderResult(payload);
    } catch (e) {
        done = true;
        clearInterval(timer);
        console.error(e);
        showToast(e.message || 'ç”Ÿæˆå¤±è´¥', 'error');
    }
}

function renderResult(payload) {
    const result = payload.data || {};
    const currentPortrait = payload.current_job_portrait || {};
    const generatedPortrait = result.job_portrait || {};

    const rationale = result.rationale;
    const overallEl = document.getElementById('gen-overall-notes');
    if (!rationale || typeof rationale === 'string') {
        overallEl.textContent = rationale || 'æš‚æ— ';
    } else {
        overallEl.textContent = String(rationale.overall_notes || 'æš‚æ— ').trim() || 'æš‚æ— ';
    }

    const fields = document.getElementById('gen-fields');
    fields.innerHTML = '';
    fields.__rationale = (rationale && typeof rationale === 'object') ? rationale : {};

    _renderTwoColumnField(fields, 'description', 'description', currentPortrait.description, generatedPortrait.description);
    _renderTwoColumnField(fields, 'responsibilities', 'responsibilities', currentPortrait.responsibilities, generatedPortrait.responsibilities);
    _renderTwoColumnField(fields, 'requirementsï¼ˆè¯„åˆ†æ ‡å‡†ï¼‰', 'requirements', currentPortrait.requirements, generatedPortrait.requirements);
    _renderTwoColumnField(fields, 'target_profile', 'target_profile', currentPortrait.target_profile, generatedPortrait.target_profile);
    _renderKeywords(fields, currentPortrait.keywords, generatedPortrait.keywords);
    _renderTwoColumnField(fields, 'drill_down_questions', 'drill_down_questions', currentPortrait.drill_down_questions, generatedPortrait.drill_down_questions);

    document.getElementById('gen-result').classList.remove('hidden');
}

async function publishGeneratedPortrait() {
    const jobPortrait = _collectEditedPortraitFromPage();

    try {
        const resp = await fetch('/jobs/api/optimizations/publish', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ job_id: GEN_BASE_JOB_ID, job_portrait: jobPortrait, item_ids: GEN_ITEM_IDS }),
        });
        const data = await resp.json();
        if (!data?.success) {
            showToast(data?.error || 'å‘å¸ƒå¤±è´¥', 'error');
            return;
        }
        showToast('å·²å‘å¸ƒæ–°ç‰ˆæœ¬ï¼Œå¹¶åˆ‡æ¢ä¸º current', 'success');
        setTimeout(() => {
            window.location.href = `/jobs?tab=${encodeURIComponent(GEN_BASE_JOB_ID)}`;
        }, 600);
    } catch (e) {
        console.error(e);
        showToast('å‘å¸ƒå¤±è´¥ï¼ˆç½‘ç»œ/æœåŠ¡å¼‚å¸¸ï¼‰', 'error');
    }
}

function enterManualMode() {
    // Hide progress
    const card = document.getElementById('gen-progress-card');
    card?.classList.add('hidden');

    // Construct payload from initial job data
    const current = _unwrapPortraitPayload(JOB_INITIAL_DATA) || {};

    // For manual mode, we init with current data so user can modify or paste over it
    const payload = {
        data: {
            job_portrait: { ...current },
            rationale: { overall_notes: 'æ‰‹åŠ¨æ¨¡å¼ï¼šè¯·ç‚¹å‡»ä¸Šæ–¹â€œç²˜è´´å‰ªåˆ‡æ¿ JSONâ€æŒ‰é’®å¯¼å…¥å¾…å¯¹æ¯”çš„é…ç½®ã€‚' }
        },
        current_job_portrait: current
    };

    renderResult(payload);

    // Add animation to paste button
    const pasteBtn = document.getElementById('btn-paste-json');
    if (pasteBtn) {
        pasteBtn.classList.add('animate-jump-interval');
        pasteBtn.classList.add('ring-offset-2', 'ring-2', 'ring-green-400'); // Ring highlight
    }

    showToast('å·²è¿›å…¥æ‰‹åŠ¨å¯¹æ¯”æ¨¡å¼ï¼Œè¯·ç²˜è´´ JSON', 'info');
}

document.addEventListener('DOMContentLoaded', () => {
    if (!GEN_ITEM_IDS || !GEN_ITEM_IDS.length) {
        enterManualMode();
        return;
    }
    const estEl = document.getElementById('gen-estimate-text');
    if (estEl) estEl.textContent = `é¢„è®¡çº¦ ${GEN_EST_SECONDS} ç§’å®Œæˆ`;
    startGeneration();
});
</script>
{% endblock %}
