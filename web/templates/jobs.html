{% extends "base.html" %}

{% block title %}å²—ä½ç”»åƒ - BOSSæ‹›è˜åŠ©æ‰‹{% endblock %}

{% block content %}
<!-- Confirm Modal (matching index.html style) -->
<div x-data="{ 
        get modal() { return Alpine.store('confirmModal'); }
     }" 
     x-show="modal.show"
     x-transition:enter="transition ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="transition ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0"
     class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
     style="display: none;"
     @keydown.escape.window="modal.cancel()">
    <div class="bg-white rounded-lg shadow-2xl max-w-md w-full mx-4"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform scale-95"
         x-transition:enter-end="opacity-100 transform scale-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100 transform scale-100"
         x-transition:leave-end="opacity-0 transform scale-95"
         @click.away="modal.cancel()">
        <div class="p-6">
            <div class="flex items-center mb-4">
                <div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center mr-3">
                    <span class="text-2xl">âš ï¸</span>
                </div>
                <h3 class="text-xl font-bold text-gray-800" x-text="modal.title"></h3>
            </div>
            <div class="mb-6">
                <p class="text-gray-700 leading-relaxed whitespace-pre-line" x-text="modal.message"></p>
            </div>
            <div class="flex justify-end">
                <button @click="modal.cancel()" 
                        class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-medium mr-3">
                    å–æ¶ˆ
                </button>
                <button @click="modal.confirm()" 
                        class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                    ç¡®å®š
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Job Modal (for deleting last version) -->
<div x-data="{ 
        get modal() { return Alpine.store('deleteJobModal'); }
     }" 
     x-show="modal.show"
     x-transition:enter="transition ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="transition ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0"
     class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
     style="display: none;"
     @keydown.escape.window="modal.cancel()">
    <div class="bg-white rounded-lg shadow-2xl max-w-md w-full mx-4"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform scale-95"
         x-transition:enter-end="opacity-100 transform scale-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100 transform scale-100"
         x-transition:leave-end="opacity-0 transform scale-95"
         @click.away="modal.cancel()">
        <div class="p-6">
            <div class="flex items-center mb-4">
                <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mr-3">
                    <span class="text-2xl">ğŸ—‘ï¸</span>
                </div>
                <h3 class="text-xl font-bold text-gray-800" x-text="modal.title"></h3>
            </div>
            <div class="mb-6">
                <p class="text-gray-700 leading-relaxed whitespace-pre-line" x-text="modal.message"></p>
            </div>
            <div class="flex justify-end">
                <button @click="modal.cancel()" 
                        class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-medium mr-3">
                    å–æ¶ˆ
                </button>
                <button @click="modal.confirm()" 
                        class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-medium">
                    ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå²—ä½
                </button>
            </div>
        </div>
    </div>
</div>

<div class="space-y-6">
    <!-- Page header -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">å²—ä½ç”»åƒ</h1>
                <p class="text-gray-600 mt-2">ç®¡ç†æ‹›è˜å²—ä½çš„èƒŒæ™¯ã€èŒè´£ã€è¦æ±‚å’Œç†æƒ³äººé€‰ç”»åƒ</p>
            </div>
            <div class="flex items-center gap-3">
                <button type="button"
                        id="jobs-optimize-btn"
                        disabled
                        title="æ­£åœ¨è¯»å–äººç±»åé¦ˆæ•°æ®..."
                        class="relative px-6 py-3 rounded-lg font-medium shadow-sm bg-gray-200 text-gray-500 cursor-not-allowed">
                    <span id="jobs-optimize-label">ä¼˜åŒ–è‚–åƒï¼ˆè¯»å–åé¦ˆä¸­ï¼‰</span>
                    <span id="jobs-optimize-badge"
                          class="hidden absolute -top-2 -right-2 min-w-[18px] h-[18px] px-1 rounded-full bg-red-600 text-white text-[11px] leading-[18px] text-center">
                        0
                    </span>
                </button>
                <button onclick="createNewJob()"
                        class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                    â• åˆ›å»ºæ–°å²—ä½
                </button>
            </div>
        </div>
    </div>
    
    <!-- Jobs management -->
    <div class="bg-white rounded-lg shadow-lg">
        <div class="border-b border-gray-200 overflow-x-auto">
            <!-- Job tabs will be populated here -->
            <div id="job-tabs" class="flex flex-nowrap min-w-max">
                <!-- Tabs will be generated by JavaScript -->
            </div>
        </div>
        
        <!-- Job content -->
        <div id="job-content" class="p-6">
            <div class="text-center text-gray-500 py-12">
                <div>è¯·é€‰æ‹©å²—ä½...</div>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize Alpine store for delete job modal
document.addEventListener('alpine:init', () => {
    // Delete job modal store (for deleting last version - green cancel, red confirm)
    Alpine.store('deleteJobModal', {
        show: false,
        message: '',
        title: 'åˆ é™¤å²—ä½',
        resolve: null,
        
        confirm() {
            if (this.resolve) {
                this.resolve(true);
                this.resolve = null;
            }
            this.show = false;
        },
        
        cancel() {
            if (this.resolve) {
                this.resolve(false);
                this.resolve = null;
            }
            this.show = false;
        }
    });
});

/**
 * Special confirm for deleting the last version (green cancel, red confirm)
 * Returns a Promise that resolves to true/false
 */
function showDeleteJobConfirm(message, title = 'åˆ é™¤å²—ä½') {
    return new Promise((resolve) => {
        if (!window.Alpine) {
            console.error('Alpine.js not loaded');
            resolve(false);
            return;
        }
        
        const store = Alpine.store('deleteJobModal');
        if (!store) {
            Alpine.store('deleteJobModal', {
                show: false,
                message: '',
                title: '',
                resolve: null
            });
        }
        
        const modalStore = Alpine.store('deleteJobModal');
        modalStore.message = message;
        modalStore.title = title;
        modalStore.resolve = resolve;
        modalStore.show = true;
    });
}

// Job data - will be loaded dynamically
let jobsData = [];
let currentJobIndex = -1;

// Load jobs data from API
async function loadJobsData() {
    try {
        const response = await fetch('/jobs/api/list');
        const result = await response.json();
        
        if (result.success) {
            // Sort by updated_at in descending order (most recent first)
            // Backend already sorts, but ensure frontend maintains order
            jobsData = result.data.sort((a, b) => {
                const dateA = new Date(a.updated_at || a.created_at || 0);
                const dateB = new Date(b.updated_at || b.created_at || 0);
                return dateB - dateA; // Descending order (newest first)
            });
            
            renderJobTabs();
            
            // Check URL for tab parameter
            const urlParams = new URLSearchParams(window.location.search);
            const tabParam = urlParams.get('tab');
            
            if (tabParam) {
                // Find job by base_job_id (remove _vN suffix from both)
                const jobIndex = jobsData.findIndex(job => {
                    const jobBaseId = job.base_job_id || getBaseJobId(job.job_id || '');
                    return jobBaseId === tabParam;
                });
                if (jobIndex !== -1) {
                    
                    switchToJob(jobIndex);
                } else {
                    
                    switchToJob(0);
                }
            } else if (jobsData.length > 0) {
                switchToJob(0);
            } else {
                loadNewJobForm();
            }
        } else {
            
        }
    } catch (error) {
        
    }
}

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    loadJobsData();
});

// Render job tabs
function renderJobTabs() {
    const tabsContainer = document.getElementById('job-tabs');
    let tabsHtml = '';
    
    // Add existing job tabs
    jobsData.forEach((job, index) => {
        const activeClass = index === currentJobIndex ? 'active bg-blue-50 border-blue-500 text-blue-700' : 'inactive bg-gray-50 border-gray-300 text-gray-700';
        // Display base job_id (remove _vN suffix) for tab display
        const displayJobId = job.base_job_id || getBaseJobId(job.job_id || '');
        tabsHtml += `
            <button class="job-tab px-4 py-2 border-b-2 flex-shrink-0 whitespace-nowrap ${activeClass} hover:bg-blue-50 transition-colors"
                    onclick="switchToJob(${index})">
                ${job.position || displayJobId || 'Unknown'}
            </button>
        `;
    });
    
    // Add new job tab
    const newJobActiveClass = currentJobIndex === jobsData.length ? 'active bg-blue-50 border-blue-500 text-blue-700' : 'inactive bg-gray-50 border-gray-300 text-gray-700';
    tabsHtml += `
        <button class="job-tab px-4 py-2 border-b-2 flex-shrink-0 whitespace-nowrap ${newJobActiveClass} hover:bg-blue-50 transition-colors"
                onclick="switchToJob(${jobsData.length})">
            â• æ–°å¢å²—ä½
        </button>
    `;
    
    tabsContainer.innerHTML = tabsHtml;
}

// Switch to a specific job
function switchToJob(jobIndex) {
    currentJobIndex = jobIndex;
    renderJobTabs();
    
    // Update URL
    const url = new URL(window.location);
    if (jobIndex < jobsData.length) {
        // Use base_job_id for URL (remove _vN suffix)
        const job = jobsData[jobIndex];
        const baseJobId = job.base_job_id || getBaseJobId(job.job_id || '');
        url.searchParams.set('tab', baseJobId);
        // Load existing job
        loadJobForm(job);
    } else {
        url.searchParams.delete('tab');
        // Load new job form
        loadNewJobForm();
        updateOptimizeButtonState(null);
    }
    window.history.pushState({}, '', url);
}

// Helper functions
function getBaseJobId(jobId) {
    return jobId.replace(/_v\d+$/, '');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function _readClipboardText() {
    try {
        if (navigator.clipboard?.readText) return await navigator.clipboard.readText();
    } catch (e) {
        // fall through
    }
    const fallback = window.prompt('æµè§ˆå™¨é™åˆ¶æ— æ³•ç›´æ¥è¯»å–å‰ªåˆ‡æ¿ï¼Œè¯·ç²˜è´´ JSONï¼š');
    return fallback || '';
}

async function _writeClipboardText(text) {
    try {
        await navigator.clipboard.writeText(text);
        return true;
    } catch (e) {
        window.prompt('æµè§ˆå™¨é™åˆ¶æ— æ³•ç›´æ¥å†™å…¥å‰ªåˆ‡æ¿ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼š', text);
        return false;
    }
}

function _unwrapJobPortrait(obj) {
    if (!obj || typeof obj !== 'object') return null;
    if (obj.job_portrait && typeof obj.job_portrait === 'object') return obj.job_portrait;
    if (obj.data && typeof obj.data === 'object' && obj.data.job_portrait && typeof obj.data.job_portrait === 'object') return obj.data.job_portrait;
    if (obj.payload && typeof obj.payload === 'object' && obj.payload.job_portrait && typeof obj.payload.job_portrait === 'object') return obj.payload.job_portrait;
    return obj;
}

function _normalizeKeywords(value) {
    if (Array.isArray(value)) return { positive: value.map(v => String(v || '').trim()).filter(Boolean), negative: [] };
    if (typeof value === 'string') {
        const lines = value.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
        return { positive: lines, negative: [] };
    }
    if (value && typeof value === 'object') {
        const pos = Array.isArray(value.positive) ? value.positive : (Array.isArray(value.keywords) ? value.keywords : []);
        const neg = Array.isArray(value.negative) ? value.negative : [];
        return {
            positive: pos.map(v => String(v || '').trim()).filter(Boolean),
            negative: neg.map(v => String(v || '').trim()).filter(Boolean),
        };
    }
    return { positive: [], negative: [] };
}

function _getJobPortraitFromForm() {
    const portrait = {};
    const positionEl = document.getElementById('position');
    const descriptionEl = document.getElementById('description');
    const responsibilitiesEl = document.getElementById('responsibilities');
    const requirementsEl = document.getElementById('requirements');
    const targetProfileEl = document.getElementById('target_profile');
    const ddqTextEl = document.getElementById('drill_down_questions_text');
    const candidateFiltersEl = document.getElementById('candidate_filters_json');

    portrait.position = positionEl?.value ?? '';
    portrait.description = descriptionEl?.value ?? '';
    portrait.responsibilities = responsibilitiesEl?.value ?? '';
    portrait.requirements = requirementsEl?.value ?? '';
    portrait.target_profile = targetProfileEl?.value ?? '';
    portrait.drill_down_questions = ddqTextEl?.value ?? '';

    const positive = window.tagEditors?.positive_keywords ? Array.from(window.tagEditors.positive_keywords.tags) : [];
    const negative = window.tagEditors?.negative_keywords ? Array.from(window.tagEditors.negative_keywords.tags) : [];
    portrait.keywords = { positive, negative };

    if (candidateFiltersEl) {
        const raw = (candidateFiltersEl.value || '').trim();
        if (!raw) {
            portrait.candidate_filters = null;
        } else {
            try {
                portrait.candidate_filters = JSON.parse(raw);
            } catch {
                // Keep raw string so user can roundtrip even if JSON is temporarily invalid.
                portrait.candidate_filters = raw;
            }
        }
    }
    return portrait;
}

async function copyJobPortraitJsonFromForm() {
    try {
        const portrait = _getJobPortraitFromForm();
        const text = JSON.stringify(portrait, null, 2);
        await _writeClipboardText(text);
        showToast('å·²å¤åˆ¶å²—ä½è‚–åƒ JSON', 'success');
    } catch (e) {
        console.error(e);
        showToast('å¤åˆ¶å¤±è´¥', 'error');
    }
}

async function pasteJobPortraitJsonToForm() {
    try {
        let raw = '';
        try {
            if (navigator.clipboard?.readText) raw = await navigator.clipboard.readText();
        } catch (e) {
            // fall through
        }

        // Robust fallback: if automatic read failed or returned empty, prompt the user.
        if (!raw || raw.trim().length < 2) {
            raw = window.prompt('æ— æ³•è¯»å–å‰ªåˆ‡æ¿ï¼Œè¯·ç›´æ¥ç²˜è´´ JSON ä»£ç ï¼š');
        }

        if (!raw || raw.trim().length < 2) {
            if (raw !== null) showToast('å†…å®¹ä¸ºç©ºæˆ–æ— æ•ˆ', 'error');
            return;
        }

        let obj;
        try {
            obj = JSON.parse(raw);
        } catch (e) {
            showToast('è§£æ JSON å¤±è´¥', 'error');
            return;
        }

        const portrait = _unwrapJobPortrait(obj) || {};

        const setIfPresent = (id, key) => {
            if (!(key in portrait)) return;
            const el = document.getElementById(id);
            if (!el) return;
            el.value = portrait[key] ?? '';
        };

        setIfPresent('position', 'position');
        setIfPresent('description', 'description');
        setIfPresent('responsibilities', 'responsibilities');
        setIfPresent('requirements', 'requirements');
        setIfPresent('target_profile', 'target_profile');
        setIfPresent('drill_down_questions_text', 'drill_down_questions');

        if ('keywords' in portrait) {
            const kw = _normalizeKeywords(portrait.keywords);
            // Ensure editors exist for current DOM.
            if (!window.tagEditors?.positive_keywords || !window.tagEditors?.negative_keywords) {
                initializeTagEditors();
            }
            window.tagEditors?.positive_keywords?.setTags?.(kw.positive || []);
            window.tagEditors?.negative_keywords?.setTags?.(kw.negative || []);
        }

        if ('candidate_filters' in portrait) {
            const el = document.getElementById('candidate_filters_json');
            if (el) {
                const v = portrait.candidate_filters;
                if (v === null || v === undefined || v === '') {
                    el.value = '';
                } else if (typeof v === 'string') {
                    el.value = v;
                } else {
                    el.value = JSON.stringify(v, null, 2);
                }
            }
        }
        
        // Also handle notification config if present in the pasted JSON
        if (portrait.notification) {
            if (portrait.notification.url) {
                const urlEl = document.getElementById('dingtalk_url');
                if (urlEl) urlEl.value = portrait.notification.url;
            }
            if (portrait.notification.secret) {
                const secretEl = document.getElementById('dingtalk_secret');
                if (secretEl) secretEl.value = portrait.notification.secret;
            }
        }

        showToast('å·²ä»å‰ªåˆ‡æ¿åº”ç”¨ JSONï¼ˆç¼ºå°‘å­—æ®µä¸ä¼šè¦†ç›–ï¼‰', 'success');
    } catch (e) {
        console.error(e);
        showToast('ç²˜è´´å¤±è´¥', 'error');
    }
}

// Extract form data to job object
function extractJobDataFromForm() {
    const form = document.getElementById('job-form');
    if (!form) return null;
    const formData = new FormData(form);
    const jobData = Object.fromEntries(formData.entries());

    // Validate requirements text (required, lightweight)
    if (!validateRequirementsText()) {
        const el = document.getElementById('requirements');
        showToast('è¯„åˆ†æ ‡å‡†ä¸èƒ½ä¸ºç©ºï¼Œè¯·å¡«å†™åå†ä¿å­˜', 'error');
        el?.focus();
        return null;
    }
    
    const ddqTextEl = document.getElementById('drill_down_questions_text');
    jobData.drill_down_questions = ddqTextEl ? ddqTextEl.value : '';
    
    const candidateFiltersEl = document.getElementById('candidate_filters_json');
    if (candidateFiltersEl && candidateFiltersEl.value.trim()) {
        if (!validateCandidateFilters()) {
            showToast('å€™é€‰äººç­›é€‰æ¡ä»¶ JSON æ ¼å¼é”™è¯¯ï¼Œè¯·ä¿®æ­£åå†ä¿å­˜', 'error');
            candidateFiltersEl.focus();
            return null;
        }
        try {
            jobData.candidate_filters = JSON.parse(candidateFiltersEl.value);
        } catch (e) {
            showToast('å€™é€‰äººç­›é€‰æ¡ä»¶ JSON æ ¼å¼é”™è¯¯: ' + e.message, 'error');
            candidateFiltersEl.focus();
            return null;
        }
    } else {
        jobData.candidate_filters = null;
    }
    
    const positiveKeywords = window.tagEditors['positive_keywords'] ? Array.from(window.tagEditors['positive_keywords'].tags) : [];
    const negativeKeywords = window.tagEditors['negative_keywords'] ? Array.from(window.tagEditors['negative_keywords'].tags) : [];
    jobData.keywords = {
        positive: positiveKeywords,
        negative: negativeKeywords
    };
    
    // Get DingTalk notification config (required)
    const dingtalkUrl = document.getElementById('dingtalk_url')?.value?.trim();
    const dingtalkSecret = document.getElementById('dingtalk_secret')?.value?.trim();
    if (!dingtalkUrl || !dingtalkSecret) {
        showToast('è¯·å…ˆé…ç½®é’‰é’‰æœºå™¨äºº Webhook URL å’Œ Secretï¼ˆå¿…å¡«ï¼‰', 'error');
        if (!dingtalkUrl) document.getElementById('dingtalk_url')?.focus();
        else document.getElementById('dingtalk_secret')?.focus();
        return null;
    }
    jobData.notification = { url: dingtalkUrl, secret: dingtalkSecret };

    // Keep company background as-is (do not auto-merge into description).
    
    return jobData;
}

// API helper
async function apiCall(endpoint, method = 'GET', body = null) {
    const options = {
        method,
        headers: { 'Content-Type': 'application/json' }
    };
    if (body) options.body = JSON.stringify(body);
    
    const response = await fetch(endpoint, options);
    return await response.json();
}

// Helper function to generate job form HTML
function generateJobFormHTML(options) {
    const {
        isNew = false,
        job = {},
        baseJobId = '',
        currentVersion = 1,
        versions = [],
        isCurrent = true,
        formAction = isNew ? 'createJob' : 'saveJob'
    } = options;
    
    const versionSelector = !isNew && versions.length > 1 ? `
        <select id="version-selector" onchange="switchVersion('${escapeHtml(baseJobId)}', this.value)" 
                class="px-3 py-1 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 bg-white">
            ${versions.map(v => `
                <option value="${v.version}" ${v.version === currentVersion ? 'selected' : ''}>
                    v${v.version} ${v.current ? '(å½“å‰)' : ''} - ${new Date(v.created_at).toLocaleDateString('zh-CN')}
                </option>
            `).join('')}
        </select>
    ` : '';
    
    const useVersionButton = !isNew && !isCurrent ? `
        <button type="button" onclick="useThisVersion('${escapeHtml(baseJobId)}', ${currentVersion})" 
                class="px-4 py-1 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-medium shadow-sm">
            åˆ‡æ¢è‡³è¯¥ç‰ˆæœ¬
        </button>
    ` : '';
    
    const versionTag = !isNew ? `
        <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded-md text-xs font-medium">
            v${currentVersion}${isCurrent ? ' (å½“å‰ç‰ˆæœ¬)' : ' (å†å²ç‰ˆæœ¬)'}
        </span>
    ` : '';

    const portraitCopyPasteButtons = `
        <button type="button"
                onclick="copyJobPortraitJsonFromForm()"
                class="px-3 py-1 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm font-medium shadow-sm"
                title="å¤åˆ¶å½“å‰è¡¨å•å†…å®¹ä¸º JSON">
            ğŸ“¤ å¤åˆ¶ JSON
        </button>
        ${!isNew ? `
        <button type="button"
                onclick="location.href='/jobs/optimize/generate?job_id=${escapeHtml(baseJobId)}'"
                class="px-3 py-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium shadow-sm"
                title="è¿›å…¥å¯¹æ¯”æ¨¡å¼ï¼Œå¯¹æ¯”å‰ªåˆ‡æ¿ JSON ä¸å½“å‰ç‰ˆæœ¬å·®å¼‚">
            ğŸ” å¯¹æ¯”å¯¼å…¥...
        </button>
        ` : ''}
    `;
    
    const jobIdField = isNew ? `
        <input type="text" id="job_id" name="job_id" required
               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
               placeholder="ä¾‹å¦‚: python_developer">
    ` : `
        <input type="hidden" name="job_id" value="${escapeHtml(baseJobId)}">
        <input type="text" id="job_id" name="job_id" required readonly
               value="${escapeHtml(baseJobId)}"
               class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-600 cursor-not-allowed"
               placeholder="ä¾‹å¦‚: python_developer">
    `;
    
    const formActions = isNew ? `
        <button type="submit" 
                class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
            âœ¨ åˆ›å»º
        </button>
    ` : `
        <button type="submit" 
                class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
            ğŸ’¾ ä¿å­˜
        </button>
        <button type="button" onclick="deleteJob('${escapeHtml(baseJobId)}', ${currentVersion}, ${versions.length})" 
                class="px-6 py-3 rounded-lg font-medium bg-red-600 text-white hover:bg-red-700">
            ğŸ—‘ï¸ åˆ é™¤å½“å‰ç‰ˆæœ¬
        </button>
    `;
    
    return `
        <!-- ${isNew ? 'New' : 'Job'} form content -->
        <div class="max-w-6xl mx-auto space-y-6">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <form id="job-form" onsubmit="${formAction}(event)">
                    ${!isNew ? `<input type="hidden" name="job_id" value="${escapeHtml(baseJobId)}">` : ''}
                    
                    <!-- Basic Information -->
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <h2 class="text-xl font-semibold text-gray-800">åŸºæœ¬ä¿¡æ¯</h2>
                                ${versionTag}
                            </div>
                            <div class="flex items-center gap-2">
                                ${portraitCopyPasteButtons}
                                ${versionSelector}
                                ${useVersionButton}
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="job_id" class="block text-sm font-medium text-gray-700 mb-2">å²—ä½ ID *</label>
                                ${jobIdField}
                            </div>
                            
                            <div>
                                <label for="position" class="block text-sm font-medium text-gray-700 mb-2">å²—ä½åç§° *</label>
                                <input type="text" id="position" name="position" required
                                       value="${escapeHtml(job.position || '')}"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="ä¾‹å¦‚: Pythonå¼€å‘å·¥ç¨‹å¸ˆ">
                            </div>
                            
                            ${!isNew ? `
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">å²—ä½çŠ¶æ€</label>
                                <div class="flex items-center gap-3">
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" 
                                               id="job-status-toggle" 
                                               ${(job.status || 'active') === 'active' ? 'checked' : ''}
                                               onchange="toggleJobStatus('${escapeHtml(baseJobId)}', this.checked)"
                                               class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                        <span class="ml-3 text-sm font-medium text-gray-700" id="job-status-label">
                                            ${(job.status || 'active') === 'active' ? 'æ¿€æ´»' : 'åœç”¨'}
                                        </span>
                                    </label>
                                    <span class="text-xs text-gray-500" id="job-status-saving" style="display: none;">ä¿å­˜ä¸­...</span>
                                    <span class="text-xs text-green-600" id="job-status-saved" style="display: none;">âœ“ å·²ä¿å­˜</span>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">åœç”¨çš„å²—ä½å°†ä¸ä¼šåœ¨é¦–é¡µç»Ÿè®¡ä¸­æ˜¾ç¤º</p>
                            </div>
                            ` : '<div></div>'}
                        </div>
                    </div>
                    
                    <!-- Job Details -->
                    <div class="space-y-4 mt-8">
                        <h2 class="text-xl font-semibold text-gray-800">å²—ä½è¯¦æƒ…</h2>
                        
                        <div>
                            <label for="description" class="block text-sm font-medium text-gray-700 mb-2">å²—ä½æ¦‚è¿°ï¼ˆå»ºè®®åŒ…å«å…¬å¸/äº§å“/å›¢é˜Ÿ/æ ¸å¿ƒæŒ‘æˆ˜ï¼‰</label>
                            <p class="text-xs text-gray-500 mb-2">å»ºè®® 1-2 æ®µï¼šæˆ‘ä»¬åšä»€ä¹ˆã€ä¸ºä»€ä¹ˆæ‹›äººã€å€™é€‰äººè¿›æ¥è¦è§£å†³çš„æ ¸å¿ƒé—®é¢˜ã€‚</p>
                            <textarea id="description" name="description" rows="5"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                      placeholder="ä¾‹å¦‚ï¼š\næˆ‘ä»¬åœ¨åšXXï¼ˆäº§å“/ä¸šåŠ¡ï¼‰ã€‚å½“å‰æ ¸å¿ƒæŒ‘æˆ˜æ˜¯YYï¼ˆä¾‹å¦‚ï¼šç¨³å®šæ€§/äº¤ä»˜/å¢é•¿/æˆæœ¬ï¼‰ï¼Œå¸Œæœ›ä½ è´Ÿè´£ZZï¼ˆå…³é”®æ¨¡å—/å…³é”®å®¢æˆ·/å…³é”®æµç¨‹ï¼‰ï¼Œå¹¶ä¸AAå›¢é˜Ÿåä½œäº¤ä»˜ã€‚">${escapeHtml(job.description || '')}</textarea>
                        </div>
                        
                        <div>
                            <label for="responsibilities" class="block text-sm font-medium text-gray-700 mb-2">æ ¸å¿ƒèŒè´£ï¼ˆå»ºè®® 3-6 æ¡ï¼‰</label>
                            <p class="text-xs text-gray-500 mb-2">å†™â€œè¦è´Ÿè´£ä»€ä¹ˆ + äº¤ä»˜ä»€ä¹ˆç»“æœâ€ï¼Œé¿å…å †åè¯ã€‚</p>
                            <textarea id="responsibilities" name="responsibilities" rows="4"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                      placeholder="ä¾‹å¦‚ï¼š\n- è´Ÿè´£XXæ¨¡å—ä»0åˆ°1è½åœ°ï¼Œå¹¶å¯¹çº¿ä¸Šè´¨é‡/æˆæœ¬è´Ÿè´£\n- æ¨åŠ¨YYæµç¨‹æ ‡å‡†åŒ–ï¼Œæå‡äº¤ä»˜æ•ˆç‡ï¼ˆç»™å‡ºæŒ‡æ ‡ï¼‰\n- ä¸äº§å“/è¿è¥/äº¤ä»˜åä½œå®ŒæˆZZé¡¹ç›®">${escapeHtml(job.responsibilities || '')}</textarea>
                        </div>
                        
                        <div>
                            <label for="requirements" class="block text-sm font-medium text-gray-700 mb-2">
                                è¯„åˆ†æ ‡å‡†ï¼ˆæ–‡æœ¬ï¼Œä¸€è¡Œä¸€ä¸ªï¼Œæ€»åˆ†100ï¼‰*
                                <button type="button" onclick="insertRequirementsTemplate()" class="ml-2 px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded text-gray-600">
                                    âœ¨ æ’å…¥æ¨¡æ¿
                                </button>
                                <button type="button" onclick="validateRequirementsText()" class="ml-1 px-2 py-1 text-xs bg-blue-100 hover:bg-blue-200 rounded text-blue-600">
                                    âœ“ æ£€æŸ¥
                                </button>
                            </label>
                            <p class="text-xs text-gray-500 mb-2">
                                ç”¨äº AI æŒ‰ç»Ÿä¸€å£å¾„æ‰“åˆ†ï¼ˆæ€»åˆ†100å†æ˜ å°„åˆ°10åˆ†åˆ¶ï¼‰ã€‚å»ºè®®ä¸¥æ ¼æŒ‰ 4 è¡Œå¡«å†™ï¼ˆå¯åŠ  1 è¡Œå¤‡æ³¨ï¼‰ï¼š
                                <code>30 é—¨æ§›ï¼š</code>ã€<code>45 åœºæ™¯ï¼š</code>ã€<code>15 åŸºç¡€ï¼š</code>ã€<code>10 å¥‘åˆï¼š</code>ï¼ˆæƒé‡ä¹‹å’Œ=100ï¼‰ã€‚
                            </p>
                            <textarea id="requirements" name="requirements" rows="10"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                      placeholder="ç¤ºä¾‹ï¼ˆå»ºè®®æ¯è¡Œç”¨â€œï¼›â€åˆ†éš”æ¡ç›®ï¼Œä¾¿äºäººç±»å¡«å†™ï¼Œä¹Ÿä¾¿äºAIç†è§£ï¼‰ï¼š\n30 é—¨æ§›ï¼šç¡¬æ€§æ¡ä»¶1ï¼›ç¡¬æ€§æ¡ä»¶2ï¼›ç¡¬æ€§æ¡ä»¶3ï¼ˆèƒ½ä»ç®€å†åˆ¤æ–­æ»¡è¶³/ä¸æ»¡è¶³/æœªä½“ç°ï¼‰\n45 åœºæ™¯ï¼šå…³é”®åœºæ™¯1ï¼ˆäº²å†/å–èˆ/é‡åŒ–æŒ‡æ ‡/ä½ è´Ÿè´£çš„éƒ¨åˆ†ï¼‰ï¼›å…³é”®åœºæ™¯2ï¼›å…³é”®åœºæ™¯3\n15 åŸºç¡€ï¼šè¡¨è¾¾ç»“æ„åŒ–ï¼›èƒ½é‡åŒ–ç»“æœï¼›å­¦ä¹ è¿ç§»èƒ½åŠ›\n10 å¥‘åˆï¼šOwneræ„è¯†ï¼›åä½œæ¨è¿›ï¼ˆä¸èŠç»©æ•ˆç®¡ç†ï¼‰\nå¤‡æ³¨ï¼šç¼ºå¤±ä¿¡æ¯å¯è®°ä¸ºæ½œåŠ›ï¼ˆæœ€å¤šæŒ‰50%è®¡å…¥ï¼‰ï¼Œå¹¶æç¤ºHRåç»­é‡ç‚¹éªŒè¯"
                                      onblur="validateRequirementsText()">${escapeHtml(job.requirements || '')}</textarea>
                            <p id="requirements_validation" class="text-xs mt-1"></p>
                        </div>
                        
                        <div>
                            <label for="target_profile" class="block text-sm font-medium text-gray-700 mb-2">åŠ åˆ†é¡¹ / ç†æƒ³äººé€‰ï¼ˆå¯é€‰ï¼‰</label>
                            <p class="text-xs text-gray-500 mb-2">å†™æˆâ€œåŠ åˆ†é¡¹/å‡åˆ†é¡¹/é¿å‘ç‚¹â€ï¼Œä¾¿äº AI è¯†åˆ«ã€‚</p>
                            <textarea id="target_profile" name="target_profile" rows="4"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                      placeholder="ä¾‹å¦‚ï¼š\nåŠ åˆ†ï¼šåšè¿‡ToB/ç§æœ‰åŒ–äº¤ä»˜ã€èƒ½é‡åŒ–ç»“æœã€èƒ½å¤ç›˜å¤±è´¥\nå‡åˆ†ï¼šåªå †åè¯ã€ä¸è®²å–èˆä¸ç»“æœã€é•¿æœŸçº¯ç®¡ç†ä¸å†™ä»£ç /ä¸åšä¸€çº¿">${escapeHtml(job.target_profile || '')}</textarea>
                        </div>
                    </div>
                    
                    <!-- Drill Down Questions -->
                    <div class="space-y-4 mt-8">
                        <h2 class="text-xl font-semibold text-gray-800">è¿½é—®é—®é¢˜</h2>
                        <p class="text-sm text-gray-500">åªç”¨äºçº¿ä¸Šç”„åˆ«å€™é€‰äººï¼šæ¯æ¬¡åªé€‰ 1 ä¸ªé—®é¢˜ï¼Œä¸è¦åˆå¹¶å¤šé—®ï¼Œä¸é—®ç®¡ç†/ç»©æ•ˆ/åˆ¶åº¦æ¨è¿›ç±»é—®é¢˜ã€‚</p>
                        <div>
                            <label for="drill_down_questions_text" class="block text-sm font-medium text-gray-700 mb-2">é—®é¢˜åˆ—è¡¨</label>
                            <textarea id="drill_down_questions_text" name="drill_down_questions_text" rows="6"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                      placeholder="ä¾‹å¦‚ï¼š\nè®²ä¸€æ¬¡ä½ äº²å†å¹¶ä¸»å¯¼å¤„ç†çš„çº¿ä¸Šäº‹æ•…ï¼šæ€ä¹ˆå‘ç°â†’æ€ä¹ˆæ­¢è¡€â†’æ€ä¹ˆé•¿æœŸæ²»ç†ï¼Ÿå…³é”®æŒ‡æ ‡å‰åå˜åŒ–å¦‚ä½•ï¼Ÿ\nå¦‚æœç³»ç»Ÿæµé‡æš´æ¶¨10å€ï¼Œæœ€å…ˆå´©çš„æ˜¯å“ªé‡Œï¼Ÿä½ ä¼šæŒ‰ä»€ä¹ˆé¡ºåºæ­¢è¡€ä¸æ”¹é€ ï¼Ÿ">${escapeHtml(job.drill_down_questions || '')}</textarea>
                        </div>
                    </div>
                    
                    <!-- Candidate Filters -->
                    <div class="space-y-4 mt-8">
                        <h2 class="text-xl font-semibold text-gray-800">å€™é€‰äººç­›é€‰æ¡ä»¶</h2>
                        <p class="text-sm text-gray-500">ç”¨äºåœ¨æ¨èé¡µé¢ç­›é€‰å€™é€‰äººçš„æ¡ä»¶ï¼ŒJSONæ ¼å¼ã€‚ä¾‹å¦‚ï¼š{"æ´»è·ƒåº¦": "æœ¬å‘¨æ´»è·ƒ", "é™¢æ ¡": ["985", "ç•™å­¦"], "å­¦å†": "ç¡•å£«"}</p>
                        <div>
                            <label for="candidate_filters_json" class="block text-sm font-medium text-gray-700 mb-2">
                                ç­›é€‰æ¡ä»¶ (JSON)
                                <button type="button" onclick="formatCandidateFilters()" class="ml-2 px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded text-gray-600">
                                    âœ¨ æ ¼å¼åŒ–
                                </button>
                                <button type="button" onclick="validateCandidateFilters()" class="ml-1 px-2 py-1 text-xs bg-blue-100 hover:bg-blue-200 rounded text-blue-600">
                                    âœ“ éªŒè¯
                                </button>
                            </label>
                            <textarea id="candidate_filters_json" name="candidate_filters_json" rows="8"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm"
                                      placeholder='{"æ´»è·ƒåº¦": "æœ¬å‘¨æ´»è·ƒ", "é™¢æ ¡": ["985", "ç•™å­¦"], "åªçœ‹ç¬¬ä¸€å­¦å†": true, "å­¦å†": "ç¡•å£«", "ç»éªŒ": "3-5å¹´", "æ±‚èŒæ„å‘": ["ç¦»èŒ-éšæ—¶åˆ°å²—", "åœ¨èŒ-è€ƒè™‘æœºä¼š"], "è–ªèµ„å¾…é‡": "20-50K"}'
                                      onblur="validateCandidateFilters()">${job.candidate_filters ? JSON.stringify(job.candidate_filters, null, 2) : ''}</textarea>
                            <p id="candidate_filters_validation" class="text-xs mt-1"></p>
                        </div>
                    </div>
                    
                    <!-- DingTalk Notification Config -->
                    <div class="space-y-4 mt-8">
                        <div class="flex items-center gap-2">
                            <h2 class="text-xl font-semibold text-gray-800">DingTalk é€šçŸ¥é…ç½®</h2>
                            <div class="tooltip-container">
                                <span class="tooltip-icon">â“</span>
                                <div class="tooltip-content">
                                    <strong>3æ­¥å¿«é€Ÿé…ç½®ï¼ˆå¿…å¡«ï¼‰ï¼š</strong><br>
                                    1) é’‰é’‰ç¾¤ â†’ å³ä¸Šè§’è®¾ç½® â†’ã€Œæ™ºèƒ½ç¾¤åŠ©æ‰‹ã€<br>
                                    2)ã€Œæ·»åŠ æœºå™¨äººã€â†’ã€Œè‡ªå®šä¹‰ã€â†’ å¼€å¯â€œåŠ ç­¾â€<br>
                                    3) å¤åˆ¶ Webhook URL + Secretï¼Œç²˜è´´åˆ°ä¸‹æ–¹<br>
                                    <a href="https://open.dingtalk.com/document/orgapp/custom-bot-creation-and-installation" target="_blank" class="text-blue-300 underline mt-2 inline-block">æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£</a>
                                </div>
                            </div>
                        </div>
                        <p class="text-sm text-gray-500">è¯¥é…ç½®ç”¨äºå²—ä½çº§é€šçŸ¥ï¼ˆå¿…å¡«ï¼‰ã€‚å»ºè®®æ¯ä¸ªå²—ä½å¯¹åº”ä¸€ä¸ªç¾¤æœºå™¨äººï¼Œä¾¿äºåŒºåˆ†é€šçŸ¥æ¥æºã€‚</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="dingtalk_url" class="block text-sm font-medium text-gray-700 mb-2">Webhook URL</label>
                                <input type="text" id="dingtalk_url" name="dingtalk_url" required
                                       value="${job.notification?.url || ''}"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="https://oapi.dingtalk.com/robot/send?access_token=...">
                            </div>
                            <div>
                                <label for="dingtalk_secret" class="block text-sm font-medium text-gray-700 mb-2">Secret</label>
                                <input type="password" id="dingtalk_secret" name="dingtalk_secret" required
                                       value="${job.notification?.secret || ''}"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="SEC...">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Keywords -->
                    <div class="space-y-4 mt-8">
                        <h2 class="text-xl font-semibold text-gray-800">å…³é”®è¯</h2>
                        <p class="text-sm text-gray-500">ç”¨äºåŒ¹é…å€™é€‰äººçš„å…³é”®è¯ï¼Œæ­£å‘å…³é”®è¯è¡¨ç¤ºå¸Œæœ›å…·å¤‡çš„æŠ€èƒ½ï¼Œè´Ÿå‘å…³é”®è¯ä»£è¡¨æ‰£åˆ†çš„å†…å®¹ï¼Œä¾‹å¦‚åˆçº§èƒ½åŠ›ã€æ³›æ³›è€Œè°ˆã€ä¸åŒ¹é…çš„èƒ½åŠ›ç­‰</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">æ­£å‘å…³é”®è¯</label>
                                <div id="positive-keywords-editor" class="tag-editor" data-field="positive_keywords">
                                    <div class="tag-input-container">
                                        <input type="text" 
                                               class="tag-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                               placeholder="è¾“å…¥å…³é”®è¯åå›è½¦ï¼Œæˆ–ç”¨é€—å·ã€åˆ†å·åˆ†éš”å¤šä¸ªå…³é”®è¯"
                                               data-field="positive_keywords">
                                        <div class="tag-suggestions hidden absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-40 overflow-y-auto">
                                            <!-- Suggestions will be populated here -->
                                        </div>
                                    </div>
                                    <div class="tag-list flex flex-wrap gap-2 mt-2 min-h-[40px] p-2 border border-gray-200 rounded-md bg-gray-50">
                                        <!-- Tags will be rendered here -->
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">è´Ÿå‘å…³é”®è¯</label>
                                <div id="negative-keywords-editor" class="tag-editor" data-field="negative_keywords">
                                    <div class="tag-input-container">
                                        <input type="text" 
                                               class="tag-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                               placeholder="è¾“å…¥å…³é”®è¯åå›è½¦ï¼Œæˆ–ç”¨é€—å·ã€åˆ†å·åˆ†éš”å¤šä¸ªå…³é”®è¯"
                                               data-field="negative_keywords">
                                        <div class="tag-suggestions hidden absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-40 overflow-y-auto">
                                            <!-- Suggestions will be populated here -->
                                        </div>
                                    </div>
                                    <div class="tag-list flex flex-wrap gap-2 mt-2 min-h-[40px] p-2 border border-gray-200 rounded-md bg-gray-50">
                                        <!-- Tags will be rendered here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Form Actions -->
                    <div class="flex gap-4 mt-8 pt-6 border-t">
                        ${formActions}
                    </div>
                </form>
            </div>
        </div>
    `;
}

// Load job form
async function loadJobForm(job) {
    // Extract base job_id from job.job_id (remove _vN suffix)
    const baseJobId = getBaseJobId(job.job_id || job.base_job_id || '');
    const currentVersion = job.version || 1;
    const isCurrent = job.current !== false; // Default to true if not specified
    
    // Fetch all versions
    let versions = [];
    try {
        const versionsResponse = await fetch(`/jobs/${baseJobId}/versions`);
        const versionsResult = await versionsResponse.json();
        
        if (versionsResult.success) {
            versions = versionsResult.data;
        }
    } catch (error) {
        console.error('Failed to load versions:', error);
    }
    
    // Generate form HTML using helper function
    const content = document.getElementById('job-content');
    content.innerHTML = generateJobFormHTML({
        isNew: false,
        job: job,
        baseJobId: baseJobId,
        currentVersion: currentVersion,
        versions: versions,
        isCurrent: isCurrent
    });

    // Load optimization feedback count and update the optimize button state.
    updateOptimizeButtonState(baseJobId);
    
    // Initialize tag editors with existing data
    setTimeout(() => {
        initializeTagEditors();
        
        // Wait for tag editors to be ready before setting tags
        const setTagsWhenReady = () => {
            if (job.keywords && job.keywords.positive) {
                const positiveEditor = window.tagEditors['positive_keywords'];
                if (positiveEditor && typeof positiveEditor.setTags === 'function') {
                    positiveEditor.setTags(job.keywords.positive);
                } else {
                    // Retry if not ready yet
                    setTimeout(setTagsWhenReady, 50);
                }
            }
            if (job.keywords && job.keywords.negative) {
                const negativeEditor = window.tagEditors['negative_keywords'];
                if (negativeEditor && typeof negativeEditor.setTags === 'function') {
                    negativeEditor.setTags(job.keywords.negative);
                } else {
                    // Retry if not ready yet
                    setTimeout(setTagsWhenReady, 50);
                }
            }
        };
        
        setTagsWhenReady();
    }, 200);
}

async function updateOptimizeButtonState(baseJobId) {
    const btn = document.getElementById('jobs-optimize-btn');
    const badge = document.getElementById('jobs-optimize-badge');
    const label = document.getElementById('jobs-optimize-label');
    if (!btn) return;

    if (!baseJobId) {
        btn.disabled = true;
        if (label) label.textContent = 'ä¼˜åŒ–è‚–åƒ';
        btn.title = 'è¯·é€‰æ‹©å²—ä½åè¯»å–äººç±»åé¦ˆæ•°æ®';
        btn.className = 'relative px-6 py-3 rounded-lg font-medium shadow-sm bg-gray-200 text-gray-500 cursor-not-allowed';
        if (badge) badge.classList.add('hidden');
        btn.onclick = null;
        return;
    }

    // Initial state: disabled + loading.
    btn.disabled = true;
    if (label) label.textContent = 'ä¼˜åŒ–è‚–åƒï¼ˆè¯»å–åé¦ˆä¸­ï¼‰';
    btn.title = 'æ­£åœ¨è¯»å–äººç±»åé¦ˆæ•°æ®...';
    btn.className = 'relative px-6 py-3 rounded-lg font-medium shadow-sm bg-gray-200 text-gray-500 cursor-not-allowed';
    if (badge) badge.classList.add('hidden');

    try {
        const resp = await fetch(`/jobs/api/optimizations/count?job_id=${encodeURIComponent(baseJobId)}`);
        const data = await resp.json();
        const count = parseInt(data?.data?.count ?? 0, 10) || 0;

        // Always restore base button text
        if (label) label.textContent = 'ä¼˜åŒ–è‚–åƒ';

        if (count <= 0) {
            btn.disabled = true;
            btn.title = 'ä¼˜åŒ–æ¸…å•ä¸ºç©ºï¼šè¯·å»â€œæŸ¥è¯¢â€é¡µæ‰“å¼€å€™é€‰äººè¯¦æƒ…ï¼Œç‚¹å‡»â€œè¯„åˆ†ä¸å‡†â€æ·»åŠ åé¦ˆ';
            btn.className = 'relative px-6 py-3 rounded-lg font-medium shadow-sm bg-red-900 text-white cursor-not-allowed';
            if (badge) badge.classList.add('hidden');
            btn.onclick = null;
            return;
        }

        // Has feedback: enable + show badge, click to optimize directly.
        btn.disabled = false;
        btn.title = '';
        btn.className = 'relative px-6 py-3 rounded-lg font-medium shadow-sm bg-green-600 text-white hover:bg-green-700';
        if (badge) {
            badge.textContent = String(count);
            badge.classList.remove('hidden');
        }
        btn.onclick = () => {
            window.location.href = `/jobs/optimize?job_id=${encodeURIComponent(baseJobId)}`;
        };
    } catch (e) {
        console.error('Failed to load optimization count:', e);
        btn.disabled = true;
        if (label) label.textContent = 'ä¼˜åŒ–è‚–åƒ';
        btn.title = 'è¯»å–äººç±»åé¦ˆå¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•';
        btn.className = 'relative px-6 py-3 rounded-lg font-medium shadow-sm bg-gray-200 text-gray-500 cursor-not-allowed';
        if (badge) badge.classList.add('hidden');
        btn.onclick = null;
    }
}

// Load new job form
async function loadNewJobForm() {
    // Generate form HTML using helper function
    const content = document.getElementById('job-content');
    content.innerHTML = generateJobFormHTML({
        isNew: true,
        job: {}
    });
    
    // Initialize tag editors
    setTimeout(() => {
        initializeTagEditors();
    }, 200);
}

// Initialize tag editors
function initializeTagEditors() {
    if (!window.tagEditors) {
        window.tagEditors = {};
    }
    
    // Always (re)bind editors to the current DOM containers for this view
    document.querySelectorAll('.tag-editor').forEach(container => {
        const fieldName = container.dataset.field;
        if (!fieldName) return;
        // Replace any existing instance to avoid stale bindings after tab switch
        window.tagEditors[fieldName] = new TagEditor(container);
    });
}

// Save or create job (unified function)
async function saveJob(event) {
    event.preventDefault();
    const jobData = extractJobDataFromForm();
    if (!jobData) return;
    
    const isNewJob = currentJobIndex === -1 || currentJobIndex >= jobsData.length;
    const baseJobId = getBaseJobId(jobData.job_id || '');
    const endpoint = isNewJob ? '/jobs/create' : `/jobs/${baseJobId}/update`;
    
    try {
        const result = await apiCall(endpoint, 'POST', jobData);
        if (result.success) {
            showToast(isNewJob ? 'å²—ä½å·²åˆ›å»º' : 'å²—ä½å·²ä¿å­˜', 'success');
            await loadJobsData();
            
            if (isNewJob) {
                const jobIndex = jobsData.findIndex(j => {
                    const jBaseId = j.base_job_id || getBaseJobId(j.job_id || '');
                    return jBaseId === baseJobId;
                });
                if (jobIndex !== -1) {
                    switchToJob(jobIndex);
                } else if (jobsData.length > 0) {
                    switchToJob(jobsData.length - 1);
                }
            }
        } else {
            showToast((isNewJob ? 'åˆ›å»º' : 'ä¿å­˜') + 'å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
    } catch (error) {
        showToast((isNewJob ? 'åˆ›å»º' : 'ä¿å­˜') + 'å¤±è´¥: ' + error.message, 'error');
    }
}

// Alias for createJob (for backward compatibility with form onsubmit)
async function createJob(event) {
    return saveJob(event);
}

// Delete job version
async function deleteJob(job_id, version, totalVersions) {
    const baseJobId = getBaseJobId(job_id);
    
    // Special handling when only 1 version left
    if (totalVersions <= 1) {
        const confirmed = await showDeleteJobConfirm(`ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå²—ä½å—ï¼Ÿ\nåˆ é™¤åå°†æ— æ³•æ¢å¤ï¼`, 'åˆ é™¤å²—ä½');
        if (!confirmed) return;
    } else {
        const confirmed = await showConfirm(`æ‚¨ç¡®å®šè¦åˆ é™¤ç‰ˆæœ¬ v${version} å—ï¼Ÿ\næ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼`, 'åˆ é™¤ç‰ˆæœ¬');
        if (!confirmed) return;
    }
    
    try {
        const result = await apiCall(`/jobs/${baseJobId}/delete`, 'DELETE', { version });
        if (result.success) {
            if (totalVersions <= 1) {
                showToast('å²—ä½å·²åˆ é™¤', 'success');
            } else {
                showToast(`ç‰ˆæœ¬ v${version} å·²åˆ é™¤`, 'success');
            }
            await loadJobsData();
            const jobIndex = jobsData.findIndex(j => getBaseJobId(j.job_id || j.base_job_id || '') === baseJobId);
            if (jobIndex !== -1) {
                switchToJob(jobIndex);
            } else if (jobsData.length > 0) {
                switchToJob(0);
            } else {
                loadNewJobForm();
            }
        } else {
            showToast('åˆ é™¤å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
    } catch (error) {
        showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
    }
}

// Create new job
function createNewJob() {
    switchToJob(jobsData.length);
}

// Switch to view a different version
async function switchVersion(baseJobId, version) {
    const versionNum = parseInt(version);
    if (isNaN(versionNum)) return;
    
    try {
        // Fetch the full job data for the specific version
        const versionedJobId = `${baseJobId}_v${versionNum}`;
        const result = await apiCall(`/jobs/api/${versionedJobId}`);
        if (result.success && result.data) {
            loadJobForm(result.data);
        } else {
            showToast('ç‰ˆæœ¬æ•°æ®åŠ è½½å¤±è´¥', 'error');
        }
    } catch (error) {
        showToast('åˆ‡æ¢ç‰ˆæœ¬å¤±è´¥: ' + error.message, 'error');
    }
}

// Set a version as current
async function useThisVersion(baseJobId, version) {
    const versionNum = parseInt(version);
    if (isNaN(versionNum)) {
        showToast('æ— æ•ˆçš„ç‰ˆæœ¬å·', 'error');
        return;
    }
    const confirmed = await showConfirm(`ç¡®å®šè¦å°†ç‰ˆæœ¬ v${versionNum} è®¾ä¸ºå½“å‰ç‰ˆæœ¬å—ï¼Ÿ`, 'åˆ‡æ¢å½“å‰ç‰ˆæœ¬');
    if (!confirmed) return;
    
    try {
        const result = await apiCall(`/jobs/${baseJobId}/switch-version`, 'POST', { version: versionNum });
        if (result.success) {
            showToast('ç‰ˆæœ¬åˆ‡æ¢æˆåŠŸ', 'success');
            await loadJobsData();
            const jobIndex = jobsData.findIndex(j => getBaseJobId(j.job_id || j.base_job_id || '') === baseJobId);
            if (jobIndex !== -1) {
                switchToJob(jobIndex);
            }
        } else {
            showToast('åˆ‡æ¢ç‰ˆæœ¬å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
    } catch (error) {
        showToast('åˆ‡æ¢ç‰ˆæœ¬å¤±è´¥: ' + error.message, 'error');
    }
}

// Toggle job status and auto-save
async function toggleJobStatus(baseJobId, isActive) {
    const status = isActive ? 'active' : 'inactive';
    const savingEl = document.getElementById('job-status-saving');
    const savedEl = document.getElementById('job-status-saved');
    const labelEl = document.getElementById('job-status-label');
    
    // Show saving indicator
    if (savingEl) savingEl.style.display = '';
    if (savedEl) savedEl.style.display = 'none';
    
    try {
        const result = await apiCall(`/jobs/api/update-status`, 'POST', {
            job_id: baseJobId,
            status: status
        });
        
        if (result.success) {
            // Update label
            if (labelEl) labelEl.textContent = isActive ? 'æ¿€æ´»' : 'åœç”¨';
            
            // Show saved indicator
            if (savingEl) savingEl.style.display = 'none';
            if (savedEl) {
                savedEl.style.display = '';
                setTimeout(() => {
                    if (savedEl) savedEl.style.display = 'none';
                }, 2000);
            }
            
            // Update job data in memory
            const jobIndex = jobsData.findIndex(j => getBaseJobId(j.job_id || j.base_job_id || '') === baseJobId);
            if (jobIndex !== -1) {
                jobsData[jobIndex].status = status;
            }
            
            showToast(`å²—ä½çŠ¶æ€å·²æ›´æ–°ä¸º${isActive ? 'æ¿€æ´»' : 'åœç”¨'}`, 'success');
        } else {
            // Revert checkbox on error
            const toggleEl = document.getElementById('job-status-toggle');
            if (toggleEl) toggleEl.checked = !isActive;
            
            if (savingEl) savingEl.style.display = 'none';
            showToast('æ›´æ–°çŠ¶æ€å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
    } catch (error) {
        // Revert checkbox on error
        const toggleEl = document.getElementById('job-status-toggle');
        if (toggleEl) toggleEl.checked = !isActive;
        
        if (savingEl) savingEl.style.display = 'none';
        showToast('æ›´æ–°çŠ¶æ€å¤±è´¥: ' + error.message, 'error');
    }
}
</script>

<!-- Include tag editor styles and scripts -->
<style>
.tag-editor {
    position: relative;
}

.tooltip-container {
    position: relative;
    display: inline-block;
}

.tooltip-icon {
    cursor: help;
    color: #6b7280;
    margin-left: 4px;
    font-size: 16px;
}

.tooltip-content {
    visibility: hidden;
    position: absolute;
    bottom: 125%;
    left: 50%;
    transform: translateX(-50%);
    background-color: #1f2937;
    color: white;
    padding: 12px 16px;
    border-radius: 6px;
    white-space: normal;
    width: 400px;
    z-index: 1000;
    font-size: 14px;
    line-height: 1.5;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.tooltip-container:hover .tooltip-content {
    visibility: visible;
}

.tooltip-content a {
    color: #93c5fd;
}

.tooltip-content a:hover {
    color: #60a5fa;
}

.tag-input-container {
    position: relative;
}

.tag-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    margin-top: 2px;
}

.tag-suggestion {
    padding: 8px 12px;
    cursor: pointer;
    border-bottom: 1px solid #e5e7eb;
}

.tag-suggestion:hover {
    background-color: #f3f4f6;
}

.tag-suggestion:last-child {
    border-bottom: none;
}

.tag-item {
    display: inline-flex;
    align-items: center;
    background-color: #3b82f6;
    color: white;
    padding: 4px 8px;
    border-radius: 16px;
    font-size: 14px;
    margin: 2px;
}

.tag-item.negative {
    background-color: #ef4444;
}

.tag-remove {
    margin-left: 6px;
    cursor: pointer;
    font-weight: bold;
    opacity: 0.7;
}

.tag-remove:hover {
    opacity: 1;
}

.tag-list:empty::before {
    content: "æš‚æ— å…³é”®è¯";
    color: #9ca3af;
    font-style: italic;
}
</style>

<script>
// TagEditor class (simplified version)
class TagEditor {
    constructor(container) {
        this.container = container;
        this.fieldName = container.dataset.field;
        this.input = container.querySelector('.tag-input');
        this.tagList = container.querySelector('.tag-list');
        this.suggestions = container.querySelector('.tag-suggestions');
        this.tags = new Set();
        
        this.init();
    }
    
    init() {
        this.input.addEventListener('keydown', (e) => this.handleKeydown(e));
        this.input.addEventListener('input', (e) => this.handleInput(e));
        this.input.addEventListener('blur', () => this.hideSuggestions());
    }
    
    handleKeydown(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            this.addCurrentTag();
        } else if (e.key === 'Backspace' && this.input.value === '') {
            this.removeLastTag();
        } else if (e.key === ',' || e.key === ';') {
            e.preventDefault();
            this.addCurrentTag();
        }
    }
    
    handleInput(e) {
        const value = e.target.value.trim();
        if (value) {
            this.showSuggestions(value);
        } else {
            this.hideSuggestions();
        }
    }
    
    addCurrentTag() {
        const value = this.input.value.trim();
        if (value) {
            // Split by comma or semicolon and add each tag
            const tags = value.split(/[,;]/).map(tag => tag.trim()).filter(tag => tag);
            tags.forEach(tag => {
                if (!this.tags.has(tag)) {
                    this.addTag(tag);
                }
            });
            this.input.value = '';
        }
        this.hideSuggestions();
    }
    
    addTag(tag) {
        this.tags.add(tag);
        this.renderTags();
        this.updateHiddenInputs();
    }
    
    removeTag(tag) {
        this.tags.delete(tag);
        this.renderTags();
        this.updateHiddenInputs();
    }
    
    removeLastTag() {
        if (this.tags.size > 0) {
            const lastTag = Array.from(this.tags).pop();
            this.removeTag(lastTag);
        }
    }
    
    renderTags() {
        this.tagList.innerHTML = '';
        
        if (this.tags.size === 0) {
            return;
        }
        
        Array.from(this.tags).forEach(tag => {
            const tagElement = document.createElement('div');
            tagElement.className = `tag-item ${this.fieldName.includes('negative') ? 'negative' : ''}`;
            tagElement.innerHTML = `
                <span>${tag}</span>
                <span class="tag-remove" onclick="this.parentElement.remove(); window.tagEditors['${this.fieldName}'].removeTag('${tag}')">Ã—</span>
            `;
            this.tagList.appendChild(tagElement);
        });
    }
    
    updateHiddenInputs() {
        // Remove existing hidden inputs
        const existingInputs = document.querySelectorAll(`input[name="${this.fieldName}[]"]`);
        existingInputs.forEach(input => input.remove());
        
        // Add new hidden inputs for each tag
        Array.from(this.tags).forEach(tag => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = `${this.fieldName}[]`;
            input.value = tag;
            this.container.appendChild(input);
        });
    }
    
    showSuggestions(value) {
        const suggestions = this.getSuggestions(value);
        
        if (suggestions.length > 0) {
            this.suggestions.innerHTML = suggestions.map(suggestion => 
                `<div class="tag-suggestion" onclick="window.tagEditors['${this.fieldName}'].selectSuggestion('${suggestion}')">${suggestion}</div>`
            ).join('');
            this.suggestions.classList.remove('hidden');
        } else {
            this.hideSuggestions();
        }
    }
    
    getSuggestions(value) {
        const commonKeywords = [
            'Python', 'Java', 'JavaScript', 'React', 'Vue', 'Node.js',
            'æœºå™¨å­¦ä¹ ', 'æ·±åº¦å­¦ä¹ ', 'AI', 'ç®—æ³•', 'æ•°æ®ç»“æ„',
            'å¾®æœåŠ¡', 'åˆ†å¸ƒå¼', 'é«˜å¹¶å‘', 'é«˜å¯ç”¨', 'äº‘åŸç”Ÿ'
        ];
        
        return commonKeywords.filter(keyword => 
            keyword.toLowerCase().includes(value.toLowerCase()) && 
            !this.tags.has(keyword)
        ).slice(0, 5);
    }
    
    selectSuggestion(suggestion) {
        this.addTag(suggestion);
        this.input.value = '';
        this.hideSuggestions();
    }
    
    hideSuggestions() {
        this.suggestions.classList.add('hidden');
    }
    
    setTags(tags) {
        this.tags.clear();
        tags.forEach(tag => this.addTag(tag));
    }
}

// Validate and format candidate filters JSON
function validateCandidateFilters() {
    const el = document.getElementById('candidate_filters_json');
    const validationEl = document.getElementById('candidate_filters_validation');
    if (!el) return true;
    if (!validationEl) return true;
    
    const value = el.value.trim();
    if (!value) {
        validationEl.textContent = '';
        el.classList.remove('border-red-500', 'border-green-500');
        el.classList.add('border-gray-300');
        return true;
    }
    
    try {
        JSON.parse(value);
        validationEl.textContent = 'âœ“ JSON æ ¼å¼æ­£ç¡®';
        validationEl.className = 'text-xs mt-1 text-green-600';
        el.classList.remove('border-red-500');
        el.classList.add('border-gray-300');
        return true;
    } catch (e) {
        validationEl.textContent = 'âœ— JSON æ ¼å¼é”™è¯¯: ' + e.message;
        validationEl.className = 'text-xs mt-1 text-red-600';
        el.classList.remove('border-gray-300', 'border-green-500');
        el.classList.add('border-red-500');
        return false;
    }
}

// Format candidate filters (validates and formats)
function formatCandidateFilters() {
    const el = document.getElementById('candidate_filters_json');
    if (!el) return;
    const value = el.value.trim();
    if (!value) {
        el.value = '';
        const validationEl = document.getElementById('candidate_filters_validation');
        if (validationEl) validationEl.textContent = '';
        return;
    }
    try {
        const parsed = JSON.parse(value);
        el.value = JSON.stringify(parsed, null, 2);
        validateCandidateFilters(); // Update validation display
    } catch (e) {
        validateCandidateFilters(); // Show error
    }
}

// ---------------------------------------------------------------------------
// Requirements (text) helpers
// ---------------------------------------------------------------------------

function getRequirementsTemplateText() {
    return [
        '30 é—¨æ§›ï¼šç¡¬æ€§æ¡ä»¶1ï¼›ç¡¬æ€§æ¡ä»¶2ï¼›ç¡¬æ€§æ¡ä»¶3ï¼ˆèƒ½ä»ç®€å†åˆ¤æ–­æ»¡è¶³/ä¸æ»¡è¶³/æœªä½“ç°ï¼‰',
        '45 åœºæ™¯ï¼šå…³é”®åœºæ™¯1ï¼ˆäº²å†/å–èˆ/é‡åŒ–æŒ‡æ ‡/ä½ è´Ÿè´£çš„éƒ¨åˆ†ï¼‰ï¼›å…³é”®åœºæ™¯2ï¼›å…³é”®åœºæ™¯3',
        '15 åŸºç¡€ï¼šè¡¨è¾¾ç»“æ„åŒ–ï¼›èƒ½é‡åŒ–ç»“æœï¼›å­¦ä¹ è¿ç§»èƒ½åŠ›',
        '10 å¥‘åˆï¼šOwneræ„è¯†ï¼›åä½œæ¨è¿›ï¼ˆä¸èŠç»©æ•ˆç®¡ç†ï¼‰',
        'å¤‡æ³¨ï¼šç¼ºå¤±ä¿¡æ¯å¯è®°ä¸ºæ½œåŠ›ï¼ˆæœ€å¤šæŒ‰50%è®¡å…¥ï¼‰ï¼›PASSä¸å‘æ¶ˆæ¯ï¼›CONTACTç›´æ¥è¯·æ±‚å¾®ä¿¡/ç”µè¯ã€‚',
    ].join('\\n');
}

function validateRequirementsText() {
    const el = document.getElementById('requirements');
    const validationEl = document.getElementById('requirements_validation');
    if (!el) return true;
    if (!validationEl) return true;

    const value = el.value.trim();
    if (!value) {
        validationEl.textContent = 'âœ— è¯„åˆ†æ ‡å‡†ä¸èƒ½ä¸ºç©º';
        validationEl.className = 'text-xs mt-1 text-red-600';
        el.classList.remove('border-gray-300', 'border-green-500');
        el.classList.add('border-red-500');
        return false;
    }

    const normalized = value.replaceAll(' ', '');
    const required = ['é—¨æ§›', 'åœºæ™¯', 'åŸºç¡€', 'å¥‘åˆ'];
    const missing = required.filter(k => !normalized.includes(k));

    // Optional: parse leading weights like "30 é—¨æ§›ï¼š..."
    const weightRe = /^\s*(\d+)\s*(é—¨æ§›|åœºæ™¯|åŸºç¡€|å¥‘åˆ|threshold|scenarios|foundation|fit)\s*[:ï¼š]/i;
    const lines = value.split('\n').map(l => l.trim()).filter(Boolean);
    let weightSum = 0;
    let weightCount = 0;
    for (const line of lines) {
        const m = line.match(weightRe);
        if (!m) continue;
        weightCount += 1;
        weightSum += Number(m[1]);
    }

    const hints = [];
    if (missing.length) hints.push('å»ºè®®è¡¥é½ï¼š' + missing.join('ã€'));
    if (weightCount >= 2 && weightSum !== 100) hints.push(`æƒé‡ä¹‹å’Œå»ºè®®=100ï¼ˆå½“å‰=${weightSum}ï¼‰`);

    if (hints.length) {
        validationEl.textContent = 'âœ“ å·²å¡«å†™ï¼ˆ' + hints.join('ï¼›') + 'ï¼‰';
        validationEl.className = 'text-xs mt-1 text-yellow-600';
    } else {
        validationEl.textContent = 'âœ“ å·²å¡«å†™';
        validationEl.className = 'text-xs mt-1 text-green-600';
    }
    el.classList.remove('border-red-500');
    el.classList.add('border-gray-300');
    return true;
}

function insertRequirementsTemplate() {
    const el = document.getElementById('requirements');
    if (!el) return;
    el.value = getRequirementsTemplateText();
    validateRequirementsText();
}
</script>
{% endblock %}
