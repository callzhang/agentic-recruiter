{% extends "base.html" %}

{% block title %}å²—ä½ç”»åƒ - BOSSæ‹›è˜åŠ©æ‰‹{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page header -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">å²—ä½ç”»åƒ</h1>
                <p class="text-gray-600 mt-2">ç®¡ç†æ‹›è˜å²—ä½çš„èƒŒæ™¯ã€èŒè´£ã€è¦æ±‚å’Œç†æƒ³äººé€‰ç”»åƒ</p>
            </div>
            <button onclick="createNewJob()"
                    class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                â• åˆ›å»ºæ–°å²—ä½
            </button>
        </div>
    </div>
    
    <!-- Jobs management -->
    <div class="bg-white rounded-lg shadow-lg">
        <div class="flex border-b border-gray-200">
            <!-- Job tabs will be populated here -->
            <div id="job-tabs" class="flex">
                <!-- Tabs will be generated by JavaScript -->
            </div>
        </div>
        
        <!-- Job content -->
        <div id="job-content" class="p-6">
            <div class="text-center text-gray-500 py-12">
                <div>è¯·é€‰æ‹©å²—ä½...</div>
            </div>
        </div>
    </div>
</div>

<script>
// Job data - will be populated from server
let jobsData = {{ jobs | tojson }};
let currentJobIndex = -1;

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    renderJobTabs();
    if (jobsData.length > 0) {
        switchToJob(0);
    }
});

// Render job tabs
function renderJobTabs() {
    const tabsContainer = document.getElementById('job-tabs');
    let tabsHtml = '';
    
    // Add existing job tabs
    jobsData.forEach((job, index) => {
        const activeClass = index === currentJobIndex ? 'active bg-blue-50 border-blue-500 text-blue-700' : 'inactive bg-gray-50 border-gray-300 text-gray-700';
        tabsHtml += `
            <button class="job-tab px-4 py-2 border-b-2 ${activeClass} hover:bg-blue-50 transition-colors"
                    onclick="switchToJob(${index})">
                ${job.position}
            </button>
        `;
    });
    
    // Add new job tab
    const newJobActiveClass = currentJobIndex === jobsData.length ? 'active bg-blue-50 border-blue-500 text-blue-700' : 'inactive bg-gray-50 border-gray-300 text-gray-700';
    tabsHtml += `
        <button class="job-tab px-4 py-2 border-b-2 ${newJobActiveClass} hover:bg-blue-50 transition-colors"
                onclick="switchToJob(${jobsData.length})">
            â• æ–°å¢å²—ä½
        </button>
    `;
    
    tabsContainer.innerHTML = tabsHtml;
}

// Switch to a specific job
function switchToJob(jobIndex) {
    currentJobIndex = jobIndex;
    renderJobTabs();
    
    if (jobIndex < jobsData.length) {
        // Load existing job
        loadJobForm(jobsData[jobIndex]);
    } else {
        // Load new job form
        loadNewJobForm();
    }
}

// Load job form
function loadJobForm(job) {
    const content = document.getElementById('job-content');
    content.innerHTML = `
        <!-- Job form content -->
        <div class="max-w-6xl mx-auto space-y-6">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <form id="job-form" onsubmit="saveJob(event)">
                    <input type="hidden" name="job_id" value="${job.id}">
                    
                    <!-- Basic Information -->
                    <div class="space-y-4">
                        <h2 class="text-xl font-semibold text-gray-800">åŸºæœ¬ä¿¡æ¯</h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="job_id" class="block text-sm font-medium text-gray-700 mb-2">å²—ä½ ID *</label>
                                <input type="text" id="job_id" name="job_id" required
                                       value="${job.id}"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="ä¾‹å¦‚: python_developer">
                            </div>
                            
                            <div>
                                <label for="position" class="block text-sm font-medium text-gray-700 mb-2">å²—ä½åç§° *</label>
                                <input type="text" id="position" name="position" required
                                       value="${job.position || ''}"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="ä¾‹å¦‚: Pythonå¼€å‘å·¥ç¨‹å¸ˆ">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Job Details -->
                    <div class="space-y-4 mt-8">
                        <h2 class="text-xl font-semibold text-gray-800">å²—ä½è¯¦æƒ…</h2>
                        
                        <div>
                            <label for="background" class="block text-sm font-medium text-gray-700 mb-2">å…¬å¸èƒŒæ™¯</label>
                            <textarea id="background" name="background" rows="4"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                      placeholder="æè¿°å…¬å¸èƒŒæ™¯å’Œä¸šåŠ¡...">${job.background || ''}</textarea>
                        </div>
                        
                        <div>
                            <label for="responsibilities" class="block text-sm font-medium text-gray-700 mb-2">ä¸»è¦èŒè´£</label>
                            <textarea id="responsibilities" name="responsibilities" rows="4"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                      placeholder="æè¿°å²—ä½çš„ä¸»è¦èŒè´£...">${job.responsibilities || ''}</textarea>
                        </div>
                        
                        <div>
                            <label for="requirements" class="block text-sm font-medium text-gray-700 mb-2">ä»»èŒè¦æ±‚</label>
                            <textarea id="requirements" name="requirements" rows="4"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                      placeholder="æè¿°ä»»èŒè¦æ±‚...">${job.requirements || ''}</textarea>
                        </div>
                        
                        <div>
                            <label for="description" class="block text-sm font-medium text-gray-700 mb-2">å²—ä½æ¦‚è¿°</label>
                            <textarea id="description" name="description" rows="4"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                      placeholder="æè¿°å²—ä½æ¦‚è¿°...">${job.description || ''}</textarea>
                        </div>
                        
                        <div>
                            <label for="target_profile" class="block text-sm font-medium text-gray-700 mb-2">ç†æƒ³äººé€‰</label>
                            <textarea id="target_profile" name="target_profile" rows="4"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                      placeholder="æè¿°ç†æƒ³äººé€‰ç‰¹å¾...">${job.target_profile || ''}</textarea>
                        </div>
                    </div>
                    
                    <!-- Keywords -->
                    <div class="space-y-4 mt-8">
                        <h2 class="text-xl font-semibold text-gray-800">å…³é”®è¯</h2>
                        <p class="text-sm text-gray-500">ç”¨äºåŒ¹é…å€™é€‰äººçš„å…³é”®è¯ï¼Œæ­£å‘å…³é”®è¯è¡¨ç¤ºå¸Œæœ›å…·å¤‡çš„æŠ€èƒ½ï¼Œè´Ÿå‘å…³é”®è¯è¡¨ç¤ºä¸å¸Œæœ›å…·å¤‡çš„æŠ€èƒ½</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">æ­£å‘å…³é”®è¯</label>
                                <div id="positive-keywords-editor" class="tag-editor" data-field="positive_keywords">
                                    <div class="tag-input-container">
                                        <input type="text" 
                                               class="tag-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                               placeholder="è¾“å…¥å…³é”®è¯åå›è½¦"
                                               data-field="positive_keywords">
                                        <div class="tag-suggestions hidden absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-40 overflow-y-auto">
                                            <!-- Suggestions will be populated here -->
                                        </div>
                                    </div>
                                    <div class="tag-list flex flex-wrap gap-2 mt-2 min-h-[40px] p-2 border border-gray-200 rounded-md bg-gray-50">
                                        <!-- Tags will be rendered here -->
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">è´Ÿå‘å…³é”®è¯</label>
                                <div id="negative-keywords-editor" class="tag-editor" data-field="negative_keywords">
                                    <div class="tag-input-container">
                                        <input type="text" 
                                               class="tag-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                               placeholder="è¾“å…¥å…³é”®è¯åå›è½¦"
                                               data-field="negative_keywords">
                                        <div class="tag-suggestions hidden absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-40 overflow-y-auto">
                                            <!-- Suggestions will be populated here -->
                                        </div>
                                    </div>
                                    <div class="tag-list flex flex-wrap gap-2 mt-2 min-h-[40px] p-2 border border-gray-200 rounded-md bg-gray-50">
                                        <!-- Tags will be rendered here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Form Actions -->
                    <div class="flex gap-4 mt-8 pt-6 border-t">
                        <button type="submit" 
                                class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                            ğŸ’¾ ä¿å­˜
                        </button>
                        
                        <button type="button" onclick="deleteJob('${job.id}')" 
                                class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium">
                            ğŸ—‘ï¸ åˆ é™¤å²—ä½
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;
    
    // Initialize tag editors with existing data
    setTimeout(() => {
        initializeTagEditors();
        if (job.keywords && job.keywords.positive) {
            const positiveEditor = window.tagEditors['positive_keywords'];
            if (positiveEditor) {
                positiveEditor.setTags(job.keywords.positive);
            }
        }
        if (job.keywords && job.keywords.negative) {
            const negativeEditor = window.tagEditors['negative_keywords'];
            if (negativeEditor) {
                negativeEditor.setTags(job.keywords.negative);
            }
        }
    }, 100);
}

// Load new job form
function loadNewJobForm() {
    const content = document.getElementById('job-content');
    content.innerHTML = `
        <!-- New job form content -->
        <div class="max-w-6xl mx-auto space-y-6">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <form id="job-form" onsubmit="createJob(event)">
                    
                    <!-- Basic Information -->
                    <div class="space-y-4">
                        <h2 class="text-xl font-semibold text-gray-800">åŸºæœ¬ä¿¡æ¯</h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="job_id" class="block text-sm font-medium text-gray-700 mb-2">å²—ä½ ID *</label>
                                <input type="text" id="job_id" name="job_id" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="ä¾‹å¦‚: python_developer">
                            </div>
                            
                            <div>
                                <label for="position" class="block text-sm font-medium text-gray-700 mb-2">å²—ä½åç§° *</label>
                                <input type="text" id="position" name="position" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="ä¾‹å¦‚: Pythonå¼€å‘å·¥ç¨‹å¸ˆ">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Job Details -->
                    <div class="space-y-4 mt-8">
                        <h2 class="text-xl font-semibold text-gray-800">å²—ä½è¯¦æƒ…</h2>
                        
                        <div>
                            <label for="background" class="block text-sm font-medium text-gray-700 mb-2">å…¬å¸èƒŒæ™¯</label>
                            <textarea id="background" name="background" rows="4"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                      placeholder="æè¿°å…¬å¸èƒŒæ™¯å’Œä¸šåŠ¡..."></textarea>
                        </div>
                        
                        <div>
                            <label for="responsibilities" class="block text-sm font-medium text-gray-700 mb-2">ä¸»è¦èŒè´£</label>
                            <textarea id="responsibilities" name="responsibilities" rows="4"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                      placeholder="æè¿°å²—ä½çš„ä¸»è¦èŒè´£..."></textarea>
                        </div>
                        
                        <div>
                            <label for="requirements" class="block text-sm font-medium text-gray-700 mb-2">ä»»èŒè¦æ±‚</label>
                            <textarea id="requirements" name="requirements" rows="4"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                      placeholder="æè¿°ä»»èŒè¦æ±‚..."></textarea>
                        </div>
                        
                        <div>
                            <label for="description" class="block text-sm font-medium text-gray-700 mb-2">å²—ä½æ¦‚è¿°</label>
                            <textarea id="description" name="description" rows="4"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                      placeholder="æè¿°å²—ä½æ¦‚è¿°..."></textarea>
                        </div>
                        
                        <div>
                            <label for="target_profile" class="block text-sm font-medium text-gray-700 mb-2">ç†æƒ³äººé€‰</label>
                            <textarea id="target_profile" name="target_profile" rows="4"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                      placeholder="æè¿°ç†æƒ³äººé€‰ç‰¹å¾..."></textarea>
                        </div>
                    </div>
                    
                    <!-- Keywords -->
                    <div class="space-y-4 mt-8">
                        <h2 class="text-xl font-semibold text-gray-800">å…³é”®è¯</h2>
                        <p class="text-sm text-gray-500">ç”¨äºåŒ¹é…å€™é€‰äººçš„å…³é”®è¯ï¼Œæ­£å‘å…³é”®è¯è¡¨ç¤ºå¸Œæœ›å…·å¤‡çš„æŠ€èƒ½ï¼Œè´Ÿå‘å…³é”®è¯è¡¨ç¤ºä¸å¸Œæœ›å…·å¤‡çš„æŠ€èƒ½</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">æ­£å‘å…³é”®è¯</label>
                                <div id="positive-keywords-editor" class="tag-editor" data-field="positive_keywords">
                                    <div class="tag-input-container">
                                        <input type="text" 
                                               class="tag-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                               placeholder="è¾“å…¥å…³é”®è¯åå›è½¦"
                                               data-field="positive_keywords">
                                        <div class="tag-suggestions hidden absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-40 overflow-y-auto">
                                            <!-- Suggestions will be populated here -->
                                        </div>
                                    </div>
                                    <div class="tag-list flex flex-wrap gap-2 mt-2 min-h-[40px] p-2 border border-gray-200 rounded-md bg-gray-50">
                                        <!-- Tags will be rendered here -->
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">è´Ÿå‘å…³é”®è¯</label>
                                <div id="negative-keywords-editor" class="tag-editor" data-field="negative_keywords">
                                    <div class="tag-input-container">
                                        <input type="text" 
                                               class="tag-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                               placeholder="è¾“å…¥å…³é”®è¯åå›è½¦"
                                               data-field="negative_keywords">
                                        <div class="tag-suggestions hidden absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-40 overflow-y-auto">
                                            <!-- Suggestions will be populated here -->
                                        </div>
                                    </div>
                                    <div class="tag-list flex flex-wrap gap-2 mt-2 min-h-[40px] p-2 border border-gray-200 rounded-md bg-gray-50">
                                        <!-- Tags will be rendered here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Form Actions -->
                    <div class="flex gap-4 mt-8 pt-6 border-t">
                        <button type="submit" 
                                class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                            âœ¨ åˆ›å»º
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;
    
    // Initialize tag editors
    setTimeout(() => {
        initializeTagEditors();
    }, 100);
}

// Initialize tag editors
function initializeTagEditors() {
    if (!window.tagEditors) {
        window.tagEditors = {};
    }
    
    document.querySelectorAll('.tag-editor').forEach(container => {
        const fieldName = container.dataset.field;
        if (fieldName && !window.tagEditors[fieldName]) {
            window.tagEditors[fieldName] = new TagEditor(container);
        }
    });
}

// Save job
async function saveJob(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const jobData = Object.fromEntries(formData.entries());
    
    // Get keywords from tag editors
    const positiveKeywords = window.tagEditors['positive_keywords'] ? Array.from(window.tagEditors['positive_keywords'].tags) : [];
    const negativeKeywords = window.tagEditors['negative_keywords'] ? Array.from(window.tagEditors['negative_keywords'].tags) : [];
    
    jobData.keywords = {
        positive: positiveKeywords,
        negative: negativeKeywords
    };
    
    try {
        // Determine if this is a new job or an update
        const isNewJob = currentJobIndex === -1;
        const endpoint = isNewJob ? '/web/jobs/create' : `/web/jobs/${jobsData[currentJobIndex].id}/update`;
        
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(jobData)
        });
        
        const result = await response.json();
        console.log('Save response:', result);
        
        if (result.success) {
            alert('å²—ä½å·²ä¿å­˜');
            // Update local data
            const jobIndex = jobsData.findIndex(j => j.id === jobData.job_id);
            if (jobIndex !== -1) {
                jobsData[jobIndex] = jobData;
            }
            renderJobTabs();
        } else {
            alert('ä¿å­˜å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
        }
    } catch (error) {
        console.error('Save error:', error);
        alert('ä¿å­˜å¤±è´¥: ' + error.message);
    }
}

// Create job
async function createJob(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const jobData = Object.fromEntries(formData.entries());
    
    // Get keywords from tag editors
    const positiveKeywords = window.tagEditors['positive_keywords'] ? Array.from(window.tagEditors['positive_keywords'].tags) : [];
    const negativeKeywords = window.tagEditors['negative_keywords'] ? Array.from(window.tagEditors['negative_keywords'].tags) : [];
    
    jobData.keywords = {
        positive: positiveKeywords,
        negative: negativeKeywords
    };
    
    try {
        const response = await fetch('/web/jobs/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(jobData)
        });
        
        const result = await response.json();
        console.log('Create response:', result);
        
        if (result.success) {
            alert('å²—ä½å·²åˆ›å»º');
            // Add to local data
            jobsData.push(jobData);
            renderJobTabs();
            switchToJob(jobsData.length - 1);
        } else {
            alert('åˆ›å»ºå¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
        }
    } catch (error) {
        console.error('Create error:', error);
        alert('åˆ›å»ºå¤±è´¥: ' + error.message);
    }
}

// Delete job
async function deleteJob(jobId) {
    if (confirm('âš ï¸ æ‚¨ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå²—ä½å—ï¼Ÿ\næ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼')) {
        try {
            const response = await fetch(`/web/jobs/${jobId}/delete`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert('å²—ä½å·²åˆ é™¤');
                // Remove from local data
                jobsData = jobsData.filter(j => j.id !== jobId);
                renderJobTabs();
                if (jobsData.length > 0) {
                    switchToJob(0);
                } else {
                    loadNewJobForm();
                }
            } else {
                alert('åˆ é™¤å¤±è´¥: ' + result.error);
            }
        } catch (error) {
            alert('åˆ é™¤å¤±è´¥: ' + error);
        }
    }
}

// Create new job
function createNewJob() {
    switchToJob(jobsData.length);
}
</script>

<!-- Include tag editor styles and scripts -->
<style>
.tag-editor {
    position: relative;
}

.tag-input-container {
    position: relative;
}

.tag-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    margin-top: 2px;
}

.tag-suggestion {
    padding: 8px 12px;
    cursor: pointer;
    border-bottom: 1px solid #e5e7eb;
}

.tag-suggestion:hover {
    background-color: #f3f4f6;
}

.tag-suggestion:last-child {
    border-bottom: none;
}

.tag-item {
    display: inline-flex;
    align-items: center;
    background-color: #3b82f6;
    color: white;
    padding: 4px 8px;
    border-radius: 16px;
    font-size: 14px;
    margin: 2px;
}

.tag-item.negative {
    background-color: #ef4444;
}

.tag-remove {
    margin-left: 6px;
    cursor: pointer;
    font-weight: bold;
    opacity: 0.7;
}

.tag-remove:hover {
    opacity: 1;
}

.tag-list:empty::before {
    content: "æš‚æ— å…³é”®è¯";
    color: #9ca3af;
    font-style: italic;
}
</style>

<script>
// TagEditor class (simplified version)
class TagEditor {
    constructor(container) {
        this.container = container;
        this.fieldName = container.dataset.field;
        this.input = container.querySelector('.tag-input');
        this.tagList = container.querySelector('.tag-list');
        this.suggestions = container.querySelector('.tag-suggestions');
        this.tags = new Set();
        
        this.init();
    }
    
    init() {
        this.input.addEventListener('keydown', (e) => this.handleKeydown(e));
        this.input.addEventListener('input', (e) => this.handleInput(e));
        this.input.addEventListener('blur', () => this.hideSuggestions());
    }
    
    handleKeydown(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            this.addCurrentTag();
        } else if (e.key === 'Backspace' && this.input.value === '') {
            this.removeLastTag();
        }
    }
    
    handleInput(e) {
        const value = e.target.value.trim();
        if (value) {
            this.showSuggestions(value);
        } else {
            this.hideSuggestions();
        }
    }
    
    addCurrentTag() {
        const value = this.input.value.trim();
        if (value && !this.tags.has(value)) {
            this.addTag(value);
            this.input.value = '';
        }
        this.hideSuggestions();
    }
    
    addTag(tag) {
        this.tags.add(tag);
        this.renderTags();
        this.updateHiddenInputs();
    }
    
    removeTag(tag) {
        this.tags.delete(tag);
        this.renderTags();
        this.updateHiddenInputs();
    }
    
    removeLastTag() {
        if (this.tags.size > 0) {
            const lastTag = Array.from(this.tags).pop();
            this.removeTag(lastTag);
        }
    }
    
    renderTags() {
        this.tagList.innerHTML = '';
        
        if (this.tags.size === 0) {
            return;
        }
        
        Array.from(this.tags).forEach(tag => {
            const tagElement = document.createElement('div');
            tagElement.className = `tag-item ${this.fieldName.includes('negative') ? 'negative' : ''}`;
            tagElement.innerHTML = `
                <span>${tag}</span>
                <span class="tag-remove" onclick="this.parentElement.remove(); window.tagEditors['${this.fieldName}'].removeTag('${tag}')">Ã—</span>
            `;
            this.tagList.appendChild(tagElement);
        });
    }
    
    updateHiddenInputs() {
        // Remove existing hidden inputs
        const existingInputs = document.querySelectorAll(`input[name="${this.fieldName}[]"]`);
        existingInputs.forEach(input => input.remove());
        
        // Add new hidden inputs for each tag
        Array.from(this.tags).forEach(tag => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = `${this.fieldName}[]`;
            input.value = tag;
            this.container.appendChild(input);
        });
    }
    
    showSuggestions(value) {
        const suggestions = this.getSuggestions(value);
        
        if (suggestions.length > 0) {
            this.suggestions.innerHTML = suggestions.map(suggestion => 
                `<div class="tag-suggestion" onclick="window.tagEditors['${this.fieldName}'].selectSuggestion('${suggestion}')">${suggestion}</div>`
            ).join('');
            this.suggestions.classList.remove('hidden');
        } else {
            this.hideSuggestions();
        }
    }
    
    getSuggestions(value) {
        const commonKeywords = [
            'Python', 'Java', 'JavaScript', 'React', 'Vue', 'Node.js',
            'æœºå™¨å­¦ä¹ ', 'æ·±åº¦å­¦ä¹ ', 'AI', 'ç®—æ³•', 'æ•°æ®ç»“æ„',
            'å¾®æœåŠ¡', 'åˆ†å¸ƒå¼', 'é«˜å¹¶å‘', 'é«˜å¯ç”¨', 'äº‘åŸç”Ÿ'
        ];
        
        return commonKeywords.filter(keyword => 
            keyword.toLowerCase().includes(value.toLowerCase()) && 
            !this.tags.has(keyword)
        ).slice(0, 5);
    }
    
    selectSuggestion(suggestion) {
        this.addTag(suggestion);
        this.input.value = '';
        this.hideSuggestions();
    }
    
    hideSuggestions() {
        this.suggestions.classList.add('hidden');
    }
    
    setTags(tags) {
        this.tags.clear();
        tags.forEach(tag => this.addTag(tag));
    }
}
</script>
{% endblock %}
