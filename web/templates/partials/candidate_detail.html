<!-- Candidate detail view with automatic workflow -->
<div class="space-y-6">
    
    <!-- Header -->
    <div class="flex justify-between items-start">
        <div>
            <h2 class="text-2xl font-bold text-gray-900">{{ candidate.name or 'æœªçŸ¥å€™é€‰äºº' }}</h2>
            <p class="text-gray-600">{{ candidate.job_applied or candidate.job_title or 'æœªæŒ‡å®šå²—ä½' }}</p>
        </div>
        <div class="flex space-x-2">
            {% if candidate.stage %}
            <span class="px-4 py-2 rounded-lg font-medium
                {% if candidate.stage == 'PASS' %}bg-gray-200 text-gray-700
                {% elif candidate.stage == 'GREET' %}bg-green-200 text-green-700
                {% elif candidate.stage == 'SEEK' %}bg-yellow-200 text-yellow-700
                {% elif candidate.stage == 'CONTACT' %}bg-blue-200 text-blue-700
                {% else %}bg-gray-100 text-gray-600{% endif %}">
                {{ candidate.stage }}
            </span>
            {% endif %}
        </div>
    </div>

    <!-- Hidden context for HTMX requests -->
    <div id="candidate-context" class="hidden">
        {% if candidate.mode == 'recommend' %}
        <input type="hidden" name="index" value="{{ candidate.index }}">
        {% else %}
        <input type="hidden" name="chat_id" value="{{ candidate.chat_id }}">
        {% endif %}
        <input type="hidden" name="mode" value="{{ candidate.mode or 'chat' }}">
        <input type="hidden" name="name" value="{{ candidate.name or '' }}">
        <input type="hidden" name="resume_text" id="hidden-resume-text" value="{{ candidate.full_resume or candidate.resume_text or '' }}">
        <input type="hidden" name="assistant_id" value="{{ assistant_id }}">
        <input type="hidden" name="job_id" value="{{ job_id }}">
    </div>
    
    <!-- Automatic workflow after resume is loaded -->
    <script>
        // Listen for when resume content is swapped in
        document.body.addEventListener('htmx:afterSwap', function(event) {
            // Only trigger for resume content updates
            if (event.detail.target.id !== 'resume-content') {
                return;
            }
            
            console.log('Resume swapped! Target:', event.detail.target);
            console.log('Resume content HTML:', event.detail.target.innerHTML.substring(0, 200));
            
            // Extract resume text from the textarea
            const textarea = document.querySelector('#resume-content textarea');
            if (!textarea) {
                console.error('No resume textarea found');
                return;
            }
            
            const resumeText = textarea.value;
            console.log('Resume text length:', resumeText.length);
            
            if (!resumeText) {
                console.error('Resume text is empty');
                showToast('ç®€å†ä¸ºç©ºï¼Œæ— æ³•åˆ†æ', 'error');
                return;
            }
            
            // Update hidden context
            const hiddenInput = document.getElementById('hidden-resume-text');
            if (hiddenInput) {
                hiddenInput.value = resumeText;
                console.log('Updated hidden resume_text');
            }
            
            // Get candidate info
            const mode = document.querySelector('input[name="mode"]').value;
            const name = document.querySelector('input[name="name"]').value;
            const jobId = document.querySelector('input[name="job_id"]').value;
            
            // Get chat_id or index based on mode
            let chatId = null;
            if (mode === 'recommend') {
                const indexInput = document.querySelector('input[name="index"]');
                // For recommend candidates, chat_id is null
                chatId = null;
            } else {
                const chatIdInput = document.querySelector('input[name="chat_id"]');
                chatId = chatIdInput ? chatIdInput.value : null;
            }
            
            console.log('Candidate info:', { chatId, mode, name, jobId });
            
            // Call web-specific init-chat endpoint that handles data preparation
            console.log('Initializing chat...');
            showToast('åˆå§‹åŒ–å¯¹è¯çº¿ç¨‹...', 'info');
            
            // Step 1: Init chat via web endpoint (handles job_info loading and chat_history)
            // Use fetch() to send custom FormData
            const formData = new FormData();
            formData.append('mode', mode);
            if (chatId) formData.append('chat_id', chatId);
            formData.append('job_id', jobId);
            formData.append('name', name || (mode === 'recommend' ? 'æ¨èå€™é€‰äºº' : 'å€™é€‰äºº'));
            formData.append('resume_text', resumeText);
            
            fetch('/web/candidates/init-chat', {
                method: 'POST',
                body: formData
            }).then(response => {
                if (!response.ok) throw new Error('Init chat failed');
                return response.json();
            }).then(data => {
                console.log('Chat initialized:', data);
                // Store thread_id in hidden context for future requests
                if (data.thread_id) {
                    let threadInput = document.querySelector('input[name="thread_id"]');
                    if (!threadInput) {
                        threadInput = document.createElement('input');
                        threadInput.type = 'hidden';
                        threadInput.name = 'thread_id';
                        document.getElementById('candidate-context').appendChild(threadInput);
                    }
                    threadInput.value = data.thread_id;
                }
                return startAnalysis();
            }).catch(err => {
                console.error('Init chat error:', err);
                // Continue to analysis anyway (thread might already exist)
                return startAnalysis();
            });
            
            function startAnalysis() {
                console.log('Starting analysis...');
                showToast('å¼€å§‹åˆ†æå€™é€‰äºº...', 'info');
                
                // Get all required values from context
                const mode = document.querySelector('input[name="mode"]').value;
                const assistantId = document.querySelector('input[name="assistant_id"]').value;
                const threadId = document.querySelector('input[name="thread_id"]')?.value;
                const chatId = document.querySelector('input[name="chat_id"]')?.value;
                
                // Build FormData explicitly
                const analyzeFormData = new FormData();
                analyzeFormData.append('mode', mode);
                analyzeFormData.append('assistant_id', assistantId);
                if (threadId) analyzeFormData.append('thread_id', threadId);
                if (chatId) analyzeFormData.append('chat_id', chatId);
                
                htmx.ajax('POST', '/web/candidates/analyze', {
                    target: '#analysis-content',
                    swap: 'innerHTML',
                    values: Object.fromEntries(analyzeFormData)
                });
            }
        });
    </script>

    <!-- 1. Resume Section -->
    <div id="resume-section" class="bg-white rounded-lg border shadow-sm">
        <div class="p-4 border-b bg-gray-50">
            <h3 class="font-bold text-gray-800">ğŸ“„ å€™é€‰äººç®€å†</h3>
        </div>
        <div id="resume-content" class="p-4">
            {% if candidate.resume_text or candidate.full_resume %}
            <textarea readonly class="w-full h-64 p-4 bg-gray-50 border rounded-lg font-mono text-sm">{{ candidate.full_resume or candidate.resume_text }}</textarea>
            {% else %}
            <div class="text-center py-8 text-gray-500" 
                 hx-post="{% if candidate.mode == 'recommend' %}/web/candidates/fetch-recommend-resume{% else %}/web/candidates/fetch-online-resume{% endif %}"
                 hx-trigger="load"
                 hx-include="#candidate-context"
                 hx-target="#resume-content"
                 hx-swap="innerHTML">
                â³ æ­£åœ¨åŠ è½½ç®€å†...
            </div>
            {% endif %}
        </div>
    </div>

    <!-- 2. Analysis Section -->
    <div id="analysis-section" class="bg-white rounded-lg border shadow-sm">
        <div class="p-4 border-b bg-gray-50">
            <h3 class="font-bold text-gray-800">ğŸ“Š AI åˆ†æç»“æœ</h3>
        </div>
        <div id="analysis-content" class="p-4">
            {% if candidate.analysis %}
                {% include 'partials/analysis_result.html' %}
            {% else %}
            <div class="text-center py-8 text-gray-500" id="analysis-trigger">
                â³ ç­‰å¾…ç®€å†åŠ è½½å®Œæˆåè‡ªåŠ¨åˆ†æ...
            </div>
            {% endif %}
        </div>
    </div>

    <!-- 3. Generated Message Section (shown only if score >= borderline) -->
    <div id="message-section" class="bg-white rounded-lg border shadow-sm">
        <div class="p-4 border-b bg-gray-50">
            <h3 class="font-bold text-gray-800">âœ¨ è‡ªåŠ¨ç”Ÿæˆæ¶ˆæ¯</h3>
        </div>
        <div id="message-content" class="p-4">
            {% if generated_message %}
            <div class="space-y-4">
                <textarea id="message-text" name="message" class="w-full h-32 p-4 border rounded-lg">{{ generated_message }}</textarea>
                <div class="flex space-x-2">
                    <button hx-post="/web/candidates/send"
                            hx-include="#candidate-context,#message-text"
                            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        ğŸ“¤ å‘é€æ¶ˆæ¯
                    </button>
                    <button hx-post="/web/candidates/pass"
                            hx-include="#candidate-context"
                            class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                        â­ï¸ PASS
                    </button>
                </div>
            </div>
            {% else %}
            <div class="text-center py-8 text-gray-500">åˆ†æå®Œæˆåï¼Œå¦‚æœåŒ¹é…åº¦è¾¾æ ‡å°†è‡ªåŠ¨ç”Ÿæˆ...</div>
            {% endif %}
        </div>
    </div>

    <!-- 4. Chat History (for chat mode only) -->
    {% if candidate.mode != 'recommend' %}
    <div class="bg-white rounded-lg border shadow-sm">
        <div class="p-4 border-b bg-gray-50">
            <h3 class="font-bold text-gray-800">ğŸ’¬ èŠå¤©è®°å½•</h3>
        </div>
        <div id="chat-history" 
             hx-get="/web/candidates/history/{{ candidate.chat_id or candidate.id }}"
             hx-trigger="load"
             hx-swap="innerHTML"
             class="p-4">
            <div class="text-center text-gray-500">åŠ è½½ä¸­...</div>
        </div>
    </div>
    {% endif %}

    <!-- Manual Actions (always available) -->
    <div class="bg-gray-50 rounded-lg p-4 space-y-2">
        <h3 class="font-bold text-gray-800 mb-2">ğŸ”§ æ‰‹åŠ¨æ“ä½œ</h3>
        <div class="flex flex-wrap gap-2">
            <button hx-post="{% if candidate.mode == 'recommend' %}/web/candidates/fetch-recommend-resume{% else %}/web/candidates/fetch-online-resume{% endif %}"
                    hx-include="#candidate-context"
                    hx-target="#resume-content"
                    hx-swap="innerHTML"
                    class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                ğŸ”„ é‡æ–°è·å–ç®€å†
            </button>
            <button hx-post="/web/candidates/analyze"
                    hx-include="#candidate-context"
                    hx-target="#analysis-content"
                    hx-swap="innerHTML"
                    class="px-3 py-1 bg-purple-600 text-white text-sm rounded hover:bg-purple-700">
                ğŸ”„ é‡æ–°åˆ†æ
            </button>
            <button hx-post="/web/candidates/generate-message"
                    hx-include="#candidate-context"
                    hx-target="#message-content"
                    hx-swap="innerHTML"
                    class="px-3 py-1 bg-indigo-600 text-white text-sm rounded hover:bg-indigo-700">
                ğŸ”„ é‡æ–°ç”Ÿæˆæ¶ˆæ¯
            </button>
        </div>
    </div>

</div>
