{% extends "base.html" %}

{% block title %}æ•°æ®æŸ¥è¯¢ - BOSSæ‹›è˜åŠ©æ‰‹{% endblock %}

{% block content %}

<div class="space-y-6">
    <!-- Page header -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">ğŸ” æ•°æ®æŸ¥è¯¢</h1>
                <p class="text-gray-500 mt-1">é€šè¿‡å¤šæ¡ä»¶ç­›é€‰å¿«é€Ÿå®šä½å€™é€‰äººï¼Œç‚¹å‡»åˆ—è¡¨æŸ¥çœ‹è¯¦æƒ…</p>
            </div>
        </div>
        
        <!-- Search form -->
        <form id="search-form" class="space-y-6" 
              hx-get="/search/query"
              hx-target="#search-results"
              hx-indicator="#search-loading"
              hx-trigger="submit">
            <input type="hidden" name="sort_by" id="sort-by-input" value="updated_at">
            <input type="hidden" name="sort_dir" id="sort-dir-input" value="desc">
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                <div>
                    <label for="candidate-name" class="block text-sm font-medium text-gray-700 mb-1">
                        å€™é€‰äººå§“å
                    </label>
                    <input 
                        type="text" 
                        id="candidate-name" 
                        name="name"
                        placeholder="æ”¯æŒç²¾ç¡®åŒ¹é…"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    />
                </div>
                
                <div>
                    <label for="job-applied" class="block text-sm font-medium text-gray-700 mb-1">
                        å²—ä½
                    </label>
                    <select 
                        id="job-applied" 
                        name="job_applied"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    >
                        <option value="">å…¨éƒ¨å²—ä½</option>
                        {% for position in job_positions %}
                        <option value="{{ position }}">{{ position }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label for="stage" class="block text-sm font-medium text-gray-700 mb-1">
                        é˜¶æ®µ
                    </label>
                    <select 
                        id="stage" 
                        name="stage"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    >
                        <option value="">å…¨éƒ¨é˜¶æ®µ</option>
                        {% for stage in stage_options %}
                        <option value="{{ stage }}">{{ stage }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-4">
                <div>
                    <label for="score-min" class="block text-sm font-medium text-gray-700 mb-1">
                        æœ€ä½åŒ¹é…åº¦
                    </label>
                    <input 
                        type="number" 
                        id="score-min" 
                        name="score_min"
                        min="0"
                        max="10"
                        step="0.1"
                        placeholder="ä¾‹å¦‚ 7.5"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    />
                </div>
                
                <div>
                    <label for="notified" class="block text-sm font-medium text-gray-700 mb-1">
                        DingTalk é€šçŸ¥
                    </label>
                    <select 
                        id="notified" 
                        name="notified"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    >
                        <option value="">å…¨éƒ¨çŠ¶æ€</option>
                        <option value="true">å·²é€šçŸ¥</option>
                        <option value="false">æœªé€šçŸ¥</option>
                    </select>
                </div>
                
                <div>
                    <label for="contacted" class="block text-sm font-medium text-gray-700 mb-1">
                        å·²è”ç³»
                    </label>
                    <select 
                        id="contacted" 
                        name="contacted"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    >
                        <option value="">å…¨éƒ¨çŠ¶æ€</option>
                        <option value="true">å·²è”ç³»</option>
                        <option value="false">æœªè”ç³»</option>
                    </select>
                </div>
                
                <div>
                    <label for="date-from" class="block text-sm font-medium text-gray-700 mb-1">
                        æ›´æ–°æ—¥æœŸï¼ˆèµ·ï¼‰
                    </label>
                    <input 
                        type="date" 
                        id="date-from" 
                        name="date_from"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    />
                </div>
                
                <div>
                    <label for="date-to" class="block text-sm font-medium text-gray-700 mb-1">
                        æ›´æ–°æ—¥æœŸï¼ˆæ­¢ï¼‰
                    </label>
                    <input 
                        type="date" 
                        id="date-to" 
                        name="date_to"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    />
                </div>
                
                <div>
                    <label for="limit" class="block text-sm font-medium text-gray-700 mb-1">
                        ç»“æœæ•°é‡
                    </label>
                    <input 
                        type="number" 
                        id="limit" 
                        name="limit"
                        min="1"
                        max="500"
                        value="100"
                        placeholder="100"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    />
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div>
                    <label for="resume-contains" class="block text-sm font-medium text-gray-700 mb-1">
                        ç®€å†å…³é”®è¯
                    </label>
                    <input 
                        type="text" 
                        id="resume-contains" 
                        name="resume_contains"
                        placeholder="ä¾‹ï¼š26å¹´åº”å±Šç”Ÿ"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    />
                </div>
                
                <div>
                    <label for="semantic-query" class="block text-sm font-medium text-gray-700 mb-1">
                        è¯­ä¹‰æœç´¢
                    </label>
                    <input 
                        type="text" 
                        id="semantic-query" 
                        name="semantic_query"
                        placeholder="è¾“å…¥è‡ªç„¶è¯­è¨€æè¿°ï¼Œä¾‹å¦‚â€œè¿‘æœŸ NLP ç®—æ³•å·¥ç¨‹å¸ˆâ€"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    />
                    <p class="text-xs text-gray-500 mt-1">ä¸å…¶ä»–ç­›é€‰æ¡ä»¶åŒæ—¶ç”Ÿæ•ˆï¼Œç»“æœå°†æŒ‰è¯­ä¹‰ç›¸å…³åº¦æ’åºå†è¿‡æ»¤</p>
                </div>
            </div>
            
            <div class="flex flex-col md:flex-row gap-3 md:justify-end pt-2">
                <button 
                    type="button"
                    onclick="resetSearchFilters()"
                    class="px-5 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition font-medium flex items-center gap-2"
                >
                    <span>â™»ï¸</span>
                    <span>é‡ç½®æ¡ä»¶</span>
                </button>
                <button 
                    type="submit"
                    class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium flex items-center gap-2"
                >
                    <span>ğŸ”</span>
                    <span>æŸ¥è¯¢</span>
                </button>
            </div>
        </form>
    </div>
    
    <!-- Loading indicators -->
    <div id="search-loading" class="htmx-indicator fixed top-20 right-4 z-50 bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg flex items-center space-x-3">
        <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span class="font-medium">æŸ¥è¯¢ä¸­...</span>
    </div>
    <div id="candidate-loading" class="htmx-indicator fixed top-40 right-4 z-50 bg-indigo-600 text-white px-6 py-3 rounded-lg shadow-lg flex items-center space-x-3">
        <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span class="font-medium">åŠ è½½å€™é€‰äººè¯¦æƒ…...</span>
    </div>
    
    <!-- Result area -->
    <div class="flex flex-col xl:flex-row gap-6">
        <div class="xl:w-[40%] xl:min-w-[400px] space-y-4">
            <div id="search-results" class="min-h-[200px]">
                <div class="bg-white rounded-lg shadow p-12 text-center text-gray-500">
                    <p class="text-lg">ğŸ‘† è®¾ç½®ç­›é€‰æ¡ä»¶åç‚¹å‡»"æŸ¥è¯¢"å³å¯åŠ è½½å€™é€‰äººåˆ—è¡¨</p>
                </div>
            </div>
        </div>
        <div class="xl:w-[60%] xl:min-w-[600px]">
            <div id="candidate-detail-panel" class="bg-white rounded-lg shadow p-8 text-center text-gray-500 min-h-[200px]">
                <p class="text-lg">ğŸ‘ˆ ç‚¹å‡»å·¦ä¾§è¡¨æ ¼ä¸­çš„å€™é€‰äººæŸ¥çœ‹è¯¦æƒ…</p>
            </div>
        </div>
    </div>
</div>

<script>
const STORAGE_KEY = 'search_query_conditions';

// Save form values to localStorage
function saveFormState() {
    const form = document.getElementById('search-form');
    if (!form) return;
    
    const formData = new FormData(form);
    const state = {};
    for (const [key, value] of formData.entries()) {
        if (value) {
            state[key] = value;
        }
    }
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

// Restore form values from localStorage or URL parameters
function restoreFormState() {
    const form = document.getElementById('search-form');
    if (!form) return;
    
    // First, try to get values from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    let state = {};
    
    // Check if URL has query parameters
    const hasUrlParams = Array.from(urlParams.keys()).length > 0;
    
    if (hasUrlParams) {
        // Restore from URL parameters
        for (const [key, value] of urlParams.entries()) {
            state[key] = value;
        }
        // Save URL params to localStorage
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    } else {
        // Restore from localStorage
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            try {
                state = JSON.parse(saved);
            } catch (e) {
                console.error('Failed to parse saved form state:', e);
            }
        }
    }
    
    // Apply saved values to form
    for (const [key, value] of Object.entries(state)) {
        const field = form.querySelector(`[name="${key}"]`);
        if (field) {
            if (field.type === 'checkbox' || field.type === 'radio') {
                field.checked = field.value === value;
            } else {
                field.value = value;
            }
        }
    }
}

// Update URL with form values
function updateUrl() {
    const form = document.getElementById('search-form');
    if (!form) return;
    
    const formData = new FormData(form);
    const params = new URLSearchParams();
    
    for (const [key, value] of formData.entries()) {
        if (value) {
            params.set(key, value);
        }
    }
    
    const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
    window.history.replaceState({}, '', newUrl);
}

function resetSearchFilters() {
    const form = document.getElementById('search-form');
    if (!form) return;
    form.reset();
    document.getElementById('sort-by-input').value = 'updated_at';
    document.getElementById('sort-dir-input').value = 'desc';
    document.getElementById('limit').value = '100';
    
    // Clear saved state
    localStorage.removeItem(STORAGE_KEY);
    
    // Clear URL parameters
    window.history.replaceState({}, '', window.location.pathname);
    
    htmx.trigger(form, 'submit');
}

// Initialize: restore form state on page load
document.addEventListener('DOMContentLoaded', function() {
    restoreFormState();
    
    // Save form state when form is submitted
    const form = document.getElementById('search-form');
    if (form) {
        form.addEventListener('submit', function() {
            saveFormState();
            updateUrl();
        });
        
        // Also save on input changes (debounced)
        let saveTimeout;
        form.addEventListener('input', function() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                saveFormState();
                updateUrl();
            }, 500);
        });
        
        form.addEventListener('change', function() {
            saveFormState();
            updateUrl();
        });
        
        // Auto-submit if URL has query parameters
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.toString()) {
            // Small delay to ensure form is fully rendered
            setTimeout(() => {
                htmx.trigger(form, 'submit');
            }, 100);
        }
    }
    
    // Listen to HTMX events to save state
    document.body.addEventListener('htmx:beforeRequest', function(event) {
        const form = document.getElementById('search-form');
        if (form && event.detail.elt === form) {
            saveFormState();
            updateUrl();
        }
    });
    
    // Filter out empty form values before HTMX submission
    // This allows backend to use int/float types directly
    document.body.addEventListener('htmx:configRequest', function(event) {
        const form = document.getElementById('search-form');
        if (form && event.detail.elt === form) {
            // For GET requests, HTMX uses the form data to build query params
            // We need to filter out empty values
            const formData = new FormData(form);
            const cleanedParams = {};
            
            // Only include non-empty values
            for (const [key, value] of formData.entries()) {
                const trimmedValue = String(value).trim();
                // Skip empty strings, but keep "0" and "false" as valid values
                if (trimmedValue !== '' && trimmedValue !== null && trimmedValue !== undefined) {
                    cleanedParams[key] = trimmedValue;
                }
            }
            
            // Replace the request parameters with cleaned ones
            // HTMX will use these to build the query string for GET requests
            event.detail.parameters = cleanedParams;
        }
    });
});

document.addEventListener('click', function (event) {
    const button = event.target.closest('[data-sort]');
    if (!button) {
        return;
    }
    const field = button.getAttribute('data-sort');
    const sortByInput = document.getElementById('sort-by-input');
    const sortDirInput = document.getElementById('sort-dir-input');
    if (!sortByInput || !sortDirInput) {
        return;
    }
    if (sortByInput.value === field) {
        sortDirInput.value = sortDirInput.value === 'asc' ? 'desc' : 'asc';
    } else {
        sortByInput.value = field;
        sortDirInput.value = field === 'updated_at' ? 'desc' : 'asc';
    }
    
    // Save state before triggering submit
    saveFormState();
    updateUrl();
    htmx.trigger(document.getElementById('search-form'), 'submit');
});
</script>

{% endblock %}

